!function(e){return function(e,t){e.Base64=t()}(this,function(){var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",t={encode:function(t){var n,i,o,r,s,a,c,d="",l=0;do n=t.charCodeAt(l++),i=t.charCodeAt(l++),o=t.charCodeAt(l++),r=n>>2,s=(3&n)<<4|i>>4,a=(15&i)<<2|o>>6,c=63&o,isNaN(i)?(s=(3&n)<<4,a=c=64):isNaN(o)&&(c=64),d=d+e.charAt(r)+e.charAt(s)+e.charAt(a)+e.charAt(c);while(l<t.length);return d},decode:function(t){var n,i,o,r,s,a,c,d="",l=0;t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");do r=e.indexOf(t.charAt(l++)),s=e.indexOf(t.charAt(l++)),a=e.indexOf(t.charAt(l++)),c=e.indexOf(t.charAt(l++)),n=r<<2|s>>4,i=(15&s)<<4|a>>2,o=(3&a)<<6|c,d+=String.fromCharCode(n),64!=a&&(d+=String.fromCharCode(i)),64!=c&&(d+=String.fromCharCode(o));while(l<t.length);return d}};return t}),function(e,t){e.SHA1=t()}(this,function(){function e(e,i){e[i>>5]|=128<<24-i%32,e[(i+64>>9<<4)+15]=i;var s,a,c,d,l,u,p,m,h=new Array(80),f=1732584193,g=-271733879,_=-1732584194,v=271733878,y=-1009589776;for(s=0;s<e.length;s+=16){for(d=f,l=g,u=_,p=v,m=y,a=0;80>a;a++)16>a?h[a]=e[s+a]:h[a]=r(h[a-3]^h[a-8]^h[a-14]^h[a-16],1),c=o(o(r(f,5),t(a,g,_,v)),o(o(y,h[a]),n(a))),y=v,v=_,_=r(g,30),g=f,f=c;f=o(f,d),g=o(g,l),_=o(_,u),v=o(v,p),y=o(y,m)}return[f,g,_,v,y]}function t(e,t,n,i){return 20>e?t&n|~t&i:40>e?t^n^i:60>e?t&n|t&i|n&i:t^n^i}function n(e){return 20>e?1518500249:40>e?1859775393:60>e?-1894007588:-899497514}function i(t,n){var i=s(t);i.length>16&&(i=e(i,8*t.length));for(var o=new Array(16),r=new Array(16),a=0;16>a;a++)o[a]=909522486^i[a],r[a]=1549556828^i[a];var c=e(o.concat(s(n)),512+8*n.length);return e(r.concat(c),672)}function o(e,t){var n=(65535&e)+(65535&t),i=(e>>16)+(t>>16)+(n>>16);return i<<16|65535&n}function r(e,t){return e<<t|e>>>32-t}function s(e){for(var t=[],n=255,i=0;i<8*e.length;i+=8)t[i>>5]|=(e.charCodeAt(i/8)&n)<<24-i%32;return t}function a(e){for(var t="",n=255,i=0;i<32*e.length;i+=8)t+=String.fromCharCode(e[i>>5]>>>24-i%32&n);return t}function c(e){for(var t,n,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",o="",r=0;r<4*e.length;r+=3)for(t=(e[r>>2]>>8*(3-r%4)&255)<<16|(e[r+1>>2]>>8*(3-(r+1)%4)&255)<<8|e[r+2>>2]>>8*(3-(r+2)%4)&255,n=0;4>n;n++)o+=8*r+6*n>32*e.length?"=":i.charAt(t>>6*(3-n)&63);return o}return{b64_hmac_sha1:function(e,t){return c(i(e,t))},b64_sha1:function(t){return c(e(s(t),8*t.length))},binb2str:a,core_hmac_sha1:i,str_hmac_sha1:function(e,t){return a(i(e,t))},str_sha1:function(t){return a(e(s(t),8*t.length))}}}),function(e,t){e.MD5=t()}(this,function(e){var t=function(e,t){var n=(65535&e)+(65535&t),i=(e>>16)+(t>>16)+(n>>16);return i<<16|65535&n},n=function(e,t){return e<<t|e>>>32-t},i=function(e){for(var t=[],n=0;n<8*e.length;n+=8)t[n>>5]|=(255&e.charCodeAt(n/8))<<n%32;return t},o=function(e){for(var t="",n=0;n<32*e.length;n+=8)t+=String.fromCharCode(e[n>>5]>>>n%32&255);return t},r=function(e){for(var t="0123456789abcdef",n="",i=0;i<4*e.length;i++)n+=t.charAt(e[i>>2]>>i%4*8+4&15)+t.charAt(e[i>>2]>>i%4*8&15);return n},s=function(e,i,o,r,s,a){return t(n(t(t(i,e),t(r,a)),s),o)},a=function(e,t,n,i,o,r,a){return s(t&n|~t&i,e,t,o,r,a)},c=function(e,t,n,i,o,r,a){return s(t&i|n&~i,e,t,o,r,a)},d=function(e,t,n,i,o,r,a){return s(t^n^i,e,t,o,r,a)},l=function(e,t,n,i,o,r,a){return s(n^(t|~i),e,t,o,r,a)},u=function(e,n){e[n>>5]|=128<<n%32,e[(n+64>>>9<<4)+14]=n;for(var i,o,r,s,u=1732584193,p=-271733879,m=-1732584194,h=271733878,f=0;f<e.length;f+=16)i=u,o=p,r=m,s=h,u=a(u,p,m,h,e[f+0],7,-680876936),h=a(h,u,p,m,e[f+1],12,-389564586),m=a(m,h,u,p,e[f+2],17,606105819),p=a(p,m,h,u,e[f+3],22,-1044525330),u=a(u,p,m,h,e[f+4],7,-176418897),h=a(h,u,p,m,e[f+5],12,1200080426),m=a(m,h,u,p,e[f+6],17,-1473231341),p=a(p,m,h,u,e[f+7],22,-45705983),u=a(u,p,m,h,e[f+8],7,1770035416),h=a(h,u,p,m,e[f+9],12,-1958414417),m=a(m,h,u,p,e[f+10],17,-42063),p=a(p,m,h,u,e[f+11],22,-1990404162),u=a(u,p,m,h,e[f+12],7,1804603682),h=a(h,u,p,m,e[f+13],12,-40341101),m=a(m,h,u,p,e[f+14],17,-1502002290),p=a(p,m,h,u,e[f+15],22,1236535329),u=c(u,p,m,h,e[f+1],5,-165796510),h=c(h,u,p,m,e[f+6],9,-1069501632),m=c(m,h,u,p,e[f+11],14,643717713),p=c(p,m,h,u,e[f+0],20,-373897302),u=c(u,p,m,h,e[f+5],5,-701558691),h=c(h,u,p,m,e[f+10],9,38016083),m=c(m,h,u,p,e[f+15],14,-660478335),p=c(p,m,h,u,e[f+4],20,-405537848),u=c(u,p,m,h,e[f+9],5,568446438),h=c(h,u,p,m,e[f+14],9,-1019803690),m=c(m,h,u,p,e[f+3],14,-187363961),p=c(p,m,h,u,e[f+8],20,1163531501),u=c(u,p,m,h,e[f+13],5,-1444681467),h=c(h,u,p,m,e[f+2],9,-51403784),m=c(m,h,u,p,e[f+7],14,1735328473),p=c(p,m,h,u,e[f+12],20,-1926607734),u=d(u,p,m,h,e[f+5],4,-378558),h=d(h,u,p,m,e[f+8],11,-2022574463),m=d(m,h,u,p,e[f+11],16,1839030562),p=d(p,m,h,u,e[f+14],23,-35309556),u=d(u,p,m,h,e[f+1],4,-1530992060),h=d(h,u,p,m,e[f+4],11,1272893353),m=d(m,h,u,p,e[f+7],16,-155497632),p=d(p,m,h,u,e[f+10],23,-1094730640),u=d(u,p,m,h,e[f+13],4,681279174),h=d(h,u,p,m,e[f+0],11,-358537222),m=d(m,h,u,p,e[f+3],16,-722521979),p=d(p,m,h,u,e[f+6],23,76029189),u=d(u,p,m,h,e[f+9],4,-640364487),h=d(h,u,p,m,e[f+12],11,-421815835),m=d(m,h,u,p,e[f+15],16,530742520),p=d(p,m,h,u,e[f+2],23,-995338651),u=l(u,p,m,h,e[f+0],6,-198630844),h=l(h,u,p,m,e[f+7],10,1126891415),m=l(m,h,u,p,e[f+14],15,-1416354905),p=l(p,m,h,u,e[f+5],21,-57434055),u=l(u,p,m,h,e[f+12],6,1700485571),h=l(h,u,p,m,e[f+3],10,-1894986606),m=l(m,h,u,p,e[f+10],15,-1051523),p=l(p,m,h,u,e[f+1],21,-2054922799),u=l(u,p,m,h,e[f+8],6,1873313359),h=l(h,u,p,m,e[f+15],10,-30611744),m=l(m,h,u,p,e[f+6],15,-1560198380),p=l(p,m,h,u,e[f+13],21,1309151649),u=l(u,p,m,h,e[f+4],6,-145523070),h=l(h,u,p,m,e[f+11],10,-1120210379),m=l(m,h,u,p,e[f+2],15,718787259),p=l(p,m,h,u,e[f+9],21,-343485551),u=t(u,i),p=t(p,o),m=t(m,r),h=t(h,s);return[u,p,m,h]},p={hexdigest:function(e){return r(u(i(e),8*e.length))},hash:function(e){return o(u(i(e),8*e.length))}};return p}),Function.prototype.stropheBind||(Function.prototype.stropheBind=function(e){var t=this,n=Array.prototype.slice,i=Array.prototype.concat,o=n.call(arguments,1);return function(){return t.apply(e?e:this,i.call(o,n.call(arguments,0)))}}),Array.isArray||(Array.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)}),Array.prototype.indexOf||(Array.prototype.indexOf=function(e){var t=this.length,n=Number(arguments[1])||0;for(n=0>n?Math.ceil(n):Math.floor(n),0>n&&(n+=t);t>n;n++)if(n in this&&this[n]===e)return n;return-1}),function(e,t){var n=t(e.SHA1,e.Base64,e.MD5);window.Strophe=n.Strophe,window.$build=n.$build,window.$iq=n.$iq,window.$msg=n.$msg,window.$pres=n.$pres,window.SHA1=n.SHA1,window.Base64=n.Base64,window.MD5=n.MD5,window.b64_hmac_sha1=n.SHA1.b64_hmac_sha1,window.b64_sha1=n.SHA1.b64_sha1,window.str_hmac_sha1=n.SHA1.str_hmac_sha1,window.str_sha1=n.SHA1.str_sha1}(this,function(e,t,n){function i(e,t){return new a.Builder(e,t)}function o(e){return new a.Builder("message",e)}function r(e){return new a.Builder("iq",e)}function s(e){return new a.Builder("presence",e)}var a;return a={VERSION:"1.2.2",NS:{HTTPBIND:"http://jabber.org/protocol/httpbind",BOSH:"urn:xmpp:xbosh",CLIENT:"jabber:client",AUTH:"jabber:iq:auth",ROSTER:"jabber:iq:roster",PROFILE:"jabber:iq:profile",DISCO_INFO:"http://jabber.org/protocol/disco#info",DISCO_ITEMS:"http://jabber.org/protocol/disco#items",MUC:"http://jabber.org/protocol/muc",SASL:"urn:ietf:params:xml:ns:xmpp-sasl",STREAM:"http://etherx.jabber.org/streams",FRAMING:"urn:ietf:params:xml:ns:xmpp-framing",BIND:"urn:ietf:params:xml:ns:xmpp-bind",SESSION:"urn:ietf:params:xml:ns:xmpp-session",VERSION:"jabber:iq:version",STANZAS:"urn:ietf:params:xml:ns:xmpp-stanzas",XHTML_IM:"http://jabber.org/protocol/xhtml-im",XHTML:"http://www.w3.org/1999/xhtml"},XHTML:{tags:["a","blockquote","br","cite","em","img","li","ol","p","span","strong","ul","body"],attributes:{a:["href"],blockquote:["style"],br:[],cite:["style"],em:[],img:["src","alt","style","height","width"],li:["style"],ol:["style"],p:["style"],span:["style"],strong:[],ul:["style"],body:[]},css:["background-color","color","font-family","font-size","font-style","font-weight","margin-left","margin-right","text-align","text-decoration"],validTag:function(e){for(var t=0;t<a.XHTML.tags.length;t++)if(e==a.XHTML.tags[t])return!0;return!1},validAttribute:function(e,t){if("undefined"!=typeof a.XHTML.attributes[e]&&a.XHTML.attributes[e].length>0)for(var n=0;n<a.XHTML.attributes[e].length;n++)if(t==a.XHTML.attributes[e][n])return!0;return!1},validCSS:function(e){for(var t=0;t<a.XHTML.css.length;t++)if(e==a.XHTML.css[t])return!0;return!1}},Status:{ERROR:0,CONNECTING:1,CONNFAIL:2,AUTHENTICATING:3,AUTHFAIL:4,CONNECTED:5,DISCONNECTED:6,DISCONNECTING:7,ATTACHED:8,REDIRECT:9},LogLevel:{DEBUG:0,INFO:1,WARN:2,ERROR:3,FATAL:4},ElementType:{NORMAL:1,TEXT:3,CDATA:4,FRAGMENT:11},TIMEOUT:1.1,SECONDARY_TIMEOUT:.1,addNamespace:function(e,t){a.NS[e]=t},forEachChild:function(e,t,n){var i,o;for(i=0;i<e.childNodes.length;i++)o=e.childNodes[i],o.nodeType!=a.ElementType.NORMAL||t&&!this.isTagEqual(o,t)||n(o)},isTagEqual:function(e,t){return e.tagName==t},_xmlGenerator:null,_makeGenerator:function(){var e;return void 0===document.implementation.createDocument||document.implementation.createDocument&&document.documentMode&&document.documentMode<10?(e=this._getIEXmlDom(),e.appendChild(e.createElement("strophe"))):e=document.implementation.createDocument("jabber:client","strophe",null),e},xmlGenerator:function(){return a._xmlGenerator||(a._xmlGenerator=a._makeGenerator()),a._xmlGenerator},_getIEXmlDom:function(){for(var e=null,t=["Msxml2.DOMDocument.6.0","Msxml2.DOMDocument.5.0","Msxml2.DOMDocument.4.0","MSXML2.DOMDocument.3.0","MSXML2.DOMDocument","MSXML.DOMDocument","Microsoft.XMLDOM"],n=0;n<t.length&&null===e;n++)try{e=new ActiveXObject(t[n])}catch(i){e=null}return e},xmlElement:function(e){if(!e)return null;var t,n,i,o=a.xmlGenerator().createElement(e);for(t=1;t<arguments.length;t++){var r=arguments[t];if(r)if("string"==typeof r||"number"==typeof r)o.appendChild(a.xmlTextNode(r));else if("object"==typeof r&&"function"==typeof r.sort)for(n=0;n<r.length;n++){var s=r[n];"object"==typeof s&&"function"==typeof s.sort&&void 0!==s[1]&&o.setAttribute(s[0],s[1])}else if("object"==typeof r)for(i in r)r.hasOwnProperty(i)&&void 0!==r[i]&&o.setAttribute(i,r[i])}return o},xmlescape:function(e){return e=e.replace(/\&/g,"&amp;"),e=e.replace(/</g,"&lt;"),e=e.replace(/>/g,"&gt;"),e=e.replace(/'/g,"&apos;"),e=e.replace(/"/g,"&quot;")},xmlunescape:function(e){return e=e.replace(/\&amp;/g,"&"),e=e.replace(/&lt;/g,"<"),e=e.replace(/&gt;/g,">"),e=e.replace(/&apos;/g,"'"),e=e.replace(/&quot;/g,'"')},xmlTextNode:function(e){return a.xmlGenerator().createTextNode(e)},xmlHtmlNode:function(e){var t;if(window.DOMParser){var n=new DOMParser;t=n.parseFromString(e,"text/xml")}else t=new ActiveXObject("Microsoft.XMLDOM"),t.async="false",t.loadXML(e);return t},getText:function(e){if(!e)return null;var t="";0===e.childNodes.length&&e.nodeType==a.ElementType.TEXT&&(t+=e.nodeValue);for(var n=0;n<e.childNodes.length;n++)e.childNodes[n].nodeType==a.ElementType.TEXT&&(t+=e.childNodes[n].nodeValue);return a.xmlescape(t)},copyElement:function(e){var t,n;if(e.nodeType==a.ElementType.NORMAL){for(n=a.xmlElement(e.tagName),t=0;t<e.attributes.length;t++)n.setAttribute(e.attributes[t].nodeName,e.attributes[t].value);for(t=0;t<e.childNodes.length;t++)n.appendChild(a.copyElement(e.childNodes[t]))}else e.nodeType==a.ElementType.TEXT&&(n=a.xmlGenerator().createTextNode(e.nodeValue));return n},createHtml:function(e){var t,n,i,o,r,s,c,d,l,u,p;if(e.nodeType==a.ElementType.NORMAL)if(o=e.nodeName.toLowerCase(),a.XHTML.validTag(o))try{for(n=a.xmlElement(o),t=0;t<a.XHTML.attributes[o].length;t++)if(r=a.XHTML.attributes[o][t],s=e.getAttribute(r),"undefined"!=typeof s&&null!==s&&""!==s&&s!==!1&&0!==s)if("style"==r&&"object"==typeof s&&"undefined"!=typeof s.cssText&&(s=s.cssText),"style"==r){for(c=[],d=s.split(";"),i=0;i<d.length;i++)l=d[i].split(":"),u=l[0].replace(/^\s*/,"").replace(/\s*$/,"").toLowerCase(),a.XHTML.validCSS(u)&&(p=l[1].replace(/^\s*/,"").replace(/\s*$/,""),c.push(u+": "+p));c.length>0&&(s=c.join("; "),n.setAttribute(r,s))}else n.setAttribute(r,s);for(t=0;t<e.childNodes.length;t++)n.appendChild(a.createHtml(e.childNodes[t]))}catch(m){n=a.xmlTextNode("")}else for(n=a.xmlGenerator().createDocumentFragment(),t=0;t<e.childNodes.length;t++)n.appendChild(a.createHtml(e.childNodes[t]));else if(e.nodeType==a.ElementType.FRAGMENT)for(n=a.xmlGenerator().createDocumentFragment(),t=0;t<e.childNodes.length;t++)n.appendChild(a.createHtml(e.childNodes[t]));else e.nodeType==a.ElementType.TEXT&&(n=a.xmlTextNode(e.nodeValue));return n},escapeNode:function(e){return"string"!=typeof e?e:e.replace(/^\s+|\s+$/g,"").replace(/\\/g,"\\5c").replace(/ /g,"\\20").replace(/\"/g,"\\22").replace(/\&/g,"\\26").replace(/\'/g,"\\27").replace(/\//g,"\\2f").replace(/:/g,"\\3a").replace(/</g,"\\3c").replace(/>/g,"\\3e").replace(/@/g,"\\40")},unescapeNode:function(e){return"string"!=typeof e?e:e.replace(/\\20/g," ").replace(/\\22/g,'"').replace(/\\26/g,"&").replace(/\\27/g,"'").replace(/\\2f/g,"/").replace(/\\3a/g,":").replace(/\\3c/g,"<").replace(/\\3e/g,">").replace(/\\40/g,"@").replace(/\\5c/g,"\\")},getNodeFromJid:function(e){return e.indexOf("@")<0?null:e.split("@")[0]},getDomainFromJid:function(e){var t=a.getBareJidFromJid(e);if(t.indexOf("@")<0)return t;var n=t.split("@");return n.splice(0,1),n.join("@")},getResourceFromJid:function(e){var t=e.split("/");return t.length<2?null:(t.splice(0,1),t.join("/"))},getBareJidFromJid:function(e){return e?e.split("/")[0]:null},log:function(e,t){},debug:function(e){this.log(this.LogLevel.DEBUG,e)},info:function(e){this.log(this.LogLevel.INFO,e)},warn:function(e){this.log(this.LogLevel.WARN,e)},error:function(e){this.log(this.LogLevel.ERROR,e)},fatal:function(e){this.log(this.LogLevel.FATAL,e)},serialize:function(e){var t;if(!e)return null;"function"==typeof e.tree&&(e=e.tree());var n,i,o=e.nodeName;for(e.getAttribute("_realname")&&(o=e.getAttribute("_realname")),t="<"+o,n=0;n<e.attributes.length;n++)"_realname"!=e.attributes[n].nodeName&&(t+=" "+e.attributes[n].nodeName+"='"+e.attributes[n].value.replace(/&/g,"&amp;").replace(/\'/g,"&apos;").replace(/>/g,"&gt;").replace(/</g,"&lt;")+"'");if(e.childNodes.length>0){for(t+=">",n=0;n<e.childNodes.length;n++)switch(i=e.childNodes[n],i.nodeType){case a.ElementType.NORMAL:t+=a.serialize(i);break;case a.ElementType.TEXT:t+=a.xmlescape(i.nodeValue);break;case a.ElementType.CDATA:t+="<![CDATA["+i.nodeValue+"]]>"}t+="</"+o+">"}else t+="/>";return t},_requestId:0,_connectionPlugins:{},addConnectionPlugin:function(e,t){a._connectionPlugins[e]=t}},a.Builder=function(e,t){("presence"==e||"message"==e||"iq"==e)&&(t&&!t.xmlns?t.xmlns=a.NS.CLIENT:t||(t={xmlns:a.NS.CLIENT})),this.nodeTree=a.xmlElement(e,t),this.node=this.nodeTree},a.Builder.prototype={tree:function(){return this.nodeTree},toString:function(){return a.serialize(this.nodeTree)},up:function(){return this.node=this.node.parentNode,this},attrs:function(e){for(var t in e)e.hasOwnProperty(t)&&(void 0===e[t]?this.node.removeAttribute(t):this.node.setAttribute(t,e[t]));return this},c:function(e,t,n){var i=a.xmlElement(e,t,n);return this.node.appendChild(i),"string"!=typeof n&&(this.node=i),this},cnode:function(e){var t,n=a.xmlGenerator();try{t=void 0!==n.importNode}catch(i){t=!1}var o=t?n.importNode(e,!0):a.copyElement(e);return this.node.appendChild(o),this.node=o,this},t:function(e){var t=a.xmlTextNode(e);return this.node.appendChild(t),this},h:function(e){var t=document.createElement("body");t.innerHTML=e;for(var n=a.createHtml(t);n.childNodes.length>0;)this.node.appendChild(n.childNodes[0]);return this}},a.Handler=function(e,t,n,i,o,r,s){this.handler=e,this.ns=t,this.name=n,this.type=i,this.id=o,this.options=s||{matchBare:!1},this.options.matchBare||(this.options.matchBare=!1),this.options.matchBare?this.from=r?a.getBareJidFromJid(r):null:this.from=r,this.user=!0},a.Handler.prototype={isMatch:function(e){var t,n=null;if(n=this.options.matchBare?a.getBareJidFromJid(e.getAttribute("from")):e.getAttribute("from"),t=!1,this.ns){var i=this;a.forEachChild(e,null,function(e){e.getAttribute("xmlns")==i.ns&&(t=!0)}),t=t||e.getAttribute("xmlns")==this.ns}else t=!0;var o=e.getAttribute("type");return!t||this.name&&!a.isTagEqual(e,this.name)||this.type&&(Array.isArray(this.type)?-1==this.type.indexOf(o):o!=this.type)||this.id&&e.getAttribute("id")!=this.id||this.from&&n!=this.from?!1:!0},run:function(e){var t=null;try{t=this.handler(e)}catch(n){throw n.sourceURL?a.fatal("error: "+this.handler+" "+n.sourceURL+":"+n.line+" - "+n.name+": "+n.message):n.fileName?("undefined"!=typeof console&&(console.trace(),console.error(this.handler," - error - ",n,n.message)),a.fatal("error: "+this.handler+" "+n.fileName+":"+n.lineNumber+" - "+n.name+": "+n.message)):a.fatal("error: "+n.message+"\n"+n.stack),n}return t},toString:function(){return"{Handler: "+this.handler+"("+this.name+","+this.id+","+this.ns+")}"}},a.TimedHandler=function(e,t){this.period=e,this.handler=t,this.lastCalled=(new Date).getTime(),this.user=!0},a.TimedHandler.prototype={run:function(){return this.lastCalled=(new Date).getTime(),this.handler()},reset:function(){this.lastCalled=(new Date).getTime()},toString:function(){return"{TimedHandler: "+this.handler+"("+this.period+")}"}},a.Connection=function(e,t){this.service=e,this.options=t||{};var n=this.options.protocol||"";0===e.indexOf("ws:")||0===e.indexOf("wss:")||0===n.indexOf("ws")?this._proto=new a.Websocket(this):this._proto=new a.Bosh(this),this.jid="",this.domain=null,this.features=null,this._sasl_data={},this.do_session=!1,this.do_bind=!1,this.timedHandlers=[],this.handlers=[],this.removeTimeds=[],this.removeHandlers=[],this.addTimeds=[],this.addHandlers=[],this._authentication={},this._idleTimeout=null,this._disconnectTimeout=null,this.authenticated=!1,this.connected=!1,this.disconnecting=!1,this.do_authentication=!0,this.paused=!1,this.restored=!1,this._data=[],this._uniqueId=0,this._sasl_success_handler=null,this._sasl_failure_handler=null,this._sasl_challenge_handler=null,this.maxRetries=5,this._idleTimeout=setTimeout(this._onIdle.stropheBind(this),100);for(var i in a._connectionPlugins)if(a._connectionPlugins.hasOwnProperty(i)){var o=a._connectionPlugins[i],r=function(){};r.prototype=o,this[i]=new r,this[i].init(this)}},a.Connection.prototype={reset:function(){this._proto._reset(),this.do_session=!1,this.do_bind=!1,this.timedHandlers=[],this.handlers=[],this.removeTimeds=[],this.removeHandlers=[],this.addTimeds=[],this.addHandlers=[],this._authentication={},this.authenticated=!1,this.connected=!1,this.disconnecting=!1,this.restored=!1,this._data=[],this._requests=[],this._uniqueId=0},pause:function(){this.paused=!0},resume:function(){this.paused=!1},getUniqueId:function(e){return"string"==typeof e||"number"==typeof e?++this._uniqueId+":"+e:++this._uniqueId+""},connect:function(e,t,n,i,o,r,s){this.jid=e,this.authzid=a.getBareJidFromJid(this.jid),this.authcid=s||a.getNodeFromJid(this.jid),this.pass=t,this.servtype="xmpp",this.connect_callback=n,this.disconnecting=!1,this.connected=!1,this.authenticated=!1,this.restored=!1,this.domain=a.getDomainFromJid(this.jid),this._changeConnectStatus(a.Status.CONNECTING,null),this._proto._connect(i,o,r)},attach:function(e,t,n,i,o,r,s){if(!(this._proto instanceof a.Bosh))throw{name:"StropheSessionError",message:'The "attach" method can only be used with a BOSH connection.'};this._proto._attach(e,t,n,i,o,r,s)},restore:function(e,t,n,i,o){if(!this._sessionCachingSupported())throw{name:"StropheSessionError",message:'The "restore" method can only be used with a BOSH connection.'};this._proto._restore(e,t,n,i,o)},_sessionCachingSupported:function(){if(this._proto instanceof a.Bosh){if(!JSON)return!1;try{window.sessionStorage.setItem("_strophe_","_strophe_"),window.sessionStorage.removeItem("_strophe_")}catch(e){return!1}return!0}return!1},xmlInput:function(e){},xmlOutput:function(e){},rawInput:function(e){},rawOutput:function(e){},send:function(e){if(null!==e){if("function"==typeof e.sort)for(var t=0;t<e.length;t++)this._queueData(e[t]);else"function"==typeof e.tree?this._queueData(e.tree()):this._queueData(e);this._proto._send()}},flush:function(){clearTimeout(this._idleTimeout),this._onIdle()},sendIQ:function(e,t,n,i){var o=null,r=this;"function"==typeof e.tree&&(e=e.tree());var s=e.getAttribute("id");s||(s=this.getUniqueId("sendIQ"),e.setAttribute("id",s));var c=e.getAttribute("to"),d=this.jid,l=this.addHandler(function(e){o&&r.deleteTimedHandler(o);var i=!1,s=e.getAttribute("from");if((s===c||null===c&&(s===a.getBareJidFromJid(d)||s===a.getDomainFromJid(d)||s===d))&&(i=!0),!i)throw{name:"StropheError",message:"Got answer to IQ from wrong jid:"+s+"\nExpected jid: "+c};var l=e.getAttribute("type");if("result"==l)t&&t(e);else{if("error"!=l)throw{name:"StropheError",message:"Got bad IQ type of "+l};n&&n(e)}},null,"iq",["error","result"],s);return i&&(o=this.addTimedHandler(i,function(){return r.deleteHandler(l),n&&n(null),!1})),this.send(e),s},_queueData:function(e){if(null===e||!e.tagName||!e.childNodes)throw{name:"StropheError",message:"Cannot queue non-DOMElement."};this._data.push(e)},_sendRestart:function(){this._data.push("restart"),this._proto._sendRestart(),this._idleTimeout=setTimeout(this._onIdle.stropheBind(this),100)},addTimedHandler:function(e,t){var n=new a.TimedHandler(e,t);return this.addTimeds.push(n),n},deleteTimedHandler:function(e){this.removeTimeds.push(e)},addHandler:function(e,t,n,i,o,r,s){var c=new a.Handler(e,t,n,i,o,r,s);return this.addHandlers.push(c),c},deleteHandler:function(e){this.removeHandlers.push(e);var t=this.addHandlers.indexOf(e);t>=0&&this.addHandlers.splice(t,1)},disconnect:function(e){if(this._changeConnectStatus(a.Status.DISCONNECTING,e),a.info("Disconnect was called because: "+e),this.connected){var t=!1;this.disconnecting=!0,this.authenticated&&(t=s({xmlns:a.NS.CLIENT,type:"unavailable"})),this._disconnectTimeout=this._addSysTimedHandler(3e3,this._onDisconnectTimeout.stropheBind(this)),this._proto._disconnect(t)}else a.info("Disconnect was called before Strophe connected to the server"),this._proto._abortAllRequests()},_changeConnectStatus:function(e,t){for(var n in a._connectionPlugins)if(a._connectionPlugins.hasOwnProperty(n)){var i=this[n];if(i.statusChanged)try{i.statusChanged(e,t)}catch(o){a.error(""+n+" plugin caused an exception changing status: "+o)}}if(this.connect_callback)try{this.connect_callback(e,t)}catch(r){a.error("User connection callback caused an exception: "+r)}},_doDisconnect:function(e){"number"==typeof this._idleTimeout&&clearTimeout(this._idleTimeout),null!==this._disconnectTimeout&&(this.deleteTimedHandler(this._disconnectTimeout),this._disconnectTimeout=null),a.info("_doDisconnect was called"),this._proto._doDisconnect(),this.authenticated=!1,this.disconnecting=!1,this.restored=!1,this.handlers=[],this.timedHandlers=[],this.removeTimeds=[],this.removeHandlers=[],this.addTimeds=[],this.addHandlers=[],this._changeConnectStatus(a.Status.DISCONNECTED,e),this.connected=!1},_dataRecv:function(e,t){a.info("_dataRecv called");var n=this._proto._reqToData(e);if(null!==n){this.xmlInput!==a.Connection.prototype.xmlInput&&(n.nodeName===this._proto.strip&&n.childNodes.length?this.xmlInput(n.childNodes[0]):this.xmlInput(n)),this.rawInput!==a.Connection.prototype.rawInput&&(t?this.rawInput(t):this.rawInput(a.serialize(n)));for(var i,o;this.removeHandlers.length>0;)o=this.removeHandlers.pop(),i=this.handlers.indexOf(o),i>=0&&this.handlers.splice(i,1);for(;this.addHandlers.length>0;)this.handlers.push(this.addHandlers.pop());if(this.disconnecting&&this._proto._emptyQueue())return void this._doDisconnect();var r,s,c=n.getAttribute("type");if(null!==c&&"terminate"==c){if(this.disconnecting)return;return r=n.getAttribute("condition"),s=n.getElementsByTagName("conflict"),null!==r?("remote-stream-error"==r&&s.length>0&&(r="conflict"),this._changeConnectStatus(a.Status.CONNFAIL,r)):this._changeConnectStatus(a.Status.CONNFAIL,"unknown"),void this._doDisconnect(r)}var d=this;a.forEachChild(n,null,function(e){var t,n;for(n=d.handlers,d.handlers=[],t=0;t<n.length;t++){var i=n[t];try{!i.isMatch(e)||!d.authenticated&&i.user?d.handlers.push(i):i.run(e)&&d.handlers.push(i)}catch(o){a.warn("Removing Strophe handlers due to uncaught exception: "+o.message)}}})}},mechanisms:{},_connect_cb:function(e,t,n){a.info("_connect_cb was called"),this.connected=!0;var i=this._proto._reqToData(e);if(i){this.xmlInput!==a.Connection.prototype.xmlInput&&(i.nodeName===this._proto.strip&&i.childNodes.length?this.xmlInput(i.childNodes[0]):this.xmlInput(i)),this.rawInput!==a.Connection.prototype.rawInput&&(n?this.rawInput(n):this.rawInput(a.serialize(i)));var o=this._proto._connect_cb(i);if(o!==a.Status.CONNFAIL){this._authentication.sasl_scram_sha1=!1,this._authentication.sasl_plain=!1,this._authentication.sasl_digest_md5=!1,this._authentication.sasl_anonymous=!1,this._authentication.legacy_auth=!1;var r;r=i.getElementsByTagNameNS?i.getElementsByTagNameNS(a.NS.STREAM,"features").length>0:i.getElementsByTagName("stream:features").length>0||i.getElementsByTagName("features").length>0;var s,c,d=i.getElementsByTagName("mechanism"),l=[],u=!1;if(!r)return void this._proto._no_auth_received(t);if(d.length>0)for(s=0;s<d.length;s++)c=a.getText(d[s]),this.mechanisms[c]&&l.push(this.mechanisms[c]);return this._authentication.legacy_auth=i.getElementsByTagName("auth").length>0,(u=this._authentication.legacy_auth||l.length>0)?void(this.do_authentication!==!1&&this.authenticate(l)):void this._proto._no_auth_received(t)}}},authenticate:function(e){var n;for(n=0;n<e.length-1;++n){for(var o=n,s=n+1;s<e.length;++s)e[s].prototype.priority>e[o].prototype.priority&&(o=s);if(o!=n){var c=e[n];e[n]=e[o],e[o]=c}}var d=!1;for(n=0;n<e.length;++n)if(e[n].test(this)){this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.stropheBind(this),null,"success",null,null),this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.stropheBind(this),null,"failure",null,null),this._sasl_challenge_handler=this._addSysHandler(this._sasl_challenge_cb.stropheBind(this),null,"challenge",null,null),this._sasl_mechanism=new e[n],this._sasl_mechanism.onStart(this);var l=i("auth",{xmlns:a.NS.SASL,mechanism:this._sasl_mechanism.name});if(this._sasl_mechanism.isClientFirst){var u=this._sasl_mechanism.onChallenge(this,null);l.t(t.encode(u))}this.send(l.tree()),d=!0;break}d||(null===a.getNodeFromJid(this.jid)?(this._changeConnectStatus(a.Status.CONNFAIL,"x-strophe-bad-non-anon-jid"),this.disconnect("x-strophe-bad-non-anon-jid")):(this._changeConnectStatus(a.Status.AUTHENTICATING,null),this._addSysHandler(this._auth1_cb.stropheBind(this),null,null,null,"_auth_1"),this.send(r({type:"get",to:this.domain,id:"_auth_1"}).c("query",{xmlns:a.NS.AUTH}).c("username",{}).t(a.getNodeFromJid(this.jid)).tree())))},_sasl_challenge_cb:function(e){var n=t.decode(a.getText(e)),o=this._sasl_mechanism.onChallenge(this,n),r=i("response",{xmlns:a.NS.SASL});return""!==o&&r.t(t.encode(o)),this.send(r.tree()),!0},_auth1_cb:function(e){var t=r({type:"set",id:"_auth_2"}).c("query",{xmlns:a.NS.AUTH}).c("username",{}).t(a.getNodeFromJid(this.jid)).up().c("password").t(this.pass);return a.getResourceFromJid(this.jid)||(this.jid=a.getBareJidFromJid(this.jid)+"/strophe"),t.up().c("resource",{}).t(a.getResourceFromJid(this.jid)),this._addSysHandler(this._auth2_cb.stropheBind(this),null,null,null,"_auth_2"),this.send(t.tree()),!1},_sasl_success_cb:function(e){if(this._sasl_data["server-signature"]){var n,i=t.decode(a.getText(e)),o=/([a-z]+)=([^,]+)(,|$)/,r=i.match(o);if("v"==r[1]&&(n=r[2]),n!=this._sasl_data["server-signature"])return this.deleteHandler(this._sasl_failure_handler),this._sasl_failure_handler=null,this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null),this._sasl_data={},this._sasl_failure_cb(null)}a.info("SASL authentication succeeded."),this._sasl_mechanism&&this._sasl_mechanism.onSuccess(),this.deleteHandler(this._sasl_failure_handler),this._sasl_failure_handler=null,this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null);var s=[],c=function(e,t){for(;e.length;)this.deleteHandler(e.pop());return this._sasl_auth1_cb.stropheBind(this)(t),!1};return s.push(this._addSysHandler(function(e){c.stropheBind(this)(s,e)}.stropheBind(this),null,"stream:features",null,null)),s.push(this._addSysHandler(function(e){c.stropheBind(this)(s,e)}.stropheBind(this),a.NS.STREAM,"features",null,null)),this._sendRestart(),!1},_sasl_auth1_cb:function(e){this.features=e;var t,n;for(t=0;t<e.childNodes.length;t++)n=e.childNodes[t],"bind"==n.nodeName&&(this.do_bind=!0),"session"==n.nodeName&&(this.do_session=!0);if(!this.do_bind)return this._changeConnectStatus(a.Status.AUTHFAIL,null),!1;this._addSysHandler(this._sasl_bind_cb.stropheBind(this),null,null,null,"_bind_auth_2");var i=a.getResourceFromJid(this.jid);return i?this.send(r({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:a.NS.BIND}).c("resource",{}).t(i).tree()):this.send(r({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:a.NS.BIND}).tree()),!1},_sasl_bind_cb:function(e){if("error"==e.getAttribute("type")){a.info("SASL binding failed.");var t,n=e.getElementsByTagName("conflict");return n.length>0&&(t="conflict"),this._changeConnectStatus(a.Status.AUTHFAIL,t),!1}var i,o=e.getElementsByTagName("bind");return o.length>0?(i=o[0].getElementsByTagName("jid"),void(i.length>0&&(this.jid=a.getText(i[0]),this.do_session?(this._addSysHandler(this._sasl_session_cb.stropheBind(this),null,null,null,"_session_auth_2"),this.send(r({type:"set",id:"_session_auth_2"}).c("session",{xmlns:a.NS.SESSION}).tree())):(this.authenticated=!0,this._changeConnectStatus(a.Status.CONNECTED,null))))):(a.info("SASL binding failed."),this._changeConnectStatus(a.Status.AUTHFAIL,null),!1)},_sasl_session_cb:function(e){if("result"==e.getAttribute("type"))this.authenticated=!0,this._changeConnectStatus(a.Status.CONNECTED,null);else if("error"==e.getAttribute("type"))return a.info("Session creation failed."),this._changeConnectStatus(a.Status.AUTHFAIL,null),!1;return!1},_sasl_failure_cb:function(e){return this._sasl_success_handler&&(this.deleteHandler(this._sasl_success_handler),this._sasl_success_handler=null),this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null),this._sasl_mechanism&&this._sasl_mechanism.onFailure(),this._changeConnectStatus(a.Status.AUTHFAIL,null),!1},_auth2_cb:function(e){return"result"==e.getAttribute("type")?(this.authenticated=!0,this._changeConnectStatus(a.Status.CONNECTED,null)):"error"==e.getAttribute("type")&&(this._changeConnectStatus(a.Status.AUTHFAIL,null),this.disconnect("authentication failed")),!1},_addSysTimedHandler:function(e,t){var n=new a.TimedHandler(e,t);return n.user=!1,this.addTimeds.push(n),n},_addSysHandler:function(e,t,n,i,o){var r=new a.Handler(e,t,n,i,o);return r.user=!1,this.addHandlers.push(r),r},_onDisconnectTimeout:function(){return a.info("_onDisconnectTimeout was called"),this._proto._onDisconnectTimeout(),this._doDisconnect(),!1},_onIdle:function(){for(var e,t,n,i;this.addTimeds.length>0;)this.timedHandlers.push(this.addTimeds.pop());for(;this.removeTimeds.length>0;)t=this.removeTimeds.pop(),e=this.timedHandlers.indexOf(t),e>=0&&this.timedHandlers.splice(e,1);var o=(new Date).getTime();for(i=[],e=0;e<this.timedHandlers.length;e++)t=this.timedHandlers[e],(this.authenticated||!t.user)&&(n=t.lastCalled+t.period,0>=n-o?t.run()&&i.push(t):i.push(t));this.timedHandlers=i,clearTimeout(this._idleTimeout),this._proto._onIdle(),this.connected&&(this._idleTimeout=setTimeout(this._onIdle.stropheBind(this),100))}},a.SASLMechanism=function(e,t,n){this.name=e,this.isClientFirst=t,this.priority=n},a.SASLMechanism.prototype={test:function(e){return!0},onStart:function(e){this._connection=e},onChallenge:function(e,t){throw new Error("You should implement challenge handling!")},
onFailure:function(){this._connection=null},onSuccess:function(){this._connection=null}},a.SASLAnonymous=function(){},a.SASLAnonymous.prototype=new a.SASLMechanism("ANONYMOUS",!1,10),a.SASLAnonymous.test=function(e){return null===e.authcid},a.Connection.prototype.mechanisms[a.SASLAnonymous.prototype.name]=a.SASLAnonymous,a.SASLPlain=function(){},a.SASLPlain.prototype=new a.SASLMechanism("PLAIN",!0,20),a.SASLPlain.test=function(e){return null!==e.authcid},a.SASLPlain.prototype.onChallenge=function(e){var t=e.authzid;return t+="\x00",t+=e.authcid,t+="\x00",t+=e.pass},a.Connection.prototype.mechanisms[a.SASLPlain.prototype.name]=a.SASLPlain,a.SASLSHA1=function(){},a.SASLSHA1.prototype=new a.SASLMechanism("SCRAM-SHA-1",!0,40),a.SASLSHA1.test=function(e){return null!==e.authcid},a.SASLSHA1.prototype.onChallenge=function(i,o,r){var s=r||n.hexdigest(1234567890*Math.random()),a="n="+i.authcid;return a+=",r=",a+=s,i._sasl_data.cnonce=s,i._sasl_data["client-first-message-bare"]=a,a="n,,"+a,this.onChallenge=function(n,i){for(var o,r,s,a,c,d,l,u,p,m,h,f="c=biws,",g=n._sasl_data["client-first-message-bare"]+","+i+",",_=n._sasl_data.cnonce,v=/([a-z]+)=([^,]+)(,|$)/;i.match(v);){var y=i.match(v);switch(i=i.replace(y[0],""),y[1]){case"r":o=y[2];break;case"s":r=y[2];break;case"i":s=y[2]}}if(o.substr(0,_.length)!==_)return n._sasl_data={},n._sasl_failure_cb();for(f+="r="+o,g+=f,r=t.decode(r),r+="\x00\x00\x00",a=d=e.core_hmac_sha1(n.pass,r),l=1;s>l;l++){for(c=e.core_hmac_sha1(n.pass,e.binb2str(d)),u=0;5>u;u++)a[u]^=c[u];d=c}for(a=e.binb2str(a),p=e.core_hmac_sha1(a,"Client Key"),m=e.str_hmac_sha1(a,"Server Key"),h=e.core_hmac_sha1(e.str_sha1(e.binb2str(p)),g),n._sasl_data["server-signature"]=e.b64_hmac_sha1(m,g),u=0;5>u;u++)p[u]^=h[u];return f+=",p="+t.encode(e.binb2str(p))}.stropheBind(this),a},a.Connection.prototype.mechanisms[a.SASLSHA1.prototype.name]=a.SASLSHA1,a.SASLMD5=function(){},a.SASLMD5.prototype=new a.SASLMechanism("DIGEST-MD5",!1,30),a.SASLMD5.test=function(e){return null!==e.authcid},a.SASLMD5.prototype._quote=function(e){return'"'+e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'},a.SASLMD5.prototype.onChallenge=function(e,t,i){for(var o,r=/([a-z]+)=("[^"]+"|[^,"]+)(?:,|$)/,s=i||n.hexdigest(""+1234567890*Math.random()),a="",c=null,d="",l="";t.match(r);)switch(o=t.match(r),t=t.replace(o[0],""),o[2]=o[2].replace(/^"(.+)"$/,"$1"),o[1]){case"realm":a=o[2];break;case"nonce":d=o[2];break;case"qop":l=o[2];break;case"host":c=o[2]}var u=e.servtype+"/"+e.domain;null!==c&&(u=u+"/"+c);var p=n.hash(e.authcid+":"+a+":"+this._connection.pass)+":"+d+":"+s,m="AUTHENTICATE:"+u,h="";return h+="charset=utf-8,",h+="username="+this._quote(e.authcid)+",",h+="realm="+this._quote(a)+",",h+="nonce="+this._quote(d)+",",h+="nc=00000001,",h+="cnonce="+this._quote(s)+",",h+="digest-uri="+this._quote(u)+",",h+="response="+n.hexdigest(n.hexdigest(p)+":"+d+":00000001:"+s+":auth:"+n.hexdigest(m))+",",h+="qop=auth",this.onChallenge=function(){return""}.stropheBind(this),h},a.Connection.prototype.mechanisms[a.SASLMD5.prototype.name]=a.SASLMD5,{Strophe:a,$build:i,$msg:o,$iq:r,$pres:s,SHA1:e,Base64:t,MD5:n}}),function(e,t){return t(Strophe,$build)}(this,function(e,t){return e.Request=function(t,n,i,o){this.id=++e._requestId,this.xmlData=t,this.data=e.serialize(t),this.origFunc=n,this.func=n,this.rid=i,this.date=NaN,this.sends=o||0,this.abort=!1,this.dead=null,this.age=function(){if(!this.date)return 0;var e=new Date;return(e-this.date)/1e3},this.timeDead=function(){if(!this.dead)return 0;var e=new Date;return(e-this.dead)/1e3},this.xhr=this._newXHR()},e.Request.prototype={getResponse:function(){var t=null;if(this.xhr.responseXML&&this.xhr.responseXML.documentElement){if(t=this.xhr.responseXML.documentElement,"parsererror"==t.tagName)throw e.error("invalid response received"),e.error("responseText: "+this.xhr.responseText),e.error("responseXML: "+e.serialize(this.xhr.responseXML)),"parsererror"}else this.xhr.responseText&&(e.error("invalid response received"),e.error("responseText: "+this.xhr.responseText),e.error("responseXML: "+e.serialize(this.xhr.responseXML)));return t},_newXHR:function(){var e=null;return window.XMLHttpRequest?(e=new XMLHttpRequest,e.overrideMimeType&&e.overrideMimeType("text/xml; charset=utf-8")):window.ActiveXObject&&(e=new ActiveXObject("Microsoft.XMLHTTP")),e.onreadystatechange=this.func.stropheBind(null,this),e}},e.Bosh=function(e){this._conn=e,this.rid=Math.floor(4294967295*Math.random()),this.sid=null,this.hold=1,this.wait=60,this.window=5,this.errors=0,this._requests=[]},e.Bosh.prototype={strip:null,_buildBody:function(){var n=t("body",{rid:this.rid++,xmlns:e.NS.HTTPBIND});return null!==this.sid&&n.attrs({sid:this.sid}),this._conn.options.keepalive&&this._cacheSession(),n},_reset:function(){this.rid=Math.floor(4294967295*Math.random()),this.sid=null,this.errors=0,window.sessionStorage.removeItem("strophe-bosh-session")},_connect:function(t,n,i){this.wait=t||this.wait,this.hold=n||this.hold,this.errors=0;var o=this._buildBody().attrs({to:this._conn.domain,"xml:lang":"en",wait:this.wait,hold:this.hold,content:"text/xml; charset=utf-8",ver:"1.6","xmpp:version":"1.0","xmlns:xmpp":e.NS.BOSH});i&&o.attrs({route:i});var r=this._conn._connect_cb;this._requests.push(new e.Request(o.tree(),this._onRequestStateChange.stropheBind(this,r.stropheBind(this._conn)),o.tree().getAttribute("rid"))),this._throttledRequestHandler()},_attach:function(t,n,i,o,r,s,a){this._conn.jid=t,this.sid=n,this.rid=i,this._conn.connect_callback=o,this._conn.domain=e.getDomainFromJid(this._conn.jid),this._conn.authenticated=!0,this._conn.connected=!0,this.wait=r||this.wait,this.hold=s||this.hold,this.window=a||this.window,this._conn._changeConnectStatus(e.Status.ATTACHED,null)},_restore:function(t,n,i,o,r){var s=JSON.parse(window.sessionStorage.getItem("strophe-bosh-session"));if(!("undefined"!=typeof s&&null!==s&&s.rid&&s.sid&&s.jid)||"undefined"!=typeof t&&e.getBareJidFromJid(s.jid)!=e.getBareJidFromJid(t))throw{name:"StropheSessionError",message:"_restore: no restoreable session."};this._conn.restored=!0,this._attach(s.jid,s.sid,s.rid,n,i,o,r)},_cacheSession:function(){this._conn.authenticated?this._conn.jid&&this.rid&&this.sid&&window.sessionStorage.setItem("strophe-bosh-session",JSON.stringify({jid:this._conn.jid,rid:this.rid,sid:this.sid})):window.sessionStorage.removeItem("strophe-bosh-session")},_connect_cb:function(t){var n,i,o=t.getAttribute("type");if(null!==o&&"terminate"==o)return n=t.getAttribute("condition"),e.error("BOSH-Connection failed: "+n),i=t.getElementsByTagName("conflict"),null!==n?("remote-stream-error"==n&&i.length>0&&(n="conflict"),this._conn._changeConnectStatus(e.Status.CONNFAIL,n)):this._conn._changeConnectStatus(e.Status.CONNFAIL,"unknown"),this._conn._doDisconnect(n),e.Status.CONNFAIL;this.sid||(this.sid=t.getAttribute("sid"));var r=t.getAttribute("requests");r&&(this.window=parseInt(r,10));var s=t.getAttribute("hold");s&&(this.hold=parseInt(s,10));var a=t.getAttribute("wait");a&&(this.wait=parseInt(a,10))},_disconnect:function(e){this._sendTerminate(e)},_doDisconnect:function(){this.sid=null,this.rid=Math.floor(4294967295*Math.random()),window.sessionStorage.removeItem("strophe-bosh-session")},_emptyQueue:function(){return 0===this._requests.length},_hitError:function(t){this.errors++,e.warn("request errored, status: "+t+", number of errors: "+this.errors),this.errors>4&&this._conn._onDisconnectTimeout()},_no_auth_received:function(t){t=t?t.stropheBind(this._conn):this._conn._connect_cb.stropheBind(this._conn);var n=this._buildBody();this._requests.push(new e.Request(n.tree(),this._onRequestStateChange.stropheBind(this,t.stropheBind(this._conn)),n.tree().getAttribute("rid"))),this._throttledRequestHandler()},_onDisconnectTimeout:function(){this._abortAllRequests()},_abortAllRequests:function(){for(var e;this._requests.length>0;)e=this._requests.pop(),e.abort=!0,e.xhr.abort(),e.xhr.onreadystatechange=function(){}},_onIdle:function(){var t=this._conn._data;if(this._conn.authenticated&&0===this._requests.length&&0===t.length&&!this._conn.disconnecting&&(e.info("no requests during idle cycle, sending blank request"),t.push(null)),!this._conn.paused){if(this._requests.length<2&&t.length>0){for(var n=this._buildBody(),i=0;i<t.length;i++)null!==t[i]&&("restart"===t[i]?n.attrs({to:this._conn.domain,"xml:lang":"en","xmpp:restart":"true","xmlns:xmpp":e.NS.BOSH}):n.cnode(t[i]).up());delete this._conn._data,this._conn._data=[],this._requests.push(new e.Request(n.tree(),this._onRequestStateChange.stropheBind(this,this._conn._dataRecv.stropheBind(this._conn)),n.tree().getAttribute("rid"))),this._throttledRequestHandler()}if(this._requests.length>0){var o=this._requests[0].age();null!==this._requests[0].dead&&this._requests[0].timeDead()>Math.floor(e.SECONDARY_TIMEOUT*this.wait)&&this._throttledRequestHandler(),o>Math.floor(e.TIMEOUT*this.wait)&&(e.warn("Request "+this._requests[0].id+" timed out, over "+Math.floor(e.TIMEOUT*this.wait)+" seconds since last activity"),this._throttledRequestHandler())}}},_onRequestStateChange:function(t,n){if(e.debug("request id "+n.id+"."+n.sends+" state changed to "+n.xhr.readyState),n.abort)return void(n.abort=!1);var i;if(4==n.xhr.readyState){i=0;try{i=n.xhr.status}catch(o){}if("undefined"==typeof i&&(i=0),this.disconnecting&&i>=400)return void this._hitError(i);var r=this._requests[0]==n,s=this._requests[1]==n;(i>0&&500>i||n.sends>5)&&(this._removeRequest(n),e.debug("request id "+n.id+" should now be removed")),200==i?((s||r&&this._requests.length>0&&this._requests[0].age()>Math.floor(e.SECONDARY_TIMEOUT*this.wait))&&this._restartRequest(0),e.debug("request id "+n.id+"."+n.sends+" got 200"),t(n),this.errors=0):(e.error("request id "+n.id+"."+n.sends+" error "+i+" happened"),(0===i||i>=400&&600>i||i>=12e3)&&(this._hitError(i),i>=400&&500>i&&(this._conn._changeConnectStatus(e.Status.DISCONNECTING,null),this._conn._doDisconnect()))),i>0&&500>i||n.sends>5||this._throttledRequestHandler()}},_processRequest:function(t){var n=this,i=this._requests[t],o=-1;try{4==i.xhr.readyState&&(o=i.xhr.status)}catch(r){e.error("caught an error in _requests["+t+"], reqStatus: "+o)}if("undefined"==typeof o&&(o=-1),i.sends>this._conn.maxRetries)return void this._conn._onDisconnectTimeout();var s=i.age(),a=!isNaN(s)&&s>Math.floor(e.TIMEOUT*this.wait),c=null!==i.dead&&i.timeDead()>Math.floor(e.SECONDARY_TIMEOUT*this.wait),d=4==i.xhr.readyState&&(1>o||o>=500);if((a||c||d)&&(c&&e.error("Request "+this._requests[t].id+" timed out (secondary), restarting"),i.abort=!0,i.xhr.abort(),i.xhr.onreadystatechange=function(){},this._requests[t]=new e.Request(i.xmlData,i.origFunc,i.rid,i.sends),i=this._requests[t]),0===i.xhr.readyState){e.debug("request id "+i.id+"."+i.sends+" posting");try{i.xhr.open("POST",this._conn.service,this._conn.options.sync?!1:!0),i.xhr.setRequestHeader&&i.xhr.setRequestHeader("Content-Type","text/xml; charset=utf-8")}catch(l){return e.error("XHR open failed."),this._conn.connected||this._conn._changeConnectStatus(e.Status.CONNFAIL,"bad-service"),void this._conn.disconnect()}var u=function(){if(i.date=new Date,n._conn.options.customHeaders){var e=n._conn.options.customHeaders;for(var t in e)e.hasOwnProperty(t)&&i.xhr.setRequestHeader(t,e[t])}i.xhr.send(i.data)};if(i.sends>1){var p=1e3*Math.min(Math.floor(e.TIMEOUT*this.wait),Math.pow(i.sends,3));setTimeout(u,p)}else u();i.sends++,this._conn.xmlOutput!==e.Connection.prototype.xmlOutput&&(i.xmlData.nodeName===this.strip&&i.xmlData.childNodes.length?this._conn.xmlOutput(i.xmlData.childNodes[0]):this._conn.xmlOutput(i.xmlData)),this._conn.rawOutput!==e.Connection.prototype.rawOutput&&this._conn.rawOutput(i.data)}else e.debug("_processRequest: "+(0===t?"first":"second")+" request has readyState of "+i.xhr.readyState)},_removeRequest:function(t){e.debug("removing request");var n;for(n=this._requests.length-1;n>=0;n--)t==this._requests[n]&&this._requests.splice(n,1);t.xhr.onreadystatechange=function(){},this._throttledRequestHandler()},_restartRequest:function(e){var t=this._requests[e];null===t.dead&&(t.dead=new Date),this._processRequest(e)},_reqToData:function(e){try{return e.getResponse()}catch(t){if("parsererror"!=t)throw t;this._conn.disconnect("strophe-parsererror")}},_sendTerminate:function(t){e.info("_sendTerminate was called");var n=this._buildBody().attrs({type:"terminate"});t&&n.cnode(t.tree());var i=new e.Request(n.tree(),this._onRequestStateChange.stropheBind(this,this._conn._dataRecv.stropheBind(this._conn)),n.tree().getAttribute("rid"));this._requests.push(i),this._throttledRequestHandler()},_send:function(){clearTimeout(this._conn._idleTimeout),this._throttledRequestHandler(),this._conn._idleTimeout=setTimeout(this._conn._onIdle.stropheBind(this._conn),100)},_sendRestart:function(){this._throttledRequestHandler(),clearTimeout(this._conn._idleTimeout)},_throttledRequestHandler:function(){this._requests?e.debug("_throttledRequestHandler called with "+this._requests.length+" requests"):e.debug("_throttledRequestHandler called with undefined requests"),this._requests&&0!==this._requests.length&&(this._requests.length>0&&this._processRequest(0),this._requests.length>1&&Math.abs(this._requests[0].rid-this._requests[1].rid)<this.window&&this._processRequest(1))}},e}),function(e,t){return t(Strophe,$build)}(this,function(e,t){return e.Websocket=function(e){this._conn=e,this.strip="wrapper";var t=e.service;if(0!==t.indexOf("ws:")&&0!==t.indexOf("wss:")){var n="";n+="ws"===e.options.protocol&&"https:"!==window.location.protocol?"ws":"wss",n+="://"+window.location.host,n+=0!==t.indexOf("/")?window.location.pathname+t:t,e.service=n}},e.Websocket.prototype={_buildStream:function(){return t("open",{xmlns:e.NS.FRAMING,to:this._conn.domain,version:"1.0"})},_check_streamerror:function(t,n){var i;if(i=t.getElementsByTagNameNS?t.getElementsByTagNameNS(e.NS.STREAM,"error"):t.getElementsByTagName("stream:error"),0===i.length)return!1;for(var o=i[0],r="",s="",a="urn:ietf:params:xml:ns:xmpp-streams",c=0;c<o.childNodes.length;c++){var d=o.childNodes[c];if(d.getAttribute("xmlns")!==a)break;"text"===d.nodeName?s=d.textContent:r=d.nodeName}var l="WebSocket stream error: ";return l+=r?r:"unknown",s&&(l+=" - "+r),e.error(l),this._conn._changeConnectStatus(n,r),this._conn._doDisconnect(),!0},_reset:function(){},_connect:function(){this._closeSocket(),this.socket=new WebSocket(this._conn.service,"xmpp"),this.socket.onopen=this._onOpen.stropheBind(this),this.socket.onerror=this._onError.stropheBind(this),this.socket.onclose=this._onClose.stropheBind(this),this.socket.onmessage=this._connect_cb_wrapper.stropheBind(this)},_connect_cb:function(t){var n=this._check_streamerror(t,e.Status.CONNFAIL);return n?e.Status.CONNFAIL:void 0},_handleStreamStart:function(t){var n=!1,i=t.getAttribute("xmlns");"string"!=typeof i?n="Missing xmlns in <open />":i!==e.NS.FRAMING&&(n="Wrong xmlns in <open />: "+i);var o=t.getAttribute("version");return"string"!=typeof o?n="Missing version in <open />":"1.0"!==o&&(n="Wrong version in <open />: "+o),n?(this._conn._changeConnectStatus(e.Status.CONNFAIL,n),this._conn._doDisconnect(),!1):!0},_connect_cb_wrapper:function(t){if(0===t.data.indexOf("<open ")||0===t.data.indexOf("<?xml")){var n=t.data.replace(/^(<\?.*?\?>\s*)*/,"");if(""===n)return;var i=(new DOMParser).parseFromString(n,"text/xml").documentElement;this._conn.xmlInput(i),this._conn.rawInput(t.data),this._handleStreamStart(i)&&this._connect_cb(i)}else if(0===t.data.indexOf("<close ")){this._conn.rawInput(t.data),this._conn.xmlInput(t);var o=t.getAttribute("see-other-uri");o?(this._conn._changeConnectStatus(e.Status.REDIRECT,"Received see-other-uri, resetting connection"),this._conn.reset(),this._conn.service=o,this._connect()):(this._conn._changeConnectStatus(e.Status.CONNFAIL,"Received closing stream"),this._conn._doDisconnect())}else{var r=this._streamWrap(t.data),s=(new DOMParser).parseFromString(r,"text/xml").documentElement;this.socket.onmessage=this._onMessage.stropheBind(this),this._conn._connect_cb(s,null,t.data)}},_disconnect:function(n){if(this.socket&&this.socket.readyState!==WebSocket.CLOSED){n&&this._conn.send(n);var i=t("close",{xmlns:e.NS.FRAMING});this._conn.xmlOutput(i);var o=e.serialize(i);this._conn.rawOutput(o);try{this.socket.send(o)}catch(r){e.info("Couldn't send <close /> tag.")}}this._conn._doDisconnect()},_doDisconnect:function(){e.info("WebSockets _doDisconnect was called"),this._closeSocket()},_streamWrap:function(e){return"<wrapper>"+e+"</wrapper>"},_closeSocket:function(){if(this.socket)try{this.socket.close()}catch(e){}this.socket=null},_emptyQueue:function(){return!0},_onClose:function(){this._conn.connected&&!this._conn.disconnecting?(e.error("Websocket closed unexcectedly"),this._conn._doDisconnect()):e.info("Websocket closed")},_no_auth_received:function(t){e.error("Server did not send any auth methods"),this._conn._changeConnectStatus(e.Status.CONNFAIL,"Server did not send any auth methods"),t&&(t=t.stropheBind(this._conn))(),this._conn._doDisconnect()},_onDisconnectTimeout:function(){},_abortAllRequests:function(){},_onError:function(t){e.error("Websocket error "+t),this._conn._changeConnectStatus(e.Status.CONNFAIL,"The WebSocket connection could not be established was disconnected."),this._disconnect()},_onIdle:function(){var t=this._conn._data;if(t.length>0&&!this._conn.paused){for(var n=0;n<t.length;n++)if(null!==t[n]){var i,o;i="restart"===t[n]?this._buildStream().tree():t[n],o=e.serialize(i),this._conn.xmlOutput(i),this._conn.rawOutput(o),this.socket.send(o)}this._conn._data=[]}},_onMessage:function(t){var n,i,o='<close xmlns="urn:ietf:params:xml:ns:xmpp-framing" />';if(t.data===o)return this._conn.rawInput(o),this._conn.xmlInput(t),void(this._conn.disconnecting||this._conn._doDisconnect());if(0===t.data.search("<open ")){if(n=(new DOMParser).parseFromString(t.data,"text/xml").documentElement,!this._handleStreamStart(n))return}else i=this._streamWrap(t.data),n=(new DOMParser).parseFromString(i,"text/xml").documentElement;return this._check_streamerror(n,e.Status.ERROR)?void 0:this._conn.disconnecting&&"presence"===n.firstChild.nodeName&&"unavailable"===n.firstChild.getAttribute("type")?(this._conn.xmlInput(n),void this._conn.rawInput(e.serialize(n))):void this._conn._dataRecv(n,t.data)},_onOpen:function(){e.info("Websocket open");var t=this._buildStream();this._conn.xmlOutput(t.tree());var n=e.serialize(t);this._conn.rawOutput(n),this.socket.send(n)},_reqToData:function(e){return e},_send:function(){this._conn.flush()},_sendRestart:function(){clearTimeout(this._conn._idleTimeout),this._conn._onIdle.stropheBind(this._conn)()}},e}),e?e(Strophe,$build,$msg,$iq,$pres):void 0}(function(e,t,n,i,o){window.Strophe=e,window.$build=t,window.$msg=n,window.$iq=i,window.$pres=o}),function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,t.adapter=e()}}(function(){return function e(t,n,i){function o(s,a){if(!n[s]){if(!t[s]){var c="function"==typeof require&&require;if(!a&&c)return c(s,!0);if(r)return r(s,!0);var d=new Error("Cannot find module '"+s+"'");throw d.code="MODULE_NOT_FOUND",d}var l=n[s]={exports:{}};t[s][0].call(l.exports,function(e){var n=t[s][1][e];return o(n?n:e)},l,l.exports,e,t,n,i)}return n[s].exports}for(var r="function"==typeof require&&require,s=0;s<i.length;s++)o(i[s]);return o}({1:[function(e,t,n){"use strict";var i={};i.generateIdentifier=function(){return Math.random().toString(36).substr(2,10)},i.localCName=i.generateIdentifier(),i.splitLines=function(e){return e.trim().split("\n").map(function(e){return e.trim()})},i.splitSections=function(e){var t=e.split("\nm=");return t.map(function(e,t){return(t>0?"m="+e:e).trim()+"\r\n"})},i.matchPrefix=function(e,t){return i.splitLines(e).filter(function(e){return 0===e.indexOf(t)})},i.parseCandidate=function(e){var t;t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" ");for(var n={foundation:t[0],component:t[1],protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],port:parseInt(t[5],10),type:t[7]},i=8;i<t.length;i+=2)switch(t[i]){case"raddr":n.relatedAddress=t[i+1];break;case"rport":n.relatedPort=parseInt(t[i+1],10);break;case"tcptype":n.tcpType=t[i+1]}return n},i.writeCandidate=function(e){var t=[];t.push(e.foundation),t.push(e.component),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.ip),t.push(e.port);var n=e.type;return t.push("typ"),t.push(n),"host"!==n&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),"candidate:"+t.join(" ")},i.parseRtpMap=function(e){var t=e.substr(9).split(" "),n={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),n.name=t[0],n.clockRate=parseInt(t[1],10),n.numChannels=3===t.length?parseInt(t[2],10):1,n},i.writeRtpMap=function(e){var t=e.payloadType;return void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType),"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==e.numChannels?"/"+e.numChannels:"")+"\r\n"},i.parseExtmap=function(e){var t=e.substr(9).split(" ");return{id:parseInt(t[0],10),uri:t[1]}},i.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+" "+e.uri+"\r\n"},i.parseFmtp=function(e){for(var t,n={},i=e.substr(e.indexOf(" ")+1).split(";"),o=0;o<i.length;o++)t=i[o].trim().split("="),n[t[0].trim()]=t[1];return n},i.writeFmtp=function(e){var t="",n=e.payloadType;if(void 0!==e.preferredPayloadType&&(n=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var i=[];Object.keys(e.parameters).forEach(function(t){i.push(t+"="+e.parameters[t])}),t+="a=fmtp:"+n+" "+i.join(";")+"\r\n"}return t},i.parseRtcpFb=function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},i.writeRtcpFb=function(e){var t="",n=e.payloadType;return void 0!==e.preferredPayloadType&&(n=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach(function(e){t+="a=rtcp-fb:"+n+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"}),t},i.parseSsrcMedia=function(e){var t=e.indexOf(" "),n={ssrc:parseInt(e.substr(7,t-7),10)},i=e.indexOf(":",t);return i>-1?(n.attribute=e.substr(t+1,i-t-1),n.value=e.substr(i+1)):n.attribute=e.substr(t+1),n},i.getDtlsParameters=function(e,t){var n=i.splitLines(e);n=n.concat(i.splitLines(t));var o=n.filter(function(e){return 0===e.indexOf("a=fingerprint:")})[0].substr(14),r={role:"auto",fingerprints:[{algorithm:o.split(" ")[0],value:o.split(" ")[1]}]};return r},i.writeDtlsParameters=function(e,t){var n="a=setup:"+t+"\r\n";return e.fingerprints.forEach(function(e){n+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"}),n},i.getIceParameters=function(e,t){var n=i.splitLines(e);n=n.concat(i.splitLines(t));var o={usernameFragment:n.filter(function(e){return 0===e.indexOf("a=ice-ufrag:")})[0].substr(12),password:n.filter(function(e){return 0===e.indexOf("a=ice-pwd:")})[0].substr(10)};return o},i.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n"},i.parseRtpParameters=function(e){for(var t={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},n=i.splitLines(e),o=n[0].split(" "),r=3;r<o.length;r++){var s=o[r],a=i.matchPrefix(e,"a=rtpmap:"+s+" ")[0];if(a){var c=i.parseRtpMap(a),d=i.matchPrefix(e,"a=fmtp:"+s+" ");switch(c.parameters=d.length?i.parseFmtp(d[0]):{},c.rtcpFeedback=i.matchPrefix(e,"a=rtcp-fb:"+s+" ").map(i.parseRtcpFb),t.codecs.push(c),c.name.toUpperCase()){case"RED":case"ULPFEC":t.fecMechanisms.push(c.name.toUpperCase())}}}return i.matchPrefix(e,"a=extmap:").forEach(function(e){t.headerExtensions.push(i.parseExtmap(e))}),t},i.writeRtpDescription=function(e,t){var n="";return n+="m="+e+" ",n+=t.codecs.length>0?"9":"0",n+=" UDP/TLS/RTP/SAVPF ",n+=t.codecs.map(function(e){return void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType}).join(" ")+"\r\n",n+="c=IN IP4 0.0.0.0\r\n",n+="a=rtcp:9 IN IP4 0.0.0.0\r\n",t.codecs.forEach(function(e){n+=i.writeRtpMap(e),n+=i.writeFmtp(e),n+=i.writeRtcpFb(e)}),n+="a=rtcp-mux\r\n"},i.parseRtpEncodingParameters=function(e){var t,n=[],o=i.parseRtpParameters(e),r=-1!==o.fecMechanisms.indexOf("RED"),s=-1!==o.fecMechanisms.indexOf("ULPFEC"),a=i.matchPrefix(e,"a=ssrc:").map(function(e){return i.parseSsrcMedia(e)}).filter(function(e){return"cname"===e.attribute}),c=a.length>0&&a[0].ssrc,d=i.matchPrefix(e,"a=ssrc-group:FID").map(function(e){var t=e.split(" ");return t.shift(),t.map(function(e){return parseInt(e,10)})});d.length>0&&d[0].length>1&&d[0][0]===c&&(t=d[0][1]),o.codecs.forEach(function(e){if("RTX"===e.name.toUpperCase()&&e.parameters.apt){var i={ssrc:c,codecPayloadType:parseInt(e.parameters.apt,10),rtx:{payloadType:e.payloadType,ssrc:t}};n.push(i),r&&(i=JSON.parse(JSON.stringify(i)),i.fec={ssrc:t,mechanism:s?"red+ulpfec":"red"},n.push(i))}}),0===n.length&&c&&n.push({ssrc:c});var l=i.matchPrefix(e,"b=");return l.length&&(0===l[0].indexOf("b=TIAS:")?l=parseInt(l[0].substr(7),10):0===l[0].indexOf("b=AS:")&&(l=parseInt(l[0].substr(5),10)),n.forEach(function(e){e.maxBitrate=l})),n},i.writeSessionBoilerplate=function(){return"v=0\r\no=thisisadapterortc 8169639915646943137 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},i.writeMediaSection=function(e,t,n,o){var r=i.writeRtpDescription(e.kind,t);if(r+=i.writeIceParameters(e.iceGatherer.getLocalParameters()),r+=i.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===n?"actpass":"active"),r+="a=mid:"+e.mid+"\r\n",r+=e.rtpSender&&e.rtpReceiver?"a=sendrecv\r\n":e.rtpSender?"a=sendonly\r\n":e.rtpReceiver?"a=recvonly\r\n":"a=inactive\r\n",e.rtpSender){var s="msid:"+o.id+" "+e.rtpSender.track.id+"\r\n";r+="a="+s,r+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+s}return r+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+i.localCName+"\r\n"},i.getDirection=function(e,t){for(var n=i.splitLines(e),o=0;o<n.length;o++)switch(n[o]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return n[o].substr(2)}return t?i.getDirection(t):"sendrecv"},t.exports=i},{}],2:[function(e,t,n){"use strict";!function(){var n=e("./utils").log,i=e("./utils").browserDetails;t.exports.browserDetails=i,t.exports.extractVersion=e("./utils").extractVersion,t.exports.disableLog=e("./utils").disableLog;var o=e("./chrome/chrome_shim")||null,r=e("./edge/edge_shim")||null,s=e("./firefox/firefox_shim")||null,a=e("./safari/safari_shim")||null;switch(i.browser){case"opera":case"chrome":if(!o||!o.shimPeerConnection)return void n("Chrome shim is not included in this adapter release.");n("adapter.js shimming chrome."),t.exports.browserShim=o,o.shimGetUserMedia(),o.shimMediaStream(),o.shimSourceObject(),o.shimPeerConnection(),o.shimOnTrack();break;case"firefox":if(!s||!s.shimPeerConnection)return void n("Firefox shim is not included in this adapter release.");n("adapter.js shimming firefox."),t.exports.browserShim=s,s.shimGetUserMedia(),s.shimSourceObject(),s.shimPeerConnection(),s.shimOnTrack();break;case"edge":if(!r||!r.shimPeerConnection)return void n("MS edge shim is not included in this adapter release.");n("adapter.js shimming edge."),t.exports.browserShim=r,r.shimGetUserMedia(),r.shimPeerConnection();break;case"safari":if(!a)return void n("Safari shim is not included in this adapter release.");n("adapter.js shimming safari."),t.exports.browserShim=a,a.shimGetUserMedia();break;default:n("Unsupported browser!")}}()},{"./chrome/chrome_shim":3,"./edge/edge_shim":5,"./firefox/firefox_shim":7,"./safari/safari_shim":9,"./utils":10}],3:[function(e,t,n){"use strict";var i=e("../utils.js").log,o=e("../utils.js").browserDetails,r={shimMediaStream:function(){window.MediaStream=window.MediaStream||window.webkitMediaStream},shimOnTrack:function(){"object"!=typeof window||!window.RTCPeerConnection||"ontrack"in window.RTCPeerConnection.prototype||Object.defineProperty(window.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){var t=this;this._ontrack&&(this.removeEventListener("track",this._ontrack),this.removeEventListener("addstream",this._ontrackpoly)),this.addEventListener("track",this._ontrack=e),this.addEventListener("addstream",this._ontrackpoly=function(e){e.stream.addEventListener("addtrack",function(n){var i=new Event("track");i.track=n.track,i.receiver={track:n.track},i.streams=[e.stream],t.dispatchEvent(i)}),e.stream.getTracks().forEach(function(t){var n=new Event("track");n.track=t,n.receiver={track:t},n.streams=[e.stream],this.dispatchEvent(n)}.bind(this))}.bind(this))}})},shimSourceObject:function(){"object"==typeof window&&(!window.HTMLMediaElement||"srcObject"in window.HTMLMediaElement.prototype||Object.defineProperty(window.HTMLMediaElement.prototype,"srcObject",{get:function(){return this._srcObject},set:function(e){var t=this;return this._srcObject=e,this.src&&URL.revokeObjectURL(this.src),e?(this.src=URL.createObjectURL(e),e.addEventListener("addtrack",function(){t.src&&URL.revokeObjectURL(t.src),t.src=URL.createObjectURL(e)}),void e.addEventListener("removetrack",function(){t.src&&URL.revokeObjectURL(t.src),t.src=URL.createObjectURL(e)})):void(this.src="")}}))},shimPeerConnection:function(){window.RTCPeerConnection=function(e,t){i("PeerConnection"),e&&e.iceTransportPolicy&&(e.iceTransports=e.iceTransportPolicy);var n=new webkitRTCPeerConnection(e,t),o=n.getStats.bind(n);return n.getStats=function(e,t,n){var i=this,r=arguments;if(arguments.length>0&&"function"==typeof e)return o(e,t);var s=function(e){var t={},n=e.result();return n.forEach(function(e){var n={id:e.id,timestamp:e.timestamp,type:e.type};e.names().forEach(function(t){n[t]=e.stat(t)}),t[n.id]=n}),t},a=function(e,t){var n=new Map(Object.keys(e).map(function(t){return[t,e[t]]}));return t=t||e,Object.keys(t).forEach(function(e){n[e]=t[e]}),n};if(arguments.length>=2){var c=function(e){r[1](a(s(e)))};return o.apply(this,[c,arguments[0]])}return new Promise(function(t,n){1===r.length&&"object"==typeof e?o.apply(i,[function(e){t(a(s(e)))},n]):o.apply(i,[function(e){t(a(s(e),e.result()))},n])}).then(t,n)},n},window.RTCPeerConnection.prototype=webkitRTCPeerConnection.prototype,webkitRTCPeerConnection.generateCertificate&&Object.defineProperty(window.RTCPeerConnection,"generateCertificate",{get:function(){return webkitRTCPeerConnection.generateCertificate}}),["createOffer","createAnswer"].forEach(function(e){var t=webkitRTCPeerConnection.prototype[e];webkitRTCPeerConnection.prototype[e]=function(){var e=this;if(arguments.length<1||1===arguments.length&&"object"==typeof arguments[0]){var n=1===arguments.length?arguments[0]:void 0;return new Promise(function(i,o){t.apply(e,[i,o,n])})}return t.apply(this,arguments)}}),o.version<51&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(e){var t=webkitRTCPeerConnection.prototype[e];webkitRTCPeerConnection.prototype[e]=function(){var e=arguments,n=this,i=new Promise(function(i,o){t.apply(n,[e[0],i,o])});return e.length<2?i:i.then(function(){e[1].apply(null,[])},function(t){e.length>=3&&e[2].apply(null,[t])})}}),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(e){var t=webkitRTCPeerConnection.prototype[e];webkitRTCPeerConnection.prototype[e]=function(){return arguments[0]=new("addIceCandidate"===e?RTCIceCandidate:RTCSessionDescription)(arguments[0]),t.apply(this,arguments)}});var e=RTCPeerConnection.prototype.addIceCandidate;RTCPeerConnection.prototype.addIceCandidate=function(){return null===arguments[0]?(arguments[1]&&arguments[1].apply(null),Promise.resolve()):e.apply(this,arguments)}}};t.exports={shimMediaStream:r.shimMediaStream,shimOnTrack:r.shimOnTrack,shimSourceObject:r.shimSourceObject,shimPeerConnection:r.shimPeerConnection,shimGetUserMedia:e("./getusermedia")}},{"../utils.js":10,"./getusermedia":4}],4:[function(e,t,n){
"use strict";var i=e("../utils.js").log;t.exports=function(){var e=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;var t={};return Object.keys(e).forEach(function(n){if("require"!==n&&"advanced"!==n&&"mediaSource"!==n){var i="object"==typeof e[n]?e[n]:{ideal:e[n]};void 0!==i.exact&&"number"==typeof i.exact&&(i.min=i.max=i.exact);var o=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==i.ideal){t.optional=t.optional||[];var r={};"number"==typeof i.ideal?(r[o("min",n)]=i.ideal,t.optional.push(r),r={},r[o("max",n)]=i.ideal,t.optional.push(r)):(r[o("",n)]=i.ideal,t.optional.push(r))}void 0!==i.exact&&"number"!=typeof i.exact?(t.mandatory=t.mandatory||{},t.mandatory[o("",n)]=i.exact):["min","max"].forEach(function(e){void 0!==i[e]&&(t.mandatory=t.mandatory||{},t.mandatory[o(e,n)]=i[e])})}}),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},t=function(t,n){if(t=JSON.parse(JSON.stringify(t)),t&&t.audio&&(t.audio=e(t.audio)),t&&"object"==typeof t.video){var o=t.video.facingMode;if(o=o&&("object"==typeof o?o:{ideal:o}),o&&("user"===o.exact||"environment"===o.exact||"user"===o.ideal||"environment"===o.ideal)&&(!navigator.mediaDevices.getSupportedConstraints||!navigator.mediaDevices.getSupportedConstraints().facingMode)&&(delete t.video.facingMode,"environment"===o.exact||"environment"===o.ideal))return navigator.mediaDevices.enumerateDevices().then(function(r){r=r.filter(function(e){return"videoinput"===e.kind});var s=r.find(function(e){return-1!==e.label.toLowerCase().indexOf("back")})||r.length&&r[r.length-1];return s&&(t.video.deviceId=o.exact?{exact:s.deviceId}:{ideal:s.deviceId}),t.video=e(t.video),i("chrome: "+JSON.stringify(t)),n(t)});t.video=e(t.video)}return i("chrome: "+JSON.stringify(t)),n(t)},n=function(e){return{name:{PermissionDeniedError:"NotAllowedError",ConstraintNotSatisfiedError:"OverconstrainedError"}[e.name]||e.name,message:e.message,constraint:e.constraintName,toString:function(){return this.name+(this.message&&": ")+this.message}}},o=function(e,i,o){t(e,function(e){navigator.webkitGetUserMedia(e,i,function(e){o(n(e))})})};navigator.getUserMedia=o;var r=function(e){return new Promise(function(t,n){navigator.getUserMedia(e,t,n)})};if(navigator.mediaDevices||(navigator.mediaDevices={getUserMedia:r,enumerateDevices:function(){return new Promise(function(e){var t={audio:"audioinput",video:"videoinput"};return MediaStreamTrack.getSources(function(n){e(n.map(function(e){return{label:e.label,kind:t[e.kind],deviceId:e.id,groupId:""}}))})})}}),navigator.mediaDevices.getUserMedia){var s=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(e){return t(e,function(e){return s(e).then(function(t){if(e.audio&&!t.getAudioTracks().length||e.video&&!t.getVideoTracks().length)throw t.getTracks().forEach(function(e){e.stop()}),new DOMException("","NotFoundError");return t},function(e){return Promise.reject(n(e))})})}}else navigator.mediaDevices.getUserMedia=function(e){return r(e)};"undefined"==typeof navigator.mediaDevices.addEventListener&&(navigator.mediaDevices.addEventListener=function(){i("Dummy mediaDevices.addEventListener called.")}),"undefined"==typeof navigator.mediaDevices.removeEventListener&&(navigator.mediaDevices.removeEventListener=function(){i("Dummy mediaDevices.removeEventListener called.")})}},{"../utils.js":10}],5:[function(e,t,n){"use strict";var i=e("sdp"),o=e("../utils").browserDetails,r={shimPeerConnection:function(){window.RTCIceGatherer&&(window.RTCIceCandidate||(window.RTCIceCandidate=function(e){return e}),window.RTCSessionDescription||(window.RTCSessionDescription=function(e){return e})),window.RTCPeerConnection=function(e){var t=this,n=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach(function(e){t[e]=n[e].bind(n)}),this.onicecandidate=null,this.onaddstream=null,this.ontrack=null,this.onremovestream=null,this.onsignalingstatechange=null,this.oniceconnectionstatechange=null,this.onnegotiationneeded=null,this.ondatachannel=null,this.localStreams=[],this.remoteStreams=[],this.getLocalStreams=function(){return t.localStreams},this.getRemoteStreams=function(){return t.remoteStreams},this.localDescription=new RTCSessionDescription({type:"",sdp:""}),this.remoteDescription=new RTCSessionDescription({type:"",sdp:""}),this.signalingState="stable",this.iceConnectionState="new",this.iceGatheringState="new",this.iceOptions={gatherPolicy:"all",iceServers:[]},e&&e.iceTransportPolicy)switch(e.iceTransportPolicy){case"all":case"relay":this.iceOptions.gatherPolicy=e.iceTransportPolicy;break;case"none":throw new TypeError('iceTransportPolicy "none" not supported')}if(this.usingBundle=e&&"max-bundle"===e.bundlePolicy,e&&e.iceServers){var i=JSON.parse(JSON.stringify(e.iceServers));this.iceOptions.iceServers=i.filter(function(e){if(e&&e.urls){var t=e.urls;return"string"==typeof t&&(t=[t]),t=t.filter(function(e){return 0===e.indexOf("turn:")&&-1!==e.indexOf("transport=udp")&&-1===e.indexOf("turn:[")||0===e.indexOf("stun:")&&o.version>=14393})[0],!!t}return!1})}this._config=e,this.transceivers=[],this._localIceCandidatesBuffer=[]},window.RTCPeerConnection.prototype._emitBufferedCandidates=function(){var e=this,t=i.splitSections(e.localDescription.sdp);this._localIceCandidatesBuffer.forEach(function(n){var i=!n.candidate||0===Object.keys(n.candidate).length;if(i)for(var o=1;o<t.length;o++)-1===t[o].indexOf("\r\na=end-of-candidates\r\n")&&(t[o]+="a=end-of-candidates\r\n");else-1===n.candidate.candidate.indexOf("typ endOfCandidates")&&(t[n.candidate.sdpMLineIndex+1]+="a="+n.candidate.candidate+"\r\n");if(e.localDescription.sdp=t.join(""),e.dispatchEvent(n),null!==e.onicecandidate&&e.onicecandidate(n),!n.candidate&&"complete"!==e.iceGatheringState){var r=e.transceivers.every(function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state});r&&(e.iceGatheringState="complete")}}),this._localIceCandidatesBuffer=[]},window.RTCPeerConnection.prototype.getConfiguration=function(){return this._config},window.RTCPeerConnection.prototype.addStream=function(e){this.localStreams.push(e.clone()),this._maybeFireNegotiationNeeded()},window.RTCPeerConnection.prototype.removeStream=function(e){var t=this.localStreams.indexOf(e);t>-1&&(this.localStreams.splice(t,1),this._maybeFireNegotiationNeeded())},window.RTCPeerConnection.prototype.getSenders=function(){return this.transceivers.filter(function(e){return!!e.rtpSender}).map(function(e){return e.rtpSender})},window.RTCPeerConnection.prototype.getReceivers=function(){return this.transceivers.filter(function(e){return!!e.rtpReceiver}).map(function(e){return e.rtpReceiver})},window.RTCPeerConnection.prototype._getCommonCapabilities=function(e,t){var n={codecs:[],headerExtensions:[],fecMechanisms:[]};return e.codecs.forEach(function(e){for(var i=0;i<t.codecs.length;i++){var o=t.codecs[i];if(e.name.toLowerCase()===o.name.toLowerCase()&&e.clockRate===o.clockRate&&e.numChannels===o.numChannels){n.codecs.push(o),o.rtcpFeedback=o.rtcpFeedback.filter(function(t){for(var n=0;n<e.rtcpFeedback.length;n++)if(e.rtcpFeedback[n].type===t.type&&e.rtcpFeedback[n].parameter===t.parameter)return!0;return!1});break}}}),e.headerExtensions.forEach(function(e){for(var i=0;i<t.headerExtensions.length;i++){var o=t.headerExtensions[i];if(e.uri===o.uri){n.headerExtensions.push(o);break}}}),n},window.RTCPeerConnection.prototype._createIceAndDtlsTransports=function(e,t){var n=this,o=new RTCIceGatherer(n.iceOptions),r=new RTCIceTransport(o);o.onlocalcandidate=function(s){var a=new Event("icecandidate");a.candidate={sdpMid:e,sdpMLineIndex:t};var c=s.candidate,d=!c||0===Object.keys(c).length;d?(void 0===o.state&&(o.state="completed"),a.candidate.candidate="candidate:1 1 udp 1 0.0.0.0 9 typ endOfCandidates"):(c.component="RTCP"===r.component?2:1,a.candidate.candidate=i.writeCandidate(c));var l=i.splitSections(n.localDescription.sdp);-1===a.candidate.candidate.indexOf("typ endOfCandidates")?l[a.candidate.sdpMLineIndex+1]+="a="+a.candidate.candidate+"\r\n":l[a.candidate.sdpMLineIndex+1]+="a=end-of-candidates\r\n",n.localDescription.sdp=l.join("");var u=n.transceivers.every(function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state});switch(n.iceGatheringState){case"new":n._localIceCandidatesBuffer.push(a),d&&u&&n._localIceCandidatesBuffer.push(new Event("icecandidate"));break;case"gathering":n._emitBufferedCandidates(),n.dispatchEvent(a),null!==n.onicecandidate&&n.onicecandidate(a),u&&(n.dispatchEvent(new Event("icecandidate")),null!==n.onicecandidate&&n.onicecandidate(new Event("icecandidate")),n.iceGatheringState="complete");break;case"complete":}},r.onicestatechange=function(){n._updateConnectionState()};var s=new RTCDtlsTransport(r);return s.ondtlsstatechange=function(){n._updateConnectionState()},s.onerror=function(){s.state="failed",n._updateConnectionState()},{iceGatherer:o,iceTransport:r,dtlsTransport:s}},window.RTCPeerConnection.prototype._transceive=function(e,t,n){var o=this._getCommonCapabilities(e.localCapabilities,e.remoteCapabilities);t&&e.rtpSender&&(o.encodings=e.sendEncodingParameters,o.rtcp={cname:i.localCName},e.recvEncodingParameters.length&&(o.rtcp.ssrc=e.recvEncodingParameters[0].ssrc),e.rtpSender.send(o)),n&&e.rtpReceiver&&("video"===e.kind&&e.recvEncodingParameters&&e.recvEncodingParameters.forEach(function(e){delete e.rtx}),o.encodings=e.recvEncodingParameters,o.rtcp={cname:e.cname},e.sendEncodingParameters.length&&(o.rtcp.ssrc=e.sendEncodingParameters[0].ssrc),e.rtpReceiver.receive(o))},window.RTCPeerConnection.prototype.setLocalDescription=function(e){var t,n,o=this;if("offer"===e.type)this._pendingOffer&&(t=i.splitSections(e.sdp),n=t.shift(),t.forEach(function(e,t){var n=i.parseRtpParameters(e);o._pendingOffer[t].localCapabilities=n}),this.transceivers=this._pendingOffer,delete this._pendingOffer);else if("answer"===e.type){t=i.splitSections(o.remoteDescription.sdp),n=t.shift();var r=i.matchPrefix(n,"a=ice-lite").length>0;t.forEach(function(e,t){var s=o.transceivers[t],a=s.iceGatherer,c=s.iceTransport,d=s.dtlsTransport,l=s.localCapabilities,u=s.remoteCapabilities,p="0"===e.split("\n",1)[0].split(" ",2)[1];if(!p&&!s.isDatachannel){var m=i.getIceParameters(e,n);if(r){var h=i.matchPrefix(e,"a=candidate:").map(function(e){return i.parseCandidate(e)}).filter(function(e){return"1"===e.component});h.length&&c.setRemoteCandidates(h)}var f=i.getDtlsParameters(e,n);r&&(f.role="server"),o.usingBundle&&0!==t||(c.start(a,m,r?"controlling":"controlled"),d.start(f));var g=o._getCommonCapabilities(l,u);o._transceive(s,g.codecs.length>0,!1)}})}switch(this.localDescription={type:e.type,sdp:e.sdp},e.type){case"offer":this._updateSignalingState("have-local-offer");break;case"answer":this._updateSignalingState("stable");break;default:throw new TypeError('unsupported type "'+e.type+'"')}var s=arguments.length>1&&"function"==typeof arguments[1];if(s){var a=arguments[1];window.setTimeout(function(){a(),"new"===o.iceGatheringState&&(o.iceGatheringState="gathering"),o._emitBufferedCandidates()},0)}var c=Promise.resolve();return c.then(function(){s||("new"===o.iceGatheringState&&(o.iceGatheringState="gathering"),window.setTimeout(o._emitBufferedCandidates.bind(o),500))}),c},window.RTCPeerConnection.prototype.setRemoteDescription=function(e){var t=this,n=new MediaStream,o=[],r=i.splitSections(e.sdp),s=r.shift(),a=i.matchPrefix(s,"a=ice-lite").length>0;switch(this.usingBundle=i.matchPrefix(s,"a=group:BUNDLE ").length>0,r.forEach(function(r,c){var d=i.splitLines(r),l=d[0].substr(2).split(" "),u=l[0],p="0"===l[1],m=i.getDirection(r,s),h=i.matchPrefix(r,"a=mid:");if(h=h.length?h[0].substr(6):i.generateIdentifier(),"application"===u&&"DTLS/SCTP"===l[2])return void(t.transceivers[c]={mid:h,isDatachannel:!0});var f,g,_,v,y,b,E,S,T,C,I,O,R=i.parseRtpParameters(r);p||(I=i.getIceParameters(r,s),O=i.getDtlsParameters(r,s),O.role="client"),S=i.parseRtpEncodingParameters(r);var N,w=i.matchPrefix(r,"a=ssrc:").map(function(e){return i.parseSsrcMedia(e)}).filter(function(e){return"cname"===e.attribute})[0];w&&(N=w.value);var x=i.matchPrefix(r,"a=end-of-candidates",s).length>0,M=i.matchPrefix(r,"a=candidate:").map(function(e){return i.parseCandidate(e)}).filter(function(e){return"1"===e.component});if("offer"!==e.type||p)"answer"!==e.type||p||(f=t.transceivers[c],g=f.iceGatherer,_=f.iceTransport,v=f.dtlsTransport,y=f.rtpSender,b=f.rtpReceiver,E=f.sendEncodingParameters,T=f.localCapabilities,t.transceivers[c].recvEncodingParameters=S,t.transceivers[c].remoteCapabilities=R,t.transceivers[c].cname=N,(a||x)&&M.length&&_.setRemoteCandidates(M),t.usingBundle&&0!==c||(_.start(g,I,"controlling"),v.start(O)),t._transceive(f,"sendrecv"===m||"recvonly"===m,"sendrecv"===m||"sendonly"===m),!b||"sendrecv"!==m&&"sendonly"!==m?delete f.rtpReceiver:(C=b.track,o.push([C,b]),n.addTrack(C)));else{var A=t.usingBundle&&c>0?{iceGatherer:t.transceivers[0].iceGatherer,iceTransport:t.transceivers[0].iceTransport,dtlsTransport:t.transceivers[0].dtlsTransport}:t._createIceAndDtlsTransports(h,c);if(x&&A.iceTransport.setRemoteCandidates(M),T=RTCRtpReceiver.getCapabilities(u),T.codecs=T.codecs.filter(function(e){return"rtx"!==e.name}),E=[{ssrc:1001*(2*c+2)}],b=new RTCRtpReceiver(A.dtlsTransport,u),C=b.track,o.push([C,b]),n.addTrack(C),t.localStreams.length>0&&t.localStreams[0].getTracks().length>=c){var D;"audio"===u?D=t.localStreams[0].getAudioTracks()[0]:"video"===u&&(D=t.localStreams[0].getVideoTracks()[0]),D&&(y=new RTCRtpSender(D,A.dtlsTransport))}t.transceivers[c]={iceGatherer:A.iceGatherer,iceTransport:A.iceTransport,dtlsTransport:A.dtlsTransport,localCapabilities:T,remoteCapabilities:R,rtpSender:y,rtpReceiver:b,kind:u,mid:h,cname:N,sendEncodingParameters:E,recvEncodingParameters:S},t._transceive(t.transceivers[c],!1,"sendrecv"===m||"sendonly"===m)}}),this.remoteDescription={type:e.type,sdp:e.sdp},e.type){case"offer":this._updateSignalingState("have-remote-offer");break;case"answer":this._updateSignalingState("stable");break;default:throw new TypeError('unsupported type "'+e.type+'"')}return n.getTracks().length&&(t.remoteStreams.push(n),window.setTimeout(function(){var e=new Event("addstream");e.stream=n,t.dispatchEvent(e),null!==t.onaddstream&&window.setTimeout(function(){t.onaddstream(e)},0),o.forEach(function(i){var o=i[0],r=i[1],s=new Event("track");s.track=o,s.receiver=r,s.streams=[n],t.dispatchEvent(e),null!==t.ontrack&&window.setTimeout(function(){t.ontrack(s)},0)})},0)),arguments.length>1&&"function"==typeof arguments[1]&&window.setTimeout(arguments[1],0),Promise.resolve()},window.RTCPeerConnection.prototype.close=function(){this.transceivers.forEach(function(e){e.iceTransport&&e.iceTransport.stop(),e.dtlsTransport&&e.dtlsTransport.stop(),e.rtpSender&&e.rtpSender.stop(),e.rtpReceiver&&e.rtpReceiver.stop()}),this._updateSignalingState("closed")},window.RTCPeerConnection.prototype._updateSignalingState=function(e){this.signalingState=e;var t=new Event("signalingstatechange");this.dispatchEvent(t),null!==this.onsignalingstatechange&&this.onsignalingstatechange(t)},window.RTCPeerConnection.prototype._maybeFireNegotiationNeeded=function(){var e=new Event("negotiationneeded");this.dispatchEvent(e),null!==this.onnegotiationneeded&&this.onnegotiationneeded(e)},window.RTCPeerConnection.prototype._updateConnectionState=function(){var e,t=this,n={"new":0,closed:0,connecting:0,checking:0,connected:0,completed:0,failed:0};if(this.transceivers.forEach(function(e){n[e.iceTransport.state]++,n[e.dtlsTransport.state]++}),n.connected+=n.completed,e="new",n.failed>0?e="failed":n.connecting>0||n.checking>0?e="connecting":n.disconnected>0?e="disconnected":n["new"]>0?e="new":(n.connected>0||n.completed>0)&&(e="connected"),e!==t.iceConnectionState){t.iceConnectionState=e;var i=new Event("iceconnectionstatechange");this.dispatchEvent(i),null!==this.oniceconnectionstatechange&&this.oniceconnectionstatechange(i)}},window.RTCPeerConnection.prototype.createOffer=function(){var e=this;if(this._pendingOffer)throw new Error("createOffer called while there is a pending offer.");var t;1===arguments.length&&"function"!=typeof arguments[0]?t=arguments[0]:3===arguments.length&&(t=arguments[2]);var n=[],o=0,r=0;if(this.localStreams.length&&(o=this.localStreams[0].getAudioTracks().length,r=this.localStreams[0].getVideoTracks().length),t){if(t.mandatory||t.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==t.offerToReceiveAudio&&(o=t.offerToReceiveAudio),void 0!==t.offerToReceiveVideo&&(r=t.offerToReceiveVideo)}for(this.localStreams.length&&this.localStreams[0].getTracks().forEach(function(e){n.push({kind:e.kind,track:e,wantReceive:"audio"===e.kind?o>0:r>0}),"audio"===e.kind?o--:"video"===e.kind&&r--});o>0||r>0;)o>0&&(n.push({kind:"audio",wantReceive:!0}),o--),r>0&&(n.push({kind:"video",wantReceive:!0}),r--);var s=i.writeSessionBoilerplate(),a=[];n.forEach(function(t,n){var o=t.track,r=t.kind,s=i.generateIdentifier(),c=e.usingBundle&&n>0?{iceGatherer:a[0].iceGatherer,iceTransport:a[0].iceTransport,dtlsTransport:a[0].dtlsTransport}:e._createIceAndDtlsTransports(s,n),d=RTCRtpSender.getCapabilities(r);d.codecs=d.codecs.filter(function(e){return"rtx"!==e.name}),d.codecs.forEach(function(e){"H264"===e.name&&void 0===e.parameters["level-asymmetry-allowed"]&&(e.parameters["level-asymmetry-allowed"]="1")});var l,u,p=[{ssrc:1001*(2*n+1)}];o&&(l=new RTCRtpSender(o,c.dtlsTransport)),t.wantReceive&&(u=new RTCRtpReceiver(c.dtlsTransport,r)),a[n]={iceGatherer:c.iceGatherer,iceTransport:c.iceTransport,dtlsTransport:c.dtlsTransport,localCapabilities:d,remoteCapabilities:null,rtpSender:l,rtpReceiver:u,kind:r,mid:s,sendEncodingParameters:p,recvEncodingParameters:null}}),this.usingBundle&&(s+="a=group:BUNDLE "+a.map(function(e){return e.mid}).join(" ")+"\r\n"),n.forEach(function(t,n){var o=a[n];s+=i.writeMediaSection(o,o.localCapabilities,"offer",e.localStreams[0])}),this._pendingOffer=a;var c=new RTCSessionDescription({type:"offer",sdp:s});return arguments.length&&"function"==typeof arguments[0]&&window.setTimeout(arguments[0],0,c),Promise.resolve(c)},window.RTCPeerConnection.prototype.createAnswer=function(){var e=this,t=i.writeSessionBoilerplate();this.usingBundle&&(t+="a=group:BUNDLE "+this.transceivers.map(function(e){return e.mid}).join(" ")+"\r\n"),this.transceivers.forEach(function(n){if(n.isDatachannel)return void(t+="m=application 0 DTLS/SCTP 5000\r\nc=IN IP4 0.0.0.0\r\na=mid:"+n.mid+"\r\n");var o=e._getCommonCapabilities(n.localCapabilities,n.remoteCapabilities);t+=i.writeMediaSection(n,o,"answer",e.localStreams[0])});var n=new RTCSessionDescription({type:"answer",sdp:t});return arguments.length&&"function"==typeof arguments[0]&&window.setTimeout(arguments[0],0,n),Promise.resolve(n)},window.RTCPeerConnection.prototype.addIceCandidate=function(e){if(null===e)this.transceivers.forEach(function(e){e.iceTransport.addRemoteCandidate({})});else{var t=e.sdpMLineIndex;if(e.sdpMid)for(var n=0;n<this.transceivers.length;n++)if(this.transceivers[n].mid===e.sdpMid){t=n;break}var o=this.transceivers[t];if(o){var r=Object.keys(e.candidate).length>0?i.parseCandidate(e.candidate):{};if("tcp"===r.protocol&&(0===r.port||9===r.port))return;if("1"!==r.component)return;"endOfCandidates"===r.type&&(r={}),o.iceTransport.addRemoteCandidate(r);var s=i.splitSections(this.remoteDescription.sdp);s[t+1]+=(r.type?e.candidate.trim():"a=end-of-candidates")+"\r\n",this.remoteDescription.sdp=s.join("")}}return arguments.length>1&&"function"==typeof arguments[1]&&window.setTimeout(arguments[1],0),Promise.resolve()},window.RTCPeerConnection.prototype.getStats=function(){var e=[];this.transceivers.forEach(function(t){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(n){t[n]&&e.push(t[n].getStats())})});var t=arguments.length>1&&"function"==typeof arguments[1]&&arguments[1];return new Promise(function(n){var i=new Map;Promise.all(e).then(function(e){e.forEach(function(e){Object.keys(e).forEach(function(t){i.set(t,e[t]),i[t]=e[t]})}),t&&window.setTimeout(t,0,i),n(i)})})}}};t.exports={shimPeerConnection:r.shimPeerConnection,shimGetUserMedia:e("./getusermedia")}},{"../utils":10,"./getusermedia":6,sdp:1}],6:[function(e,t,n){"use strict";t.exports=function(){var e=function(e){return{name:{PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:e.message,constraint:e.constraint,toString:function(){return this.name}}},t=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(n){return t(n)["catch"](function(t){return Promise.reject(e(t))})}}},{}],7:[function(e,t,n){"use strict";var i=e("../utils").browserDetails,o={shimOnTrack:function(){"object"!=typeof window||!window.RTCPeerConnection||"ontrack"in window.RTCPeerConnection.prototype||Object.defineProperty(window.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){this._ontrack&&(this.removeEventListener("track",this._ontrack),this.removeEventListener("addstream",this._ontrackpoly)),this.addEventListener("track",this._ontrack=e),this.addEventListener("addstream",this._ontrackpoly=function(e){e.stream.getTracks().forEach(function(t){var n=new Event("track");n.track=t,n.receiver={track:t},n.streams=[e.stream],this.dispatchEvent(n)}.bind(this))}.bind(this))}})},shimSourceObject:function(){"object"==typeof window&&(!window.HTMLMediaElement||"srcObject"in window.HTMLMediaElement.prototype||Object.defineProperty(window.HTMLMediaElement.prototype,"srcObject",{get:function(){return this.mozSrcObject},set:function(e){this.mozSrcObject=e}}))},shimPeerConnection:function(){if("object"==typeof window&&(window.RTCPeerConnection||window.mozRTCPeerConnection)){window.RTCPeerConnection||(window.RTCPeerConnection=function(e,t){if(i.version<38&&e&&e.iceServers){for(var n=[],o=0;o<e.iceServers.length;o++){var r=e.iceServers[o];if(r.hasOwnProperty("urls"))for(var s=0;s<r.urls.length;s++){var a={url:r.urls[s]};0===r.urls[s].indexOf("turn")&&(a.username=r.username,a.credential=r.credential),n.push(a)}else n.push(e.iceServers[o])}e.iceServers=n}return new mozRTCPeerConnection(e,t)},window.RTCPeerConnection.prototype=mozRTCPeerConnection.prototype,mozRTCPeerConnection.generateCertificate&&Object.defineProperty(window.RTCPeerConnection,"generateCertificate",{get:function(){return mozRTCPeerConnection.generateCertificate}}),window.RTCSessionDescription=mozRTCSessionDescription,window.RTCIceCandidate=mozRTCIceCandidate),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(e){var t=RTCPeerConnection.prototype[e];RTCPeerConnection.prototype[e]=function(){return arguments[0]=new("addIceCandidate"===e?RTCIceCandidate:RTCSessionDescription)(arguments[0]),t.apply(this,arguments)}});var e=RTCPeerConnection.prototype.addIceCandidate;RTCPeerConnection.prototype.addIceCandidate=function(){return null===arguments[0]?(arguments[1]&&arguments[1].apply(null),Promise.resolve()):e.apply(this,arguments)};var t=function(e){var t=new Map;return Object.keys(e).forEach(function(n){t.set(n,e[n]),t[n]=e[n]}),t},n=RTCPeerConnection.prototype.getStats;RTCPeerConnection.prototype.getStats=function(e,i,o){return n.apply(this,[e||null]).then(function(e){return t(e)}).then(i,o)}}}};t.exports={shimOnTrack:o.shimOnTrack,shimSourceObject:o.shimSourceObject,shimPeerConnection:o.shimPeerConnection,shimGetUserMedia:e("./getusermedia")}},{"../utils":10,"./getusermedia":8}],8:[function(e,t,n){"use strict";var i=e("../utils").log,o=e("../utils").browserDetails;t.exports=function(){var e=function(e){return{name:{SecurityError:"NotAllowedError",PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:{"The operation is insecure.":"The request is not allowed by the user agent or the platform in the current context."}[e.message]||e.message,constraint:e.constraint,toString:function(){return this.name+(this.message&&": ")+this.message}}},t=function(t,n,r){var s=function(e){if("object"!=typeof e||e.require)return e;var t=[];return Object.keys(e).forEach(function(n){if("require"!==n&&"advanced"!==n&&"mediaSource"!==n){var i=e[n]="object"==typeof e[n]?e[n]:{ideal:e[n]};if((void 0!==i.min||void 0!==i.max||void 0!==i.exact)&&t.push(n),void 0!==i.exact&&("number"==typeof i.exact?i.min=i.max=i.exact:e[n]=i.exact,delete i.exact),void 0!==i.ideal){e.advanced=e.advanced||[];var o={};"number"==typeof i.ideal?o[n]={min:i.ideal,max:i.ideal}:o[n]=i.ideal,e.advanced.push(o),delete i.ideal,Object.keys(i).length||delete e[n]}}}),t.length&&(e.require=t),e};return t=JSON.parse(JSON.stringify(t)),o.version<38&&(i("spec: "+JSON.stringify(t)),t.audio&&(t.audio=s(t.audio)),t.video&&(t.video=s(t.video)),i("ff37: "+JSON.stringify(t))),navigator.mozGetUserMedia(t,n,function(t){r(e(t))})},n=function(e){return new Promise(function(n,i){t(e,n,i)})};if(navigator.mediaDevices||(navigator.mediaDevices={getUserMedia:n,addEventListener:function(){},removeEventListener:function(){}}),navigator.mediaDevices.enumerateDevices=navigator.mediaDevices.enumerateDevices||function(){return new Promise(function(e){var t=[{kind:"audioinput",deviceId:"default",label:"",groupId:""},{kind:"videoinput",deviceId:"default",label:"",groupId:""}];e(t)})},o.version<41){var r=navigator.mediaDevices.enumerateDevices.bind(navigator.mediaDevices);navigator.mediaDevices.enumerateDevices=function(){return r().then(void 0,function(e){if("NotFoundError"===e.name)return[];throw e})}}if(o.version<49){var s=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(t){return s(t).then(function(e){if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length)throw e.getTracks().forEach(function(e){e.stop()}),new DOMException("The object can not be found here.","NotFoundError");return e},function(t){return Promise.reject(e(t))})}}navigator.getUserMedia=function(e,n,i){return o.version<44?t(e,n,i):(console.warn("navigator.getUserMedia has been replaced by navigator.mediaDevices.getUserMedia"),void navigator.mediaDevices.getUserMedia(e).then(n,i))}}},{"../utils":10}],9:[function(e,t,n){"use strict";var i={shimGetUserMedia:function(){navigator.getUserMedia=navigator.webkitGetUserMedia}};t.exports={shimGetUserMedia:i.shimGetUserMedia}},{}],10:[function(e,t,n){"use strict";var i=!0,o={disableLog:function(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(i=e,e?"adapter.js logging disabled":"adapter.js logging enabled")},log:function(){if("object"==typeof window){if(i)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}},extractVersion:function(e,t,n){var i=e.match(t);return i&&i.length>=n&&parseInt(i[n],10)},detectBrowser:function(){var e={};if(e.browser=null,e.version=null,"undefined"==typeof window||!window.navigator)return e.browser="Not a browser.",e;if(navigator.mozGetUserMedia)e.browser="firefox",e.version=this.extractVersion(navigator.userAgent,/Firefox\/([0-9]+)\./,1);else if(navigator.webkitGetUserMedia)if(window.webkitRTCPeerConnection)e.browser="chrome",e.version=this.extractVersion(navigator.userAgent,/Chrom(e|ium)\/([0-9]+)\./,2);else{if(!navigator.userAgent.match(/Version\/(\d+).(\d+)/))return e.browser="Unsupported webkit-based browser with GUM support but no WebRTC support.",e;e.browser="safari",e.version=this.extractVersion(navigator.userAgent,/AppleWebKit\/([0-9]+)\./,1)}else{if(!navigator.mediaDevices||!navigator.userAgent.match(/Edge\/(\d+).(\d+)$/))return e.browser="Not a supported browser.",e;e.browser="edge",e.version=this.extractVersion(navigator.userAgent,/Edge\/(\d+).(\d+)$/,2)}return e}};t.exports={log:o.log,disableLog:o.disableLog,browserDetails:o.detectBrowser(),extractVersion:o.extractVersion}},{}]},{},[2])(2)});var WebIM={};WebIM.config={isAutoLogin:!0,isWindowSDK:!1,isSandBox:!1,isDebug:!1,autoReconnectNumMax:2,autoReconnectInterval:2,isWebRTC:/WebKit/.test(navigator.userAgent)&&/^https\:$/.test(window.location.protocol),isHttpDNS:!1},function(e){function t(i){if(n[i])return n[i].exports;var o=n[i]={exports:{},id:i,loaded:!1};return e[i].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var n={};return t.m=e,t.c=n,t.p="./",t(0)}({0:function(e,t,n){e.exports=n(230)},223:function(e,t,n){"use strict";var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(){var e=function(){},o=n(224).code,r=10485760,s=function(){try{return new window.XMLHttpRequest}catch(e){return!1}},a=function(){try{return new window.ActiveXObject("Microsoft.XMLHTTP")}catch(e){return!1}},c=function(t){t=t||!0;var n=s()||a();if("withCredentials"in n)return n;if(!t)return n;if("undefined"==typeof window.XDomainRequest)return n;var i=new XDomainRequest;return i.readyState=0,i.status=100,i.onreadystatechange=e,i.onload=function(){i.readyState=4,i.status=200;var e=new ActiveXObject("Microsoft.XMLDOM");e.async="false",e.loadXML(i.responseText),i.responseXML=e,i.response=i.responseText,i.onreadystatechange()},i.ontimeout=i.onerror=function(){i.readyState=4,i.status=500,i.onreadystatechange()},i},d=function(){if("ActiveXObject"in window)try{return new ActiveXObject("ShockwaveFlash.ShockwaveFlash")}catch(e){return 0}else if(navigator.plugins&&navigator.plugins.length>0)return navigator.plugins["Shockwave Flash"];return 0}(),l=c(),u="undefined"!=typeof FormData,p="undefined"!=typeof Blob,m=l.setRequestHeader||!1,h=l.overrideMimeType||!1,f=m&&u,g=f||d,_=m&&(p||h);Object.keys||(Object.keys=function(){var e=Object.prototype.hasOwnProperty,t=!{toString:null}.propertyIsEnumerable("toString"),n=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],o=n.length;return function(r){if("object"!==("undefined"==typeof r?"undefined":i(r))&&("function"!=typeof r||null===r))throw new TypeError("Object.keys called on non-object");var s,a,c=[];for(s in r)e.call(r,s)&&c.push(s);if(t)for(a=0;o>a;a++)e.call(r,n[a])&&c.push(n[a]);return c}}());var v={hasFormData:u,hasBlob:p,emptyfn:e,isCanSetRequestHeader:m,hasOverrideMimeType:h,isCanUploadFileAsync:f,isCanUploadFile:g,isCanDownLoadFile:_,isSupportWss:function(){var e=[/MQQBrowser[\/]5([.]\d+)?\sTBS/];if(!window.WebSocket)return!1;for(var t=window.navigator.userAgent,n=0,i=e.length;i>n;n++)if(e[n].test(t))return!1;return!0}(),getIEVersion:function(){var e,t=navigator.userAgent,n={4:8,5:9,6:10,7:11};return e=t.match(/MSIE (\d+)/i),e&&e[1]?+e[1]:(e=t.match(/Trident\/(\d+)/i),e&&e[1]?n[e[1]]||null:null)}(),stringify:function(e){if("undefined"!=typeof JSON&&JSON.stringify)return JSON.stringify(e);var t="",n=[],o=function r(e){var o=!1;"[object Array]"===Object.prototype.toString.call(e)?(n.push("]","["),o=!0):"[object Object]"===Object.prototype.toString.call(e)&&n.push("}","{");for(var s in e)"[object Null]"===Object.prototype.toString.call(e[s])?e[s]="null":"[object Undefined]"===Object.prototype.toString.call(e[s])&&(e[s]="undefined"),t+=e[s]&&"object"===i(e[s])?","+(o?"":'"'+s+'":'+(o?'"':""))+r(e[s]):',"'+(o?"":s+'":"')+e[s]+'"';return""!=t&&(t=t.slice(1)),n.pop()+t+n.pop()};return o(e)},login:function(t){var t=t||{},n=t.success||e,i=t.error||e,r=t.appKey||"",s=r.split("#");if(2!==s.length)return i({type:o.WEBIM_CONNCTION_APPKEY_NOT_ASSIGN_ERROR}),!1;var a=s[0],c=s[1],d=d||t.https,l=t.user||"",u=t.pwd||"",p=t.apiUrl,m={grant_type:"password",username:l,password:u,timestamp:+new Date},h=v.stringify(m),t={url:p+"/"+a+"/"+c+"/token",dataType:"json",data:h,success:n,error:i};return v.ajax(t)},getFileUrl:function(e){var t={url:"",filename:"",filetype:"",data:""},n="string"==typeof e?document.getElementById(e):e;if(!v.isCanUploadFileAsync||!n)return t;try{if(window.URL.createObjectURL){var i=n.files;if(i.length>0){var o=i.item(0);t.data=o,t.url=window.URL.createObjectURL(o),t.filename=o.name||"";
}}else{var o=document.getElementById(e).value;t.url=o;var r=o.lastIndexOf("/"),s=o.lastIndexOf("\\"),a=Math.max(r,s);0>a?t.filename=o:t.filename=o.substring(a+1)}var c=t.filename.lastIndexOf(".");return-1!=c&&(t.filetype=t.filename.substring(c+1).toLowerCase()),t}catch(d){throw d}},getFileSize:function(e){var t=0;if(e)if(e.files)e.files.length>0&&(t=e.files[0].size);else if(e.select&&"ActiveXObject"in window){e.select();var n=new ActiveXObject("Scripting.FileSystemObject"),e=n.GetFile(e.value);t=e.Size}if(console.log("fileSize: ",t),t>1e7)return!1;var i=Math.round(t/1e3);if(1e3>i)t=i+" KB";else if(i>=1e3){var o=i/1e3;if(1e3>o)t=o.toFixed(1)+" MB";else{var r=o/1e3;t=r.toFixed(1)+" GB"}}return t},hasFlash:d,trim:function(e){return e="string"==typeof e?e:"",e.trim?e.trim():e.replace(/^\s|\s$/g,"")},parseEmoji:function(e){if("undefined"==typeof WebIM.Emoji||"undefined"==typeof WebIM.Emoji.map)return e;var t=WebIM.Emoji;for(var n in t.map)if(t.map.hasOwnProperty(n))for(;e.indexOf(n)>-1;)e=e.replace(n,'<img class="emoji" src="'+t.path+t.map[n]+'" />');return e},parseLink:function(e){var t=/(https?\:\/\/|www\.)([a-zA-Z0-9-]+(\.[a-zA-Z0-9]+)+)(\:[0-9]{2,4})?\/?((\.[:_0-9a-zA-Z-]+)|[:_0-9a-zA-Z-]*\/?)*\??[:_#@*&%0-9a-zA-Z-\/=]*/gm;return e=e.replace(t,function(e){var t=/^https?/gm.test(e);return"<a href='"+(t?e:"//"+e)+"' target='_blank'>"+e+"</a>"})},parseJSON:function(e){if(window.JSON&&window.JSON.parse)return window.JSON.parse(e+"");var t,n=null,i=v.trim(e+"");return i&&!v.trim(i.replace(/(,)|(\[|{)|(}|])|"(?:[^"\\\r\n]|\\["\\\/bfnrt]|\\u[\da-fA-F]{4})*"\s*:?|true|false|null|-?(?!0\d)\d+(?:\.\d+|)(?:[eE][+-]?\d+|)/g,function(e,i,o,r){return t&&i&&(n=0),0===n?e:(t=o||i,n+=!r-!o,"")}))?Function("return "+i)():Function("Invalid JSON: "+e)()},parseUploadResponse:function(e){return e.indexOf("callback")>-1?e.slice(9,-1):e},parseDownloadResponse:function(e){return e&&e.type&&"application/json"===e.type||0>Object.prototype.toString.call(e).indexOf("Blob")?this.url+"?token=":window.URL.createObjectURL(e)},uploadFile:function(t){var t=t||{};t.onFileUploadProgress=t.onFileUploadProgress||e,t.onFileUploadComplete=t.onFileUploadComplete||e,t.onFileUploadError=t.onFileUploadError||e,t.onFileUploadCanceled=t.onFileUploadCanceled||e;var n=t.accessToken||this.context.accessToken;if(!n)return void t.onFileUploadError({type:o.WEBIM_UPLOADFILE_NO_LOGIN,id:t.id});var i,s,a,c=t.appKey||this.context.appKey||"";if(c&&(a=c.split("#"),i=a[0],s=a[1]),!i&&!s)return void t.onFileUploadError({type:o.WEBIM_UPLOADFILE_ERROR,id:t.id});var d=t.apiUrl,l=d+"/"+i+"/"+s+"/chatfiles";if(!v.isCanUploadFileAsync)return void(v.hasFlash&&"function"==typeof t.flashUpload?t.flashUpload&&t.flashUpload(l,t):t.onFileUploadError({type:o.WEBIM_UPLOADFILE_BROWSER_ERROR,id:t.id}));var u=t.file.data?t.file.data.size:void 0;if(u>r)return void t.onFileUploadError({type:o.WEBIM_UPLOADFILE_ERROR,id:t.id});if(0>=u)return void t.onFileUploadError({type:o.WEBIM_UPLOADFILE_ERROR,id:t.id});var p=v.xmlrequest(),m=function(e){t.onFileUploadError({type:o.WEBIM_UPLOADFILE_ERROR,id:t.id,xhr:p})};p.upload&&p.upload.addEventListener("progress",t.onFileUploadProgress,!1),p.addEventListener?(p.addEventListener("abort",t.onFileUploadCanceled,!1),p.addEventListener("load",function(e){try{var n=v.parseJSON(p.responseText);try{t.onFileUploadComplete(n)}catch(e){t.onFileUploadError({type:o.WEBIM_CONNCTION_CALLBACK_INNER_ERROR,data:e})}}catch(e){t.onFileUploadError({type:o.WEBIM_UPLOADFILE_ERROR,data:p.responseText,id:t.id,xhr:p})}},!1),p.addEventListener("error",m,!1)):p.onreadystatechange&&(p.onreadystatechange=function(){if(4===p.readyState)if(200===ajax.status)try{var e=v.parseJSON(p.responseText);t.onFileUploadComplete(e)}catch(n){t.onFileUploadError({type:o.WEBIM_UPLOADFILE_ERROR,data:p.responseText,id:t.id,xhr:p})}else t.onFileUploadError({type:o.WEBIM_UPLOADFILE_ERROR,data:p.responseText,id:t.id,xhr:p});else p.abort(),t.onFileUploadCanceled()}),p.open("POST",l),p.setRequestHeader("restrict-access","true"),p.setRequestHeader("Accept","*/*"),p.setRequestHeader("Authorization","Bearer "+n);var h=new FormData;h.append("file",t.file.data),p.send(h)},download:function(t){t.onFileDownloadComplete=t.onFileDownloadComplete||e,t.onFileDownloadError=t.onFileDownloadError||e;var n=t.accessToken||this.context.accessToken;if(!n)return void t.onFileDownloadError({type:o.WEBIM_DOWNLOADFILE_NO_LOGIN,id:t.id});var i=function(e){t.onFileDownloadError({type:o.WEBIM_DOWNLOADFILE_ERROR,id:t.id,xhr:r})};if(!v.isCanDownLoadFile)return void t.onFileDownloadComplete();var r=v.xmlrequest();"addEventListener"in r?(r.addEventListener("load",function(e){t.onFileDownloadComplete(r.response,r)},!1),r.addEventListener("error",i,!1)):"onreadystatechange"in r&&(r.onreadystatechange=function(){4===r.readyState?200===ajax.status?t.onFileDownloadComplete(r.response,r):t.onFileDownloadError({type:o.WEBIM_DOWNLOADFILE_ERROR,id:t.id,xhr:r}):(r.abort(),t.onFileDownloadError({type:o.WEBIM_DOWNLOADFILE_ERROR,id:t.id,xhr:r}))});var s=t.method||"GET",a=t.responseType||"blob",c=t.mimeType||"text/plain; charset=x-user-defined";r.open(s,t.url),"undefined"!=typeof Blob?r.responseType=a:r.overrideMimeType(c);var d={"X-Requested-With":"XMLHttpRequest",Accept:"application/octet-stream","share-secret":t.secret,Authorization:"Bearer "+n},l=t.headers||{};for(var u in l)d[u]=l[u];for(var u in d)d[u]&&r.setRequestHeader(u,d[u]);r.send(null)},parseTextMessage:function(e,t){if("string"==typeof e){if("[object Object]"!==Object.prototype.toString.call(t))return{isemoji:!1,body:[{type:"txt",data:e}]};var n=e,i=[],o=/\[[^[\]]{2,3}\]/gm,r=n.match(o);if(!r||r.length<1)return{isemoji:!1,body:[{type:"txt",data:e}]};for(var s=!1,a=0;a<r.length;a++){var c=n.substring(0,n.indexOf(r[a])),d=WebIM.Emoji.map[r[a]];if(c&&i.push({type:"txt",data:c}),d){var l=WebIM.Emoji.map?WebIM.Emoji.path+d:null;l?(s=!0,i.push({type:"emoji",data:l})):i.push({type:"txt",data:r[a]});var u=n.indexOf(r[a])+r[a].length;n=n.substring(u)}else i.push({type:"txt",data:r[a]})}return n&&i.push({type:"txt",data:n}),s?{isemoji:s,body:i}:{isemoji:!1,body:[{type:"txt",data:e}]}}},xmlrequest:c,getXmlFirstChild:function(e,t){var n=e.getElementsByTagName(t);return 0==n.length?null:n[0]},ajax:function(t){var n=t.dataType||"text",i=t.success||e,r=t.error||e,s=v.xmlrequest();s.onreadystatechange=function(){if(4===s.readyState){var e=s.status||0;if(200===e){try{switch(n){case"text":return void i(s.responseText);case"json":var t=v.parseJSON(s.responseText);return void i(t,s);case"xml":return void(s.responseXML&&s.responseXML.documentElement?i(s.responseXML.documentElement,s):r({type:o.WEBIM_CONNCTION_AJAX_ERROR,data:s.responseText}))}i(s.response||s.responseText,s)}catch(a){r({type:o.WEBIM_CONNCTION_AJAX_ERROR,data:a})}return}return void r({type:o.WEBIM_CONNCTION_AJAX_ERROR,data:s.responseText})}0===s.readyState&&r({type:o.WEBIM_CONNCTION_AJAX_ERROR,data:s.responseText})},t.responseType&&s.responseType&&(s.responseType=t.responseType),t.mimeType&&v.hasOverrideMimeType&&s.overrideMimeType(t.mimeType);var a=t.type||"POST",c=t.data||null,d="";if("get"===a.toLowerCase()&&c){for(var l in c)c.hasOwnProperty(l)&&(d+=l+"="+c[l]+"&");d=d?d.slice(0,-1):d,t.url+=(t.url.indexOf("?")>0?"&":"?")+(d?d+"&":d)+"_v="+(new Date).getTime(),c=null,d=null}if(s.open(a,t.url),v.isCanSetRequestHeader){var u=t.headers||{};for(var p in u)u.hasOwnProperty(p)&&s.setRequestHeader(p,u[p])}return s.send(c),s},ts:function(){var e=new Date,t=e.getHours(),n=e.getMinutes(),i=e.getSeconds(),o=e.getMilliseconds();return(10>t?"0"+t:t)+":"+(10>n?"0"+n:n)+":"+(10>i?"0"+i:i)+":"+o+" "},getObjectKey:function(e,t){for(var n in e)if(e[n]==t)return n;return""}};t.utils=v}()},224:function(e,t){"use strict";!function(){t.code={WEBIM_CONNCTION_USER_NOT_ASSIGN_ERROR:0,WEBIM_CONNCTION_OPEN_ERROR:1,WEBIM_CONNCTION_AUTH_ERROR:2,WEBIM_CONNCTION_OPEN_USERGRID_ERROR:3,WEBIM_CONNCTION_ATTACH_ERROR:4,WEBIM_CONNCTION_ATTACH_USERGRID_ERROR:5,WEBIM_CONNCTION_REOPEN_ERROR:6,WEBIM_CONNCTION_SERVER_CLOSE_ERROR:7,WEBIM_CONNCTION_SERVER_ERROR:8,WEBIM_CONNCTION_IQ_ERROR:9,WEBIM_CONNCTION_PING_ERROR:10,WEBIM_CONNCTION_NOTIFYVERSION_ERROR:11,WEBIM_CONNCTION_GETROSTER_ERROR:12,WEBIM_CONNCTION_CROSSDOMAIN_ERROR:13,WEBIM_CONNCTION_LISTENING_OUTOF_MAXRETRIES:14,WEBIM_CONNCTION_RECEIVEMSG_CONTENTERROR:15,WEBIM_CONNCTION_DISCONNECTED:16,WEBIM_CONNCTION_AJAX_ERROR:17,WEBIM_CONNCTION_JOINROOM_ERROR:18,WEBIM_CONNCTION_GETROOM_ERROR:19,WEBIM_CONNCTION_GETROOMINFO_ERROR:20,WEBIM_CONNCTION_GETROOMMEMBER_ERROR:21,WEBIM_CONNCTION_GETROOMOCCUPANTS_ERROR:22,WEBIM_CONNCTION_LOAD_CHATROOM_ERROR:23,WEBIM_CONNCTION_NOT_SUPPORT_CHATROOM_ERROR:24,WEBIM_CONNCTION_JOINCHATROOM_ERROR:25,WEBIM_CONNCTION_QUITCHATROOM_ERROR:26,WEBIM_CONNCTION_APPKEY_NOT_ASSIGN_ERROR:27,WEBIM_CONNCTION_TOKEN_NOT_ASSIGN_ERROR:28,WEBIM_CONNCTION_SESSIONID_NOT_ASSIGN_ERROR:29,WEBIM_CONNCTION_RID_NOT_ASSIGN_ERROR:30,WEBIM_CONNCTION_CALLBACK_INNER_ERROR:31,WEBIM_CONNCTION_CLIENT_OFFLINE:32,WEBIM_CONNCTION_CLIENT_LOGOUT:33,WEBIM_CONNCTION_CLIENT_TOO_MUCH_ERROR:34,WEBIM_CONNECTION_ACCEPT_INVITATION_FROM_GROUP:35,WEBIM_CONNECTION_DECLINE_INVITATION_FROM_GROUP:36,WEBIM_CONNECTION_ACCEPT_JOIN_GROUP:37,WEBIM_CONNECTION_DECLINE_JOIN_GROUP:38,WEBIM_CONNECTION_CLOSED:39,WEBIM_UPLOADFILE_BROWSER_ERROR:100,WEBIM_UPLOADFILE_ERROR:101,WEBIM_UPLOADFILE_NO_LOGIN:102,WEBIM_UPLOADFILE_NO_FILE:103,WEBIM_DOWNLOADFILE_ERROR:200,WEBIM_DOWNLOADFILE_NO_LOGIN:201,WEBIM_DOWNLOADFILE_BROWSER_ERROR:202,WEBIM_MESSAGE_REC_TEXT:300,WEBIM_MESSAGE_REC_TEXT_ERROR:301,WEBIM_MESSAGE_REC_EMOTION:302,WEBIM_MESSAGE_REC_PHOTO:303,WEBIM_MESSAGE_REC_AUDIO:304,WEBIM_MESSAGE_REC_AUDIO_FILE:305,WEBIM_MESSAGE_REC_VEDIO:306,WEBIM_MESSAGE_REC_VEDIO_FILE:307,WEBIM_MESSAGE_REC_FILE:308,WEBIM_MESSAGE_SED_TEXT:309,WEBIM_MESSAGE_SED_EMOTION:310,WEBIM_MESSAGE_SED_PHOTO:311,WEBIM_MESSAGE_SED_AUDIO:312,WEBIM_MESSAGE_SED_AUDIO_FILE:313,WEBIM_MESSAGE_SED_VEDIO:314,WEBIM_MESSAGE_SED_VEDIO_FILE:315,WEBIM_MESSAGE_SED_FILE:316,WEBIM_MESSAGE_SED_ERROR:317,STATUS_INIT:400,STATUS_DOLOGIN_USERGRID:401,STATUS_DOLOGIN_IM:402,STATUS_OPENED:403,STATUS_CLOSING:404,STATUS_CLOSED:405,STATUS_ERROR:406}}()},230:function(e,t,n){"use strict";e.exports=n(231)},231:function(module,exports,__webpack_require__){"use strict";function _parsePrivacy(e){var t=[],n=e.getElementsByTagName("item");if(n)for(var i=0;i<n.length;i++){var o=n[i],r=o.getAttribute("value"),s=o.getAttribute("order"),a=o.getAttribute("type");if(r){var c=_parseNameFromJidFn(r);t[c]={type:a,order:s,jid:r,name:c}}}return t}function _parseGroupBlacklist(e){var t={},n=e.getElementsByTagName("item");if(n)for(var i=0;i<n.length;i++){var o=n[i],r=o.getAttribute("jid"),s=o.getAttribute("affiliation"),a=o.getAttribute("nick");if(r){var c=_parseNameFromJidFn(r);t[c]={jid:r,affiliation:s,nick:a,name:c}}}return t}function _setText(e,t){"textContent"in e?e.textContent=t:"text"in e&&(e.text=t)}var _version="1.4.2",_code=__webpack_require__(224).code,_utils=__webpack_require__(223).utils,_msg=__webpack_require__(232),_message=_msg._msg,_msgHash={},Queue=__webpack_require__(233).Queue;window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL,window.XDomainRequest&&(XDomainRequest.prototype.oldsend=XDomainRequest.prototype.send,XDomainRequest.prototype.send=function(){XDomainRequest.prototype.oldsend.apply(this,arguments),this.readyState=2}),Strophe.Request.prototype._newXHR=function(){var e=_utils.xmlrequest(!0);return e.overrideMimeType&&e.overrideMimeType("text/xml"),e.onreadystatechange=this.func.bind(null,this),e},Strophe.Websocket.prototype._closeSocket=function(){if(this.socket){var e=this;setTimeout(function(){try{e.socket.close()}catch(t){}},0)}else this.socket=null},Strophe.Websocket.prototype._onMessage=function(e){WebIM&&WebIM.config.isDebug&&console.log(WebIM.utils.ts()+"recv:",e.data);var t,n;if(0===e.data.indexOf("<close ")){t=(new DOMParser).parseFromString(e.data,"text/xml").documentElement;var i=t.getAttribute("see-other-uri");return void(i?(this._conn._changeConnectStatus(Strophe.Status.REDIRECT,"Received see-other-uri, resetting connection"),this._conn.reset(),this._conn.service=i,this._connect()):this._conn._doDisconnect("receive <close> from server"))}if(0===e.data.search("<open ")){if(t=(new DOMParser).parseFromString(e.data,"text/xml").documentElement,!this._handleStreamStart(t))return}else n=this._streamWrap(e.data),t=(new DOMParser).parseFromString(n,"text/xml").documentElement;if(!this._check_streamerror(t,Strophe.Status.ERROR))return this._conn.disconnecting&&"presence"===t.firstChild.nodeName&&"unavailable"===t.firstChild.getAttribute("type")?(this._conn.xmlInput(t),void this._conn.rawInput(Strophe.serialize(t))):void this._conn._dataRecv(t,e.data)};var _listenNetwork=function(e,t){window.addEventListener?(window.addEventListener("online",e),window.addEventListener("offline",t)):window.attachEvent&&(document.body?(document.body.attachEvent("ononline",e),document.body.attachEvent("onoffline",t)):window.attachEvent("load",function(){document.body.attachEvent("ononline",e),document.body.attachEvent("onoffline",t)}))},_parseRoom=function(e){var t=[],n=e.getElementsByTagName("item");if(n)for(var i=0;i<n.length;i++){var o=n[i],r=o.getAttribute("jid"),s=r.split("@")[0],a={jid:r,name:o.getAttribute("name"),roomId:s.split("_")[1]};t.push(a)}return t},_parseRoomOccupants=function(e){var t=[],n=e.getElementsByTagName("item");if(n)for(var i=0;i<n.length;i++){var o=n[i],r={jid:o.getAttribute("jid"),name:o.getAttribute("name")};t.push(r)}return t},_parseResponseMessage=function _parseResponseMessage(msginfo){var parseMsgData={errorMsg:!0,data:[]},msgBodies=msginfo.getElementsByTagName("body");if(msgBodies){for(var i=0;i<msgBodies.length;i++){var msgBody=msgBodies[i],childNodes=msgBody.childNodes;if(childNodes&&childNodes.length>0){var childNode=msgBody.childNodes[0];if(childNode.nodeType==Strophe.ElementType.TEXT){var jsondata=childNode.wholeText||childNode.nodeValue;jsondata=jsondata.replace("\n","<br>");try{var data=eval("("+jsondata+")");parseMsgData.errorMsg=!1,parseMsgData.data=[data]}catch(e){}}}}var delayTags=msginfo.getElementsByTagName("delay");if(delayTags&&delayTags.length>0){var delayTag=delayTags[0],delayMsgTime=delayTag.getAttribute("stamp");delayMsgTime&&(parseMsgData.delayTimeStamp=delayMsgTime)}}else{var childrens=msginfo.childNodes;if(childrens&&childrens.length>0){var child=msginfo.childNodes[0];if(child.nodeType==Strophe.ElementType.TEXT)try{var data=eval("("+child.nodeValue+")");parseMsgData.errorMsg=!1,parseMsgData.data=[data]}catch(e){}}}return parseMsgData},_parseNameFromJidFn=function(e,t){t=t||"";var n=e,i=n.indexOf("_");-1!==i&&(n=n.substring(i+1));var o=n.indexOf("@"+t);return-1!==o&&(n=n.substring(0,o)),n},_parseFriend=function(e,t,n){var i=[],o=e.getElementsByTagName("item");if(o)for(var r=0;r<o.length;r++){var s=o[r],a=s.getAttribute("jid");if(a){var c=s.getAttribute("subscription"),d={subscription:c,jid:a},l=s.getAttribute("ask");l&&(d.ask=l);var u=s.getAttribute("name");if(u)d.name=u;else{var p=_parseNameFromJidFn(a);d.name=p}var m=[];Strophe.forEachChild(s,"group",function(e){m.push(Strophe.getText(e))}),d.groups=m,i.push(d),t&&"from"==c&&t.subscribe({toJid:a}),t&&"to"==c&&t.subscribed({toJid:a})}}return i},_login=function(e,t){var n=e.access_token||"";if(""==n){_utils.stringify(e);return void t.onError({type:_code.WEBIM_CONNCTION_OPEN_USERGRID_ERROR,data:e})}t.context.accessToken=e.access_token,t.context.accessTokenExpires=e.expires_in;var i=null;i=t.isOpening()&&t.context.stropheConn?t.context.stropheConn:t.isOpened()&&t.context.stropheConn?t.getStrophe():t.getStrophe();var o=function(e,n){_loginCallback(e,n,t)};t.context.stropheConn=i,t.route?i.connect(t.context.jid,"$t$"+n,o,t.wait,t.hold,t.route):i.connect(t.context.jid,"$t$"+n,o,t.wait,t.hold)},_parseMessageType=function(e){var t="normal",n=e.getElementsByTagName("received");if(n&&n.length>0&&"urn:xmpp:receipts"===n[0].namespaceURI)t="received";else{var i=e.getElementsByTagName("invite");i&&i.length>0&&(t="invite")}return t},_handleMessageQueue=function(e){for(var t in _msgHash)_msgHash.hasOwnProperty(t)&&_msgHash[t].send(e)},_loginCallback=function(e,t,n){var i,o;if("conflict"===t&&(i=!0),e==Strophe.Status.CONNFAIL)o={type:_code.WEBIM_CONNCTION_SERVER_CLOSE_ERROR,msg:t,reconnect:!0},i&&(o.conflict=!0),n.onError(o);else if(e==Strophe.Status.ATTACHED||e==Strophe.Status.CONNECTED){n.autoReconnectNumTotal=0,n.intervalId=setInterval(function(){n.handelSendQueue()},200);var r=function(e){var t=_parseMessageType(e);return"received"===t?(n.handleReceivedMessage(e),!0):"invite"===t?(n.handleInviteMessage(e),!0):(n.handleMessage(e),!0)},s=function(e){return n.handlePresence(e),!0},a=function(e){return n.handlePing(e),!0},c=function(e){return n.handleIqRoster(e),!0},d=function(e){return n.handleIqPrivacy(e),!0},l=function(e){return n.handleIq(e),!0};n.addHandler(r,null,"message",null,null,null),n.addHandler(s,null,"presence",null,null,null),n.addHandler(a,"urn:xmpp:ping","iq","get",null,null),n.addHandler(c,"jabber:iq:roster","iq","set",null,null),n.addHandler(d,"jabber:iq:privacy","iq","set",null,null),n.addHandler(l,null,"iq",null,null,null),n.context.status=_code.STATUS_OPENED;var u=[_code.WEBIM_MESSAGE_REC_TEXT,_code.WEBIM_MESSAGE_REC_EMOJI];_utils.isCanDownLoadFile&&(u.push(_code.WEBIM_MESSAGE_REC_PHOTO),u.push(_code.WEBIM_MESSAGE_REC_AUDIO_FILE));var p=[_code.WEBIM_MESSAGE_SED_TEXT];_utils.isCanUploadFile&&(p.push(_code.WEBIM_MESSAGE_REC_PHOTO),p.push(_code.WEBIM_MESSAGE_REC_AUDIO_FILE)),n.notifyVersion(),n.retry&&_handleMessageQueue(n),n.heartBeat(),n.isAutoLogin&&n.setPresence(),n.onOpened({canReceive:u,canSend:p,accessToken:n.context.accessToken})}else if(e==Strophe.Status.DISCONNECTING)n.isOpened()&&(n.stopHeartBeat(),n.context.status=_code.STATUS_CLOSING,o={type:_code.WEBIM_CONNCTION_SERVER_CLOSE_ERROR,msg:t,reconnect:!0},i&&(o.conflict=!0),n.onError(o));else if(e==Strophe.Status.DISCONNECTED){if(n.isOpened()){if(n.autoReconnectNumTotal<n.autoReconnectNumMax)return void n.reconnect();o={type:_code.WEBIM_CONNCTION_DISCONNECTED},n.onError(o)}n.context.status=_code.STATUS_CLOSED,n.clear(),n.onClosed()}else e==Strophe.Status.AUTHFAIL?(o={type:_code.WEBIM_CONNCTION_AUTH_ERROR},i&&(o.conflict=!0),n.onError(o),n.clear()):e==Strophe.Status.ERROR&&(n.context.status=_code.STATUS_ERROR,o={type:_code.WEBIM_CONNCTION_SERVER_ERROR},i&&(o.conflict=!0),n.onError(o));n.context.status_now=e},_getJid=function(e,t){var n=e.toJid||"";if(""===n){var i=t.context.appKey||"",o=i+"_"+e.to+"@"+t.domain;e.resource&&(o=o+"/"+e.resource),n=o}return n},_getJidByName=function(e,t){var n={to:e};return _getJid(n,t)},_validCheck=function(e,t){if(e=e||{},""==e.user)return t.onError({type:_code.WEBIM_CONNCTION_USER_NOT_ASSIGN_ERROR}),!1;var n=e.user+""||"",i=e.appKey||"",o=i.split("#");if(2!==o.length)return t.onError({type:_code.WEBIM_CONNCTION_APPKEY_NOT_ASSIGN_ERROR}),!1;var r=o[0],s=o[1];if(!r)return t.onError({type:_code.WEBIM_CONNCTION_APPKEY_NOT_ASSIGN_ERROR}),!1;if(!s)return t.onError({type:_code.WEBIM_CONNCTION_APPKEY_NOT_ASSIGN_ERROR}),!1;var a=i+"_"+n.toLowerCase()+"@"+t.domain,c=e.resource||"webim";return t.isMultiLoginSessions&&(c+=n+(new Date).getTime()+Math.floor(1e6*Math.random().toFixed(6))),t.context.jid=a+"/"+c,t.context.userId=n,t.context.appKey=i,t.context.appName=s,t.context.orgName=r,!0},_getXmppUrl=function(e,t){if(/^(ws|http)s?:\/\/?/.test(e))return e;var n={prefix:"http",base:"://"+e,suffix:"/http-bind/"};return t&&_utils.isSupportWss?(n.prefix="wss",n.suffix="/ws/"):t?n.prefix="https":window.WebSocket&&(n.prefix="ws",n.suffix="/ws/"),n.prefix+n.base+n.suffix},connection=function e(t){if(!this instanceof e)return new e(t);var t=t||{};this.isHttpDNS=t.isHttpDNS||!1,this.isMultiLoginSessions=t.isMultiLoginSessions||!1,this.wait=t.wait||30,this.retry=t.retry||!1,this.https=t.https||"https:"===location.protocol,this.url=_getXmppUrl(t.url,this.https),this.hold=t.hold||1,this.route=t.route||null,this.domain=t.domain||"easemob.com",this.inactivity=t.inactivity||30,this.heartBeatWait=t.heartBeatWait||4500,this.maxRetries=t.maxRetries||5,this.isAutoLogin=t.isAutoLogin===!1?!1:!0,this.pollingTime=t.pollingTime||800,this.stropheConn=!1,this.autoReconnectNumMax=t.autoReconnectNumMax||0,this.autoReconnectNumTotal=0,this.autoReconnectInterval=t.autoReconnectInterval||0,this.context={status:_code.STATUS_INIT},this.sendQueue=new Queue,this.intervalId=null,this.apiUrl=t.apiUrl||"",this.isWindowSDK=t.isWindowSDK||!1,this.dnsArr=["https://rs.easemob.com","https://rsbak.easemob.com","http://182.92.174.78","http://112.126.66.111"],this.dnsIndex=0,this.dnsTotal=this.dnsArr.length,this.restHosts=null,this.restIndex=0,this.restTotal=0,this.xmppHosts=null,this.xmppIndex=0,this.xmppTotal=0};connection.prototype.registerUser=function(e){"https:"!=location.protocol&&this.isHttpDNS?(this.dnsIndex=0,this.getHttpDNS(e,"signup")):this.signup(e)},connection.prototype.handelSendQueue=function(){var e=this.sendQueue.pop();null!==e&&this.sendReceiptsMessage(e)},connection.prototype.listen=function(e){this.onOpened=e.onOpened||_utils.emptyfn,this.onClosed=e.onClosed||_utils.emptyfn,this.onTextMessage=e.onTextMessage||_utils.emptyfn,this.onEmojiMessage=e.onEmojiMessage||_utils.emptyfn,this.onPictureMessage=e.onPictureMessage||_utils.emptyfn,this.onAudioMessage=e.onAudioMessage||_utils.emptyfn,this.onVideoMessage=e.onVideoMessage||_utils.emptyfn,this.onFileMessage=e.onFileMessage||_utils.emptyfn,this.onLocationMessage=e.onLocationMessage||_utils.emptyfn,this.onCmdMessage=e.onCmdMessage||_utils.emptyfn,this.onPresence=e.onPresence||_utils.emptyfn,this.onRoster=e.onRoster||_utils.emptyfn,this.onError=e.onError||_utils.emptyfn,this.onReceivedMessage=e.onReceivedMessage||_utils.emptyfn,this.onInviteMessage=e.onInviteMessage||_utils.emptyfn,this.onOffline=e.onOffline||_utils.emptyfn,this.onOnline=e.onOnline||_utils.emptyfn,this.onConfirmPop=e.onConfirmPop||_utils.emptyfn,this.onUpdateMyGroupList=e.onUpdateMyGroupList||_utils.emptyfn,this.onUpdateMyRoster=e.onUpdateMyRoster||_utils.emptyfn,this.onBlacklistUpdate=e.onBlacklistUpdate||_utils.emptyfn,_listenNetwork(this.onOnline,this.onOffline)},connection.prototype.heartBeat=function(){var e=this,t=!/^ws|wss/.test(e.url)||/mobile/.test(navigator.userAgent);if(!this.heartBeatID&&t){var n={toJid:this.domain,type:"normal"};this.heartBeatID=setInterval(function(){e.ping(n)},this.heartBeatWait)}},connection.prototype.stopHeartBeat=function(){"number"==typeof this.heartBeatID&&(this.heartBeatID=clearInterval(this.heartBeatID))},connection.prototype.sendReceiptsMessage=function(e){var t=$msg({from:this.context.jid||"",to:this.domain,id:e.id||""}).c("received",{xmlns:"urn:xmpp:receipts",id:e.id||""});this.sendCommand(t.tree())},connection.prototype.cacheReceiptsMessage=function(e){this.sendQueue.push(e)},connection.prototype.getStrophe=function(){if("https:"!=location.protocol&&this.isHttpDNS){var e="",t=this.xmppHosts[this.xmppIndex],n=_utils.getXmlFirstChild(t,"domain"),i=_utils.getXmlFirstChild(t,"ip");if(i){e=i.textContent;var o=_utils.getXmlFirstChild(t,"port");"80"!=o.textContent&&(e+=":"+o.textContent)}else e=n.textContent;if(""!=e){var r=/(.+\/\/).+(\/.+)/;this.url=this.url.replace(r,"$1"+e+"$2")}}var s=new Strophe.Connection(this.url,{inactivity:this.inactivity,maxRetries:this.maxRetries,pollingTime:this.pollingTime});return s},connection.prototype.getHostsByTag=function(e,t){var n=_utils.getXmlFirstChild(e,t);if(!n)return console.log(t+" hosts error"),null;var i=n.getElementsByTagName("hosts");return 0==i.length?(console.log(t+" hosts error2"),null):i[0].getElementsByTagName("host")},connection.prototype.getRestFromHttpDNS=function(e,t){if(this.restIndex>this.restTotal)return void console.log("rest hosts all tried,quit");var n="",i=this.restHosts[this.restIndex],o=_utils.getXmlFirstChild(i,"domain"),r=_utils.getXmlFirstChild(i,"ip");if(r){var s=_utils.getXmlFirstChild(i,"port");n=("https:"===location.protocol?"https:":"http:")+"//"+r.textContent+":"+s.textContent}else n=("https:"===location.protocol?"https:":"http:")+"//"+o.textContent;""!=n&&(this.apiUrl=n,e.apiUrl=n),"login"==t?this.login(e):this.signup(e)},connection.prototype.getHttpDNS=function(e,t){if(this.restHosts)return void this.getRestFromHttpDNS(e,t);var n=this,i=function(i,o){i=(new DOMParser).parseFromString(i,"text/xml").documentElement;var r=n.getHostsByTag(i,"rest");if(!r)return void console.log("rest hosts error3");n.restHosts=r,n.restTotal=r.length;var s=n.getHostsByTag(i,"xmpp");return s?(n.xmppHosts=s,n.xmppTotal=s.length,void n.getRestFromHttpDNS(e,t)):void console.log("xmpp hosts error3")},o=function(i,o,r){console.log("getHttpDNS error",i,r),n.dnsIndex++,n.dnsIndex<n.dnsTotal&&n.getHttpDNS(e,t)},r={url:this.dnsArr[this.dnsIndex]+"/easemob/server.xml",dataType:"text",type:"GET",data:{app_key:encodeURIComponent(e.appKey)},success:i||_utils.emptyfn,error:o||_utils.emptyfn};_utils.ajax(r)},connection.prototype.signup=function(e){var t=this,n=e.orgName||"",i=e.appName||"",o=e.appKey||"",r=e.success||EMPTYFN,s=e.error||EMPTYFN;if(!n&&!i&&o){var a=o.split("#");2===a.length&&(n=a[0],i=a[1])}if(!n&&!i)return void s({type:_code.WEBIM_CONNCTION_APPKEY_NOT_ASSIGN_ERROR});var c=function(n,i,o){return"https:"!=location.protocol&&t.isHttpDNS&&t.restIndex+1<t.restTotal?(t.restIndex++,void t.getRestFromHttpDNS(e,"signup")):(t.clear(),void s(n))},d=e.https||d,l=e.apiUrl,u=l+"/"+n+"/"+i+"/users",p={username:e.username,password:e.password,nickname:e.nickname||""},m=_utils.stringify(p),h={url:u,dataType:"json",data:m,success:r,error:c};_utils.ajax(h)},connection.prototype.open=function(e){"https:"!=location.protocol&&this.isHttpDNS?(this.dnsIndex=0,this.getHttpDNS(e,"login")):this.login(e)},connection.prototype.login=function(e){var t=_validCheck(e,this);if(t){var n=this;if(!n.isOpened())if(e.accessToken)e.access_token=e.accessToken,_login(e,n);else{var i=e.apiUrl,o=this.context.userId,r=e.pwd||"",s=this.context.appName,a=this.context.orgName,c=function(e,t){n.context.status=_code.STATUS_DOLOGIN_IM,n.context.restTokenData=e,_login(e,n)},d=function(t,i,o){return"https:"!=location.protocol&&n.isHttpDNS&&n.restIndex+1<n.restTotal?(n.restIndex++,void n.getRestFromHttpDNS(e,"login")):(n.clear(),void(t.error&&t.error_description?n.onError({type:_code.WEBIM_CONNCTION_OPEN_USERGRID_ERROR,data:t,xhr:i}):n.onError({type:_code.WEBIM_CONNCTION_OPEN_ERROR,data:t,xhr:i})))};this.context.status=_code.STATUS_DOLOGIN_USERGRID;var l={grant_type:"password",username:o,password:r,timestamp:+new Date},u=_utils.stringify(l),p={url:i+"/"+a+"/"+s+"/token",dataType:"json",data:u,success:c||_utils.emptyfn,error:d||_utils.emptyfn};_utils.ajax(p)}}},connection.prototype.attach=function(e){var t=_validCheck(e,this);if(t){e=e||{};var n=e.accessToken||"";if(""==n)return void this.onError({type:_code.WEBIM_CONNCTION_TOKEN_NOT_ASSIGN_ERROR});var i=e.sid||"";if(""===i)return void this.onError({type:_code.WEBIM_CONNCTION_SESSIONID_NOT_ASSIGN_ERROR});var o=e.rid||"";if(""===o)return void this.onError({type:_code.WEBIM_CONNCTION_RID_NOT_ASSIGN_ERROR});var r=this.getStrophe();this.context.accessToken=n,this.context.stropheConn=r,this.context.status=_code.STATUS_DOLOGIN_IM;var s=this,a=function(e,t){_loginCallback(e,t,s)},c=this.context.jid,d=this.wait,l=this.hold,u=this.wind||5;r.attach(c,i,o,a,d,l,u)}},connection.prototype.close=function(e){this.stopHeartBeat();var t=this.context.status;t!=_code.STATUS_INIT&&(this.isClosed()||this.isClosing()||(this.context.status=_code.STATUS_CLOSING,this.context.stropheConn.disconnect(e)))},connection.prototype.addHandler=function(e,t,n,i,o,r,s){this.context.stropheConn.addHandler(e,t,n,i,o,r,s)},connection.prototype.notifyVersion=function(e,t){var n=(_getJid({},this),$iq({from:this.context.jid||"",to:this.domain,type:"result"}).c("query",{xmlns:"jabber:iq:version"}).c("name").t("easemob").up().c("version").t(_version).up().c("os").t("webim")),e=e||_utils.emptyfn,i=t||this.onError,o=function(e){i({type:_code.WEBIM_CONNCTION_NOTIFYVERSION_ERROR,data:e})};this.context.stropheConn.sendIQ(n.tree(),e,o)},connection.prototype.handlePresence=function(e){if(!this.isClosed()){var t=e.getAttribute("from")||"",n=e.getAttribute("to")||"",i=e.getAttribute("type")||"",o=e.getAttribute("presence_type")||"",r=_parseNameFromJidFn(t),s=_parseNameFromJidFn(n),a={from:r,to:s,fromJid:t,toJid:n,type:i,chatroom:e.getElementsByTagName("roomtype").length?!0:!1},c=e.getElementsByTagName("show");if(c&&c.length>0){var d=c[0];a.show=Strophe.getText(d)}var l=e.getElementsByTagName("status");if(l&&l.length>0){var u=l[0];a.status=Strophe.getText(u),a.code=u.getAttribute("code")}var p=e.getElementsByTagName("priority");if(p&&p.length>0){var m=p[0];a.priority=Strophe.getText(m)}var h=e.getElementsByTagName("error");if(h&&h.length>0){var h=h[0];a.error={code:h.getAttribute("code")}}var f=e.getElementsByTagName("destroy");if(f&&f.length>0){var f=f[0];a.destroy=!0;var g=f.getElementsByTagName("reason");g&&g.length>0&&(a.reason=Strophe.getText(g[0]))}var _=e.getElementsByTagName("item");if(_&&_.length>0){var v=_[0],y=v.getAttribute("role"),b=v.getAttribute("jid");if("none"==y&&b){var E=_parseNameFromJidFn(b),S=v.getElementsByTagName("actor")[0],T=S.getAttribute("nick");a.actor=T,a.kicked=E}"moderator"==y&&"201"==a.code&&(a.type="joinPublicGroupSuccess")}var C=e.getElementsByTagName("apply");if(C&&C.length>0){C=C[0];var I=C.getAttribute("toNick"),O=C.getAttribute("to"),R=C.getAttribute("from"),N=_parseNameFromJidFn(O);_parseNameFromJidFn(R);a.toNick=I,a.groupName=N,a.type="joinGroupNotifications";var g=C.getElementsByTagName("reason");g&&g.length>0&&(a.reason=Strophe.getText(g[0]))}if(a.chatroom){a.presence_type=o,a.original_type=a.type;var w=t.slice(t.lastIndexOf("/")+1);w===this.context.userId&&(""!==a.type||a.code?("unavailable"===o||"unavailable"===a.type)&&(a.status?110==a.code?a.type="leaveChatRoom":a.error&&406==a.error.code&&(a.type="reachChatRoomCapacity"):a.type="leaveChatRoom"):a.type="joinChatRoomSuccess")}else a.presence_type=o,a.original_type=i,/subscribe/.test(a.type)||(""!=i||a.status||a.error?("unavailable"===o||"unavailable"===i)&&(a.destroy?a.type="deleteGroupChat":(307==a.code||321==a.code)&&(a.type="leaveGroup")):a.type="joinPublicGroupSuccess");this.onPresence(a,e)}},connection.prototype.handlePing=function(e){if(!this.isClosed()){var t=e.getAttribute("id"),n=e.getAttribute("from"),i=e.getAttribute("to"),o=$iq({from:i,to:n,id:t,type:"result"});this.sendCommand(o.tree())}},connection.prototype.handleIq=function(e){return!0},connection.prototype.handleIqPrivacy=function(e){var t=e.getElementsByTagName("list");0!=t.length&&this.getBlacklist()},connection.prototype.handleIqRoster=function(e){var t=e.getAttribute("id"),n=e.getAttribute("from")||"",i=(_parseNameFromJidFn(n),this.context.jid),o=(this.context.userId,$iq({type:"result",id:t,from:i}));this.sendCommand(o.tree());var r=e.getElementsByTagName("query");if(r&&r.length>0){var s=r[0],a=_parseFriend(s,this,n);this.onRoster(a)}return!0},connection.prototype.handleMessage=function(e){var t=this;if(!this.isClosed()){var n=e.getAttribute("id")||"";this.cacheReceiptsMessage({id:n});var i=_parseResponseMessage(e);if(i.errorMsg)return void this.handlePresence(e);var o=e.getElementsByTagName("error"),r="",s="",a=!1;if(o.length>0){a=!0,r=o[0].getAttribute("code");var c=o[0].getElementsByTagName("text");s=c[0].textContent||c[0].text,log("handle error",r,s)}var d=i.data;for(var l in d)if(d.hasOwnProperty(l)){var u=d[l];if(u.from&&u.to){var p=(u.from+"").toLowerCase(),m=(u.to+"").toLowerCase(),h=u.ext||{},f="",g=e.getElementsByTagName("roomtype");f=g.length?g[0].getAttribute("type")||"chat":e.getAttribute("type")||"chat";var _=u.bodies;if(_&&0!=_.length){var v=u.bodies[0],y=v.type;try{switch(y){case"txt":var b=v.msg,E=_utils.parseTextMessage(b,WebIM.Emoji);if(E.isemoji){var u={id:n,type:f,from:p,to:m,delay:i.delayTimeStamp,data:E.body,ext:h};!u.delay&&delete u.delay,u.error=a,u.errorText=s,u.errorCode=r,this.onEmojiMessage(u)}else{
var u={id:n,type:f,from:p,to:m,delay:i.delayTimeStamp,data:b,ext:h};!u.delay&&delete u.delay,u.error=a,u.errorText=s,u.errorCode=r,this.onTextMessage(u)}break;case"img":var S=0,T=0;v.size&&(S=v.size.width,T=v.size.height);var u={id:n,type:f,from:p,to:m,url:"https:"!=location.protocol&&t.isHttpDNS?t.apiUrl+v.url.substr(v.url.indexOf("/",9)):v.url,secret:v.secret,filename:v.filename,thumb:v.thumb,thumb_secret:v.thumb_secret,file_length:v.file_length||"",width:S,height:T,filetype:v.filetype||"",accessToken:this.context.accessToken||"",ext:h,delay:i.delayTimeStamp};!u.delay&&delete u.delay,u.error=a,u.errorText=s,u.errorCode=r,this.onPictureMessage(u);break;case"audio":var u={id:n,type:f,from:p,to:m,url:"https:"!=location.protocol&&t.isHttpDNS?t.apiUrl+v.url.substr(v.url.indexOf("/",9)):v.url,secret:v.secret,filename:v.filename,length:v.length||"",file_length:v.file_length||"",filetype:v.filetype||"",accessToken:this.context.accessToken||"",ext:h,delay:i.delayTimeStamp};!u.delay&&delete u.delay,u.error=a,u.errorText=s,u.errorCode=r,this.onAudioMessage(u);break;case"file":var u={id:n,type:f,from:p,to:m,url:"https:"!=location.protocol&&t.isHttpDNS?t.apiUrl+v.url.substr(v.url.indexOf("/",9)):v.url,secret:v.secret,filename:v.filename,file_length:v.file_length,accessToken:this.context.accessToken||"",ext:h,delay:i.delayTimeStamp};!u.delay&&delete u.delay,u.error=a,u.errorText=s,u.errorCode=r,this.onFileMessage(u);break;case"loc":var u={id:n,type:f,from:p,to:m,addr:v.addr,lat:v.lat,lng:v.lng,ext:h,delay:i.delayTimeStamp};!u.delay&&delete u.delay,u.error=a,u.errorText=s,u.errorCode=r,this.onLocationMessage(u);break;case"video":var u={id:n,type:f,from:p,to:m,url:"https:"!=location.protocol&&t.isHttpDNS?t.apiUrl+v.url.substr(v.url.indexOf("/",9)):v.url,secret:v.secret,filename:v.filename,file_length:v.file_length,accessToken:this.context.accessToken||"",ext:h,delay:i.delayTimeStamp};!u.delay&&delete u.delay,u.error=a,u.errorText=s,u.errorCode=r,this.onVideoMessage(u);break;case"cmd":var u={id:n,from:p,to:m,action:v.action,ext:h,delay:i.delayTimeStamp};!u.delay&&delete u.delay,u.error=a,u.errorText=s,u.errorCode=r,this.onCmdMessage(u)}}catch(C){this.onError({type:_code.WEBIM_CONNCTION_CALLBACK_INNER_ERROR,data:C})}}}}}},connection.prototype.handleReceivedMessage=function(e){try{this.onReceivedMessage(e)}catch(t){this.onError({type:_code.WEBIM_CONNCTION_CALLBACK_INNER_ERROR,data:t})}var n,i,o=e.getElementsByTagName("received");if(o.length>0&&(n=o[0].childNodes&&o[0].childNodes.length>0?o[0].childNodes[0].nodeValue:o[0].innerHTML||o[0].innerText,i=o[0].getAttribute("mid")),_msgHash[n]){try{_msgHash[n].msg.success instanceof Function&&_msgHash[n].msg.success(n,i)}catch(t){this.onError({type:_code.WEBIM_CONNCTION_CALLBACK_INNER_ERROR,data:t})}delete _msgHash[n]}},connection.prototype.handleInviteMessage=function(e){var t=null,n=e.getElementsByTagName("invite"),i=e.getElementsByTagName("reason")[0],o=i.textContent,r=e.getAttribute("id")||"";if(this.sendReceiptsMessage({id:r}),n&&n.length>0){var s=n[0].getAttribute("from");t=_parseNameFromJidFn(s)}var a=e.getElementsByTagName("x"),c=null;if(a&&a.length>0)for(var d=0;d<a.length;d++)if("jabber:x:conference"===a[d].namespaceURI){var l=a[d].getAttribute("jid");c=_parseNameFromJidFn(l)}this.onInviteMessage({type:"invite",from:t,roomid:c,reason:o})},connection.prototype.sendCommand=function(e,t){this.isOpened()?this.context.stropheConn.send(e):this.onError({type:_code.WEBIM_CONNCTION_DISCONNECTED,reconnect:!0})},connection.prototype.getUniqueId=function(e){var t=new Date,n=new Date(2010,1,1),i=t.getTime()-n.getTime(),o=parseInt(i).toString(16);return"string"==typeof e||"number"==typeof e?e+"_"+o:"WEBIM_"+o},connection.prototype.send=function(e){var t=this;if(this.isWindowSDK)WebIM.doQuery('{"type":"sendMessage","to":"'+e.to+'","message_type":"'+e.type+'","msg":"'+encodeURI(e.msg)+'","chatType":"'+e.chatType+'"}',function(e){},function(e,n){var i={data:{data:"send"},type:_code.WEBIM_MESSAGE_SED_ERROR};t.onError(i)});else if("[object Object]"===Object.prototype.toString.call(e)){var n=this.context.appKey||"",i=n+"_"+e.to+"@"+this.domain;e.group&&(i=n+"_"+e.to+"@conference."+this.domain),e.resource&&(i=i+"/"+e.resource),e.toJid=i,e.id=e.id||this.getUniqueId(),_msgHash[e.id]=new _message(e),_msgHash[e.id].send(this)}else"string"==typeof e&&_msgHash[e]&&_msgHash[e].send(this)},connection.prototype.addRoster=function(e){var t=_getJid(e,this),n=e.name||"",i=e.groups||"",o=$iq({type:"set"});if(o.c("query",{xmlns:"jabber:iq:roster"}),o.c("item",{jid:t,name:n}),i)for(var r=0;r<i.length;r++)o.c("group").t(i[r]).up();var s=e.success||_utils.emptyfn,a=e.error||_utils.emptyfn;this.context.stropheConn.sendIQ(o.tree(),s,a)},connection.prototype.removeRoster=function(e){var t=_getJid(e,this),n=$iq({type:"set"}).c("query",{xmlns:"jabber:iq:roster"}).c("item",{jid:t,subscription:"remove"}),i=e.success||_utils.emptyfn,o=e.error||_utils.emptyfn;this.context.stropheConn.sendIQ(n,i,o)},connection.prototype.getRoster=function(e){var t=$iq({type:"get"}).c("query",{xmlns:"jabber:iq:roster"}),e=e||{},n=e.success||this.onRoster,i=function(e){var t=[],i=e.getElementsByTagName("query");if(i&&i.length>0){var o=i[0];t=_parseFriend(o)}n(t,e)},o=e.error||this.onError,r=function(e){o({type:_code.WEBIM_CONNCTION_GETROSTER_ERROR,data:e})};this.isOpened()?this.context.stropheConn.sendIQ(t.tree(),i,r):o({type:_code.WEBIM_CONNCTION_DISCONNECTED})},connection.prototype.subscribe=function(e){var t=_getJid(e,this),n=$pres({to:t,type:"subscribe"});e.message&&n.c("status").t(e.message).up(),e.nick&&n.c("nick",{xmlns:"http://jabber.org/protocol/nick"}).t(e.nick),this.sendCommand(n.tree())},connection.prototype.subscribed=function(e){var t=_getJid(e,this),n=$pres({to:t,type:"subscribed"});e.message&&n.c("status").t(e.message).up(),this.sendCommand(n.tree())},connection.prototype.unsubscribe=function(e){var t=_getJid(e,this),n=$pres({to:t,type:"unsubscribe"});e.message&&n.c("status").t(e.message),this.sendCommand(n.tree())},connection.prototype.unsubscribed=function(e){var t=_getJid(e,this),n=$pres({to:t,type:"unsubscribed"});e.message&&n.c("status").t(e.message).up(),this.sendCommand(n.tree())},connection.prototype.joinPublicGroup=function(e){var t=this.context.appKey+"_"+e.roomId+"@conference."+this.domain,n=t+"/"+this.context.userId,i=e.success||_utils.emptyfn,o=e.error||_utils.emptyfn,r=function(e){o({type:_code.WEBIM_CONNCTION_JOINROOM_ERROR,data:e})},s=$pres({from:this.context.jid,to:n}).c("x",{xmlns:Strophe.NS.MUC});this.context.stropheConn.sendIQ(s.tree(),i,r)},connection.prototype.listRooms=function(e){var t=$iq({to:e.server||"conference."+this.domain,from:this.context.jid,type:"get"}).c("query",{xmlns:Strophe.NS.DISCO_ITEMS}),n=e.success||_utils.emptyfn,i=e.error||this.onError,o=function(e){var t=[];t=_parseRoom(e);try{n(t)}catch(o){i({type:_code.WEBIM_CONNCTION_GETROOM_ERROR,data:o})}},r=e.error||_utils.emptyfn,s=function(e){r({type:_code.WEBIM_CONNCTION_GETROOM_ERROR,data:e})};this.context.stropheConn.sendIQ(t.tree(),o,s)},connection.prototype.queryRoomMember=function(e){var t=(this.domain,[]),n=$iq({to:this.context.appKey+"_"+e.roomId+"@conference."+this.domain,type:"get"}).c("query",{xmlns:Strophe.NS.MUC+"#admin"}).c("item",{affiliation:"member"}),i=e.success||_utils.emptyfn,o=function(e){var n=e.getElementsByTagName("item");if(n)for(var o=0;o<n.length;o++){var r=n[o],s={jid:r.getAttribute("jid"),affiliation:"member"};t.push(s)}i(t)},r=e.error||_utils.emptyfn,s=function(e){r({type:_code.WEBIM_CONNCTION_GETROOMMEMBER_ERROR,data:e})};this.context.stropheConn.sendIQ(n.tree(),o,s)},connection.prototype.queryRoomInfo=function(e){var t=this.domain,n=$iq({to:this.context.appKey+"_"+e.roomId+"@conference."+t,type:"get"}).c("query",{xmlns:Strophe.NS.DISCO_INFO}),i=e.success||_utils.emptyfn,o=[],r=function(e){var n="",r=e.getElementsByTagName("feature");switch(r&&(n=r[1].getAttribute("var")+"|"+r[3].getAttribute("var")+"|"+r[4].getAttribute("var")),n){case"muc_public|muc_membersonly|muc_notallowinvites":n="PUBLIC_JOIN_APPROVAL";break;case"muc_public|muc_open|muc_notallowinvites":n="PUBLIC_JOIN_OPEN";break;case"muc_hidden|muc_membersonly|muc_allowinvites":n="PRIVATE_MEMBER_INVITE";break;case"muc_hidden|muc_membersonly|muc_notallowinvites":n="PRIVATE_OWNER_INVITE"}var s=e.getElementsByTagName("field"),a={};if(s){for(var c=0;c<s.length;c++){var d=s[c],l=d.getAttribute("var"),u=l.split("_")[1];switch(l){case"muc#roominfo_occupants":case"muc#roominfo_maxusers":case"muc#roominfo_affiliations":case"muc#roominfo_description":a[u]=d.textContent||d.text||"";break;case"muc#roominfo_owner":var p={jid:(d.textContent||d.text)+"@"+t,affiliation:"owner"};o.push(p),a[u]=d.textContent||d.text}}a.name=e.getElementsByTagName("identity")[0].getAttribute("name")}log(n,o,a),i(n,o,a)},s=e.error||_utils.emptyfn,a=function(e){s({type:_code.WEBIM_CONNCTION_GETROOMINFO_ERROR,data:e})};this.context.stropheConn.sendIQ(n.tree(),r,a)},connection.prototype.queryRoomOccupants=function(e){var t=e.success||_utils.emptyfn,n=function(e){var n=[];n=_parseRoomOccupants(e),t(n)},i=e.error||_utils.emptyfn,o=function(e){i({type:_code.WEBIM_CONNCTION_GETROOMOCCUPANTS_ERROR,data:e})},r={xmlns:Strophe.NS.DISCO_ITEMS},s=$iq({from:this.context.jid,to:this.context.appKey+"_"+e.roomId+"@conference."+this.domain,type:"get"}).c("query",r);this.context.stropheConn.sendIQ(s.tree(),n,o)},connection.prototype.setUserSig=function(e){var t=$pres({xmlns:"jabber:client"});e=e||"",t.c("status").t(e),this.sendCommand(t.tree())},connection.prototype.setPresence=function(e,t){var n=$pres({xmlns:"jabber:client"});e&&(t?(n.c("show").t(e),n.up().c("status").t(t)):n.c("show").t(e)),this.sendCommand(n.tree())},connection.prototype.getPresence=function(){var e=$pres({xmlns:"jabber:client"});this.sendCommand(e.tree())},connection.prototype.ping=function(e){var e=e||{},t=_getJid(e,this),n=$iq({from:this.context.jid||"",to:t,type:"get"}).c("ping",{xmlns:"urn:xmpp:ping"}),i=e.success||_utils.emptyfn,o=e.error||this.onError,r=function(e){o({type:_code.WEBIM_CONNCTION_PING_ERROR,data:e})};this.isOpened()?this.context.stropheConn.sendIQ(n.tree(),i,r):o({type:_code.WEBIM_CONNCTION_DISCONNECTED})},connection.prototype.isOpened=function(){return this.context.status==_code.STATUS_OPENED},connection.prototype.isOpening=function(){var e=this.context.status;return e==_code.STATUS_DOLOGIN_USERGRID||e==_code.STATUS_DOLOGIN_IM},connection.prototype.isClosing=function(){return this.context.status==_code.STATUS_CLOSING},connection.prototype.isClosed=function(){return this.context.status==_code.STATUS_CLOSED},connection.prototype.clear=function(){var e=this.context.appKey;if(this.errorType!=_code.WEBIM_CONNCTION_DISCONNECTED&&(this.context={status:_code.STATUS_INIT,appKey:e}),this.intervalId&&clearInterval(this.intervalId),this.restIndex=0,this.xmppIndex=0,this.errorType==_code.WEBIM_CONNCTION_CLIENT_LOGOUT||-1==this.errorType){var t={data:{data:"clear"},type:_code.WEBIM_CONNCTION_CLIENT_LOGOUT};this.onError(t)}},connection.prototype.getChatRooms=function(e){if(!_utils.isCanSetRequestHeader)return void t.onError({type:_code.WEBIM_CONNCTION_NOT_SUPPORT_CHATROOM_ERROR});var t=this,n=e.accessToken||this.context.accessToken;if(n){var i=e.apiUrl,o=this.context.appName,r=this.context.orgName;if(!o||!r)return void t.onError({type:_code.WEBIM_CONNCTION_AUTH_ERROR});var s=function(t,n){"function"==typeof e.success&&e.success(t)},a=function(e,n,i){e.error&&e.error_description&&t.onError({type:_code.WEBIM_CONNCTION_LOAD_CHATROOM_ERROR,msg:e.error_description,data:e,xhr:n})},c={pagenum:parseInt(e.pagenum)||1,pagesize:parseInt(e.pagesize)||20},d={url:i+"/"+r+"/"+o+"/chatrooms",dataType:"json",type:"GET",headers:{Authorization:"Bearer "+n},data:c,success:s||_utils.emptyfn,error:a||_utils.emptyfn};_utils.ajax(d)}else t.onError({type:_code.WEBIM_CONNCTION_TOKEN_NOT_ASSIGN_ERROR})},connection.prototype.joinChatRoom=function(e){var t=this.context.appKey+"_"+e.roomId+"@conference."+this.domain,n=t+"/"+this.context.userId,i=e.success||_utils.emptyfn,o=e.error||_utils.emptyfn,r=function(e){o({type:_code.WEBIM_CONNCTION_JOINCHATROOM_ERROR,data:e})},s=$pres({from:this.context.jid,to:n}).c("x",{xmlns:Strophe.NS.MUC+"#user"}).c("item",{affiliation:"member",role:"participant"}).up().up().c("roomtype",{xmlns:"easemob:x:roomtype",type:"chatroom"});this.context.stropheConn.sendIQ(s.tree(),i,r)},connection.prototype.quitChatRoom=function(e){var t=this.context.appKey+"_"+e.roomId+"@conference."+this.domain,n=t+"/"+this.context.userId,i=e.success||_utils.emptyfn,o=e.error||_utils.emptyfn,r=function(e){o({type:_code.WEBIM_CONNCTION_QUITCHATROOM_ERROR,data:e})},s=$pres({from:this.context.jid,to:n,type:"unavailable"}).c("x",{xmlns:Strophe.NS.MUC+"#user"}).c("item",{affiliation:"none",role:"none"}).up().up().c("roomtype",{xmlns:"easemob:x:roomtype",type:"chatroom"});this.context.stropheConn.sendIQ(s.tree(),i,r)},connection.prototype._onReceiveInviteFromGroup=function(info){info=eval("("+info+")");var self=this,options={title:"Group invitation",msg:info.user+" invites you to join into group:"+info.group_id,agree:function(){WebIM.doQuery('{"type":"acceptInvitationFromGroup","id":"'+info.group_id+'","user":"'+info.user+'"}',function(e){},function(e,t){var n={data:{data:"acceptInvitationFromGroup error:"+t},type:_code.WEBIM_CONNECTION_ACCEPT_INVITATION_FROM_GROUP};self.onError(n)})},reject:function(){WebIM.doQuery('{"type":"declineInvitationFromGroup","id":"'+info.group_id+'","user":"'+info.user+'"}',function(e){},function(e,t){var n={data:{data:"declineInvitationFromGroup error:"+t},type:_code.WEBIM_CONNECTION_DECLINE_INVITATION_FROM_GROUP};self.onError(n)})}};this.onConfirmPop(options)},connection.prototype._onReceiveInviteAcceptionFromGroup=function(info){info=eval("("+info+")");var options={title:"Group invitation response",msg:info.user+" agreed to join into group:"+info.group_id,agree:function(){}};this.onConfirmPop(options)},connection.prototype._onReceiveInviteDeclineFromGroup=function(info){info=eval("("+info+")");var options={title:"Group invitation response",msg:info.user+" rejected to join into group:"+info.group_id,agree:function(){}};this.onConfirmPop(options)},connection.prototype._onAutoAcceptInvitationFromGroup=function(info){info=eval("("+info+")");var options={title:"Group invitation",msg:"You had joined into the group:"+info.group_name+" automatically.Inviter:"+info.user,agree:function(){}};this.onConfirmPop(options)},connection.prototype._onLeaveGroup=function(info){info=eval("("+info+")");var options={title:"Group notification",msg:"You have been out of the group:"+info.group_id+".Reason:"+info.msg,agree:function(){}};this.onConfirmPop(options)},connection.prototype._onReceiveJoinGroupApplication=function(info){info=eval("("+info+")");var self=this,options={title:"Group join application",msg:info.user+" applys to join into group:"+info.group_id,agree:function(){WebIM.doQuery('{"type":"acceptJoinGroupApplication","id":"'+info.group_id+'","user":"'+info.user+'"}',function(e){},function(e,t){var n={data:{data:"acceptJoinGroupApplication error:"+t},type:_code.WEBIM_CONNECTION_ACCEPT_JOIN_GROUP};self.onError(n)})},reject:function(){WebIM.doQuery('{"type":"declineJoinGroupApplication","id":"'+info.group_id+'","user":"'+info.user+'"}',function(e){},function(e,t){var n={data:{data:"declineJoinGroupApplication error:"+t},type:_code.WEBIM_CONNECTION_DECLINE_JOIN_GROUP};self.onError(n)})}};this.onConfirmPop(options)},connection.prototype._onReceiveAcceptionFromGroup=function(info){info=eval("("+info+")");var options={title:"Group notification",msg:"You had joined into the group:"+info.group_name+".",agree:function(){}};this.onConfirmPop(options)},connection.prototype._onReceiveRejectionFromGroup=function(){info=eval("("+info+")");var options={title:"Group notification",msg:"You have been rejected to join into the group:"+info.group_name+".",agree:function(){}};this.onConfirmPop(options)},connection.prototype._onUpdateMyGroupList=function(e){this.onUpdateMyGroupList(e)},connection.prototype._onUpdateMyRoster=function(e){this.onUpdateMyRoster(e)},connection.prototype.reconnect=function(){console.log("reconnect");var e=this;setTimeout(function(){_login(e.context.restTokenData,e)},1e3*(0==this.autoReconnectNumTotal?0:this.autoReconnectInterval)),this.autoReconnectNumTotal++},connection.prototype.closed=function(){var e={data:{data:"Closed error"},type:_code.WEBIM_CONNECTION_CLOSED};this.onError(e)},connection.prototype.getBlacklist=function(e){e=e||{};var t=$iq({type:"get"}),n=e.success||_utils.emptyfn,i=e.error||_utils.emptyfn,o=this;t.c("query",{xmlns:"jabber:iq:privacy"}).c("list",{name:"special"}),this.context.stropheConn.sendIQ(t.tree(),function(e){o.onBlacklistUpdate(_parsePrivacy(e)),n()},function(){o.onBlacklistUpdate([]),i()})},connection.prototype.addToBlackList=function(e){for(var t=$iq({type:"set"}),n=e.list||{},i=e.type||"jid",o=e.success||_utils.emptyfn,r=e.error||_utils.emptyfn,s=t.c("query",{xmlns:"jabber:iq:privacy"}).c("list",{name:"special"}),a=Object.keys(n),c=a.length,d=2,l=0;c>l;l++){var u=n[a[l]],i=u.type||"jid",p=u.jid;s=s.c("item",{action:"deny",order:d++,type:i,value:p}).c("message"),l!==c-1&&(s=s.up().up())}this.context.stropheConn.sendIQ(s.tree(),o,r)},connection.prototype.removeFromBlackList=function(e){for(var t=$iq({type:"set"}),n=e.list||{},i=e.success||_utils.emptyfn,o=e.error||_utils.emptyfn,r=t.c("query",{xmlns:"jabber:iq:privacy"}).c("list",{name:"special"}),s=Object.keys(n),a=s.length,c=0;a>c;c++){var d=n[s[c]],l=d.type||"jid",u=d.jid,p=d.order;r=r.c("item",{action:"deny",order:p,type:l,value:u}).c("message"),c!==a-1&&(r=r.up().up())}this.context.stropheConn.sendIQ(r.tree(),i,o)},connection.prototype._getGroupJid=function(e){var t=this.context.appKey||"";return t+"_"+e+"@conference."+this.domain},connection.prototype.addToGroupBlackList=function(e){var t=e.success||_utils.emptyfn,n=e.error||_utils.emptyfn,i=_getJid(e,this),o="admin",r=this._getGroupJid(e.roomId),s=$iq({type:"set",to:r});s.c("query",{xmlns:"http://jabber.org/protocol/muc#"+o}).c("item",{affiliation:"outcast",jid:i}),this.context.stropheConn.sendIQ(s.tree(),t,n)},connection.prototype.getGroupBlacklist=function(e){var t=e.success||_utils.emptyfn,n=e.error||_utils.emptyfn,i="admin",o=this._getGroupJid(e.roomId),r=$iq({type:"get",to:o});r.c("query",{xmlns:"http://jabber.org/protocol/muc#"+i}).c("item",{affiliation:"outcast"}),this.context.stropheConn.sendIQ(r.tree(),function(e){log("getGroupBlackList"),t(_parseGroupBlacklist(e))},function(){n()})},connection.prototype.removeGroupMemberFromBlacklist=function(e){var t=e.success||_utils.emptyfn,n=e.error||_utils.emptyfn,i=_getJid(e,this),o="admin",r=this._getGroupJid(e.roomId),s=$iq({type:"set",to:r});s.c("query",{xmlns:"http://jabber.org/protocol/muc#"+o}).c("item",{affiliation:"member",jid:i}),this.context.stropheConn.sendIQ(s.tree(),function(e){t()},function(){n()})},connection.prototype.changeGroupSubject=function(e){var t=e.success||_utils.emptyfn,n=e.error||_utils.emptyfn,i="owner",o=this._getGroupJid(e.roomId),r=$iq({type:"set",to:o});r.c("query",{xmlns:"http://jabber.org/protocol/muc#"+i}).c("x",{type:"submit",xmlns:"jabber:x:data"}).c("field",{"var":"FORM_TYPE"}).c("value").t("http://jabber.org/protocol/muc#roomconfig").up().up().c("field",{"var":"muc#roomconfig_roomname"}).c("value").t(e.subject).up().up().c("field",{"var":"muc#roomconfig_roomdesc"}).c("value").t(e.description),this.context.stropheConn.sendIQ(r.tree(),function(e){t()},function(){n()})},connection.prototype.destroyGroup=function(e){var t=e.success||_utils.emptyfn,n=e.error||_utils.emptyfn,i="owner",o=this._getGroupJid(e.roomId),r=$iq({type:"set",to:o});r.c("query",{xmlns:"http://jabber.org/protocol/muc#"+i}).c("destroy").c("reason").t(e.reason||""),this.context.stropheConn.sendIQ(r.tree(),function(e){t()},function(){n()})},connection.prototype.leaveGroupBySelf=function(e){var t=e.success||_utils.emptyfn,n=e.error||_utils.emptyfn,i=_getJid(e,this),o="admin",r=this._getGroupJid(e.roomId),s=$iq({type:"set",to:r});s.c("query",{xmlns:"http://jabber.org/protocol/muc#"+o}).c("item",{affiliation:"none",jid:i}),this.context.stropheConn.sendIQ(s.tree(),function(e){t(e)},function(e){n(e)})},connection.prototype.leaveGroup=function(e){for(var t=e.success||_utils.emptyfn,n=e.error||_utils.emptyfn,i=e.list||[],o="admin",r=this._getGroupJid(e.roomId),s=$iq({type:"set",to:r}),a=s.c("query",{xmlns:"http://jabber.org/protocol/muc#"+o}),c=Object.keys(i),d=c.length,l=0;d>l;l++){var u=i[c[l]],p=_getJidByName(u,this);a=a.c("item",{affiliation:"none",jid:p}).up().c("item",{role:"none",jid:p}).up()}this.context.stropheConn.sendIQ(s.tree(),function(e){t(e)},function(e){n(e)})},connection.prototype.addGroupMembers=function(e){for(var t=e.success||_utils.emptyfn,n=e.error||_utils.emptyfn,i=e.list||[],o="admin",r=this._getGroupJid(e.roomId),s=$iq({type:"set",to:r}),a=s.c("query",{xmlns:"http://jabber.org/protocol/muc#"+o}),c=i.length,d=0;c>d;d++){var l=i[d],u=_getJidByName(l,this);a=a.c("item",{affiliation:"member",jid:u}).up();var p=$msg({to:r}).c("x",{xmlns:"http://jabber.org/protocol/muc#user"}).c("invite",{to:u}).c("reason").t(e.reason||"");this.sendCommand(p.tree())}this.context.stropheConn.sendIQ(s.tree(),function(e){t(e)},function(e){n(e)})},connection.prototype.acceptInviteFromGroup=function(e){e.success=function(){},this.addGroupMembers(e)},connection.prototype.rejectInviteFromGroup=function(e){},connection.prototype.createGroup=function(e){var t=+new Date,n=this._getGroupJid(t),i=n+"/"+this.context.userId,o=$pres({to:i}).c("x",{xmlns:"http://jabber.org/protocol/muc"}).up().c("create",{xmlns:"http://jabber.org/protocol/muc"}).up();this.sendCommand(o.tree());var r=this;setTimeout(function(){var i=$iq({type:"get",to:n}).c("query",{xmlns:"http://jabber.org/protocol/muc#owner"});r.context.stropheConn.sendIQ(i.tree(),function(i){if("setAttribute"in i){var o=i.getElementsByTagName("x")[0];o.setAttribute("type","submit")}else Strophe.forEachChild(i,"x",function(e){e.setAttribute("type","submit")});Strophe.info("step 5 ----------"),Strophe.forEachChild(o,"field",function(t){var n=t.getAttribute("var"),i=t.getElementsByTagName("value")[0];switch(Strophe.info(n),n){case"muc#roomconfig_roomname":_setText(i,e.subject||"");break;case"muc#roomconfig_roomdesc":_setText(i,e.description||"");break;case"muc#roomconfig_publicroom":_setText(i,+e.optionsPublic);break;case"muc#roomconfig_membersonly":_setText(i,+e.optionsMembersOnly);break;case"muc#roomconfig_moderatedroom":_setText(i,+e.optionsModerate);break;case"muc#roomconfig_persistentroom":_setText(i,1);break;case"muc#roomconfig_allowinvites":_setText(i,+e.optionsAllowInvites);break;case"muc#roomconfig_allowvisitornickchange":_setText(i,0);break;case"muc#roomconfig_allowvisitorstatus":_setText(i,0);break;case"allow_private_messages":_setText(i,0);break;case"allow_private_messages_from_visitors":_setText(i,"nobody")}});var s=$iq({to:n,type:"set"}).c("query",{xmlns:"http://jabber.org/protocol/muc#owner"}).cnode(o);r.context.stropheConn.sendIQ(s.tree(),function(n){r.addGroupMembers({list:e.members,roomId:t})},function(e){})},function(e){})},1e3)};var WebIM=window.WebIM||{};WebIM.connection=connection,WebIM.utils=_utils,WebIM.statusCode=_code,WebIM.message=_msg.message,WebIM.doQuery=function(e,t,n){"undefined"!=typeof window.cefQuery&&window.cefQuery({request:e,persistent:!1,onSuccess:t,onFailure:n})},module.exports=WebIM},232:function(e,t,n){"use strict";!function(){var e=n(223).utils,i=function r(e,t){return!this instanceof r?new r(e):(this._msg={},"function"==typeof r[e]&&(r[e].prototype.setGroup=this.setGroup,this._msg=new r[e](t)),this._msg)};i.prototype.setGroup=function(e){this.body.group=e},i.txt=function(e){this.id=e,this.type="txt",this.body={}},i.txt.prototype.set=function(e){this.value=e.msg,this.body={id:this.id,to:e.to,msg:this.value,type:this.type,roomType:e.roomType,ext:e.ext||{},success:e.success,fail:e.fail},!e.roomType&&delete this.body.roomType},i.cmd=function(e){this.id=e,this.type="cmd",this.body={}},i.cmd.prototype.set=function(e){this.value="",this.body={to:e.to,action:e.action,msg:this.value,type:this.type,roomType:e.roomType,ext:e.ext||{},success:e.success},!e.roomType&&delete this.body.roomType},i.location=function(e){this.id=e,this.type="loc",this.body={}},i.location.prototype.set=function(e){this.body={to:e.to,type:this.type,roomType:e.roomType,addr:e.addr,lat:e.lat,lng:e.lng,ext:e.ext||{}}},i.img=function(e){this.id=e,this.type="img",this.body={}},i.img.prototype.set=function(t){t.file=t.file||e.getFileUrl(t.fileInputId),this.value=t.file,this.body={id:this.id,file:this.value,apiUrl:t.apiUrl,to:t.to,type:this.type,ext:t.ext||{},roomType:t.roomType,onFileUploadError:t.onFileUploadError,onFileUploadComplete:t.onFileUploadComplete,success:t.success,fail:t.fail,flashUpload:t.flashUpload,width:t.width,height:t.height,body:t.body,uploadError:t.uploadError,uploadComplete:t.uploadComplete},!t.roomType&&delete this.body.roomType},i.audio=function(e){this.id=e,this.type="audio",this.body={}},i.audio.prototype.set=function(t){t.file=t.file||e.getFileUrl(t.fileInputId),this.value=t.file,this.filename=t.filename||this.value.filename,this.body={id:this.id,file:this.value,filename:this.filename,apiUrl:t.apiUrl,to:t.to,type:this.type,ext:t.ext||{},length:t.length||0,roomType:t.roomType,file_length:t.file_length,onFileUploadError:t.onFileUploadError,onFileUploadComplete:t.onFileUploadComplete,success:t.success,fail:t.fail,flashUpload:t.flashUpload,body:t.body},!t.roomType&&delete this.body.roomType},i.file=function(e){this.id=e,this.type="file",this.body={}},i.file.prototype.set=function(t){t.file=t.file||e.getFileUrl(t.fileInputId),this.value=t.file,this.filename=t.filename||this.value.filename,this.body={id:this.id,file:this.value,filename:this.filename,apiUrl:t.apiUrl,to:t.to,type:this.type,ext:t.ext||{},roomType:t.roomType,onFileUploadError:t.onFileUploadError,onFileUploadComplete:t.onFileUploadComplete,success:t.success,fail:t.fail,flashUpload:t.flashUpload,body:t.body},!t.roomType&&delete this.body.roomType},i.video=function(e){},i.video.prototype.set=function(e){};var o=function s(e){return!this instanceof s?new s(e,conn):void(this.msg=e)};o.prototype.send=function(t){var n=this,i=function(n){n.ext=n.ext||{},n.ext.weichat=n.ext.weichat||{},n.ext.weichat.originType=n.ext.weichat.originType||"webim";var i={from:t.context.userId||"",to:n.to,bodies:[n.body],ext:n.ext||{}},o=e.stringify(i),r=$msg({type:n.group||"chat",to:n.toJid,id:n.id,xmlns:"jabber:client"}).c("body").t(o);n.roomType&&r.up().c("roomtype",{xmlns:"easemob:x:roomtype",type:"chatroom"}),setTimeout(function(){"undefined"!=typeof _msgHash&&_msgHash[n.id]&&_msgHash[n.id].msg.fail instanceof Function&&_msgHash[n.id].msg.fail(n.id)},6e4),t.sendCommand(r.tree(),n.id)};if(n.msg.file){if(n.msg.body&&n.msg.body.url)return void i(n.msg);var o=n.msg.onFileUploadComplete,r=function(e){if(e.entities[0]["file-metadata"]){var r=e.entities[0]["file-metadata"]["content-length"];n.msg.file_length=r,n.msg.filetype=e.entities[0]["file-metadata"]["content-type"],r>204800&&(n.msg.thumbnail=!0)}n.msg.body={type:n.msg.type||"file",url:("https:"!=location.protocol&&t.isHttpDNS?t.apiUrl+e.uri.substr(e.uri.indexOf("/",9)):e.uri)+"/"+e.entities[0].uuid,secret:e.entities[0]["share-secret"],filename:n.msg.file.filename||n.msg.filename,size:{width:n.msg.width||0,height:n.msg.height||0},length:n.msg.length||0,file_length:n.msg.file_length||0,filetype:n.msg.filetype},i(n.msg),o instanceof Function&&o(e,n.msg.id)};n.msg.onFileUploadComplete=r,e.uploadFile.call(t,n.msg)}else n.msg.body={type:"chat"===n.msg.type?"txt":n.msg.type,msg:n.msg.msg},"cmd"===n.msg.type?n.msg.body.action=n.msg.action:"loc"===n.msg.type&&(n.msg.body.addr=n.msg.addr,n.msg.body.lat=n.msg.lat,n.msg.body.lng=n.msg.lng),i(n.msg)},t._msg=o,t.message=i}()},233:function(e,t){"use strict";!function(){function e(e){this.array=void 0===e?[]:new Array(e)}e.prototype={length:function(){return this.array.length},at:function(e){return this.array[e]},set:function(e,t){this.array[e]=t},push:function(e){return this.array.push(e)},slice:function(e,t){return this.array=this.array.slice(e,t)},concat:function(e){this.array=this.array.concat(e)},remove:function(e,t){t=void 0===t?1:t,this.array.splice(e,t)},join:function(e){return this.array.join(e)},clear:function(){this.array.length=0}};var n=function(){this._array_h=new e};n.prototype={_index:0,push:function(e){this._array_h.push(e)},pop:function(){var e=null;return this._array_h.length()&&(e=this._array_h.at(this._index),2*++this._index>=this._array_h.length()&&(this._array_h.slice(this._index),this._index=0)),e},head:function(){var e=null,t=this._array_h.length();return t&&(e=this._array_h.at(t-1)),e},tail:function(){var e=null,t=this._array_h.length();return t&&(e=this._array_h.at(this._index)),e},length:function(){return this._array_h.length()-this._index},empty:function(){return 0===this._array_h.length()},clear:function(){this._array_h.clear()}},t.Queue=n}()}}),function(window,undefined){if("undefined"==typeof Strophe)throw"need Strophe";var Easemob=Easemob||{};Easemob.im=Easemob.im||{},Easemob.im.version="1.1.1";var https="https:"===location.protocol;window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL,Strophe.Websocket.prototype._closeSocket=function(){var e=this;e.socket?setTimeout(function(){try{e.socket.close()}catch(t){}},0):e.socket=null};var Utils=function(){var e=function(){try{return new window.XMLHttpRequest}catch(e){return!1}},t=function(){try{return new window.ActiveXObject("Microsoft.XMLHTTP")}catch(e){return!1}};Strophe.Request.prototype._newXHR=function(){var e=Utils.xmlrequest(!0);return e.overrideMimeType&&e.overrideMimeType("text/xml"),e.onreadystatechange=this.func.stropheBind(null,this),e};var n=function(n){n=n||!0;var i=e()||t();if("withCredentials"in i)return i;if(!n)return i;if("undefined"==typeof window.XDomainRequest)return i;var o=new XDomainRequest;return o.readyState=0,o.status=100,o.onreadystatechange=EMPTYFN,o.onload=function(){o.readyState=4,o.status=200;var e=new ActiveXObject("Microsoft.XMLDOM");e.async="false",e.loadXML(o.responseText),o.responseXML=e,o.response=o.responseText,o.onreadystatechange()},o.ontimeout=o.onerror=function(){o.readyState=4,o.status=500,o.onreadystatechange()},o},i=function(){if("ActiveXObject"in window)try{return new ActiveXObject("ShockwaveFlash.ShockwaveFlash")}catch(e){return 0}else if(navigator.plugins&&navigator.plugins.length>0)return navigator.plugins["Shockwave Flash"];return 0}(),o=n(),r="undefined"!=typeof FormData,s="undefined"!=typeof Blob,a=o.setRequestHeader||!1,c=o.overrideMimeType||!1,d=a&&r,l=d||i,u=a&&(s||c);return{hasFormData:r,hasBlob:s,isCanSetRequestHeader:a,hasOverrideMimeType:c,isCanUploadFileAsync:d,isCanUploadFile:l,isCanDownLoadFile:u,isSupportWss:function(){var e=[/MQQBrowser[\/]5([.]\d+)?\sTBS/];if(!window.WebSocket)return!1;for(var t=window.navigator.userAgent,n=0,i=e.length;i>n;n++)if(e[n].test(t))return!1;return!0}(),stringify:function(e){if("undefined"!=typeof JSON&&JSON.stringify)return JSON.stringify(e);var t="",n=[],i=function(e){var o=!1;"[object Array]"===Object.prototype.toString.call(e)?(n.push("]","["),o=!0):"[object Object]"===Object.prototype.toString.call(e)&&n.push("}","{");for(var r in e)"[object Null]"===Object.prototype.toString.call(e[r])?e[r]="null":"[object Undefined]"===Object.prototype.toString.call(e[r])&&(e[r]="undefined"),t+=e[r]&&"object"==typeof e[r]?","+(o?"":'"'+r+'":'+(o?'"':""))+i(e[r]):',"'+(o?"":r+'":"')+e[r]+'"';return""!=t&&(t=t.slice(1)),n.pop()+t+n.pop()};return i(e)},registerUser:function(e){var t=e.orgName||"",n=e.appName||"",i=e.appKey||"";if(!t&&!n&&i){var o=i.split("#");2===o.length&&(t=o[0],n=o[1])}if(!t&&!n)return void e.error({type:EASEMOB_IM_RESISTERUSER_ERROR,msg:"没有指定开发者信息"});var r=e.https||r,s=e.apiUrl||(r?"https":"http")+"://a1.easemob.com",a=s+"/"+t+"/"+n+"/users",c={username:e.username,
password:e.password,nickname:e.nickname||""},d=Utils.stringify(c),e={url:a,dataType:"json",data:d,success:e.success||EMPTYFN,error:e.error||EMPTYFN};return Utils.ajax(e)},login2UserGrid:function(e){e=e||{};var t=e.appKey||"",n=t.split("#");if(2!==n.length)return a({type:EASEMOB_IM_CONNCTION_OPEN_USERGRID_ERROR,msg:"请指定正确的开发者信息(appKey)"}),!1;var i=n[0],o=n[1];if(!i)return a({type:EASEMOB_IM_CONNCTION_OPEN_USERGRID_ERROR,msg:"请指定正确的开发者信息(appKey)"}),!1;if(!o)return a({type:EASEMOB_IM_CONNCTION_OPEN_USERGRID_ERROR,msg:"请指定正确的开发者信息(appKey)"}),!1;var r=r||e.https,s=e.success||EMPTYFN,a=e.error||EMPTYFN,c=e.user||"",d=e.pwd||"",l=e.apiUrl||(r?"https":"http")+"://a1.easemob.com",u={grant_type:"password",username:c,password:d},p=Utils.stringify(u),e={url:l+"/"+i+"/"+o+"/token",dataType:"json",data:p,success:s||EMPTYFN,error:a||EMPTYFN};return Utils.ajax(e)},getFileUrl:function(e){var t={url:"",filename:"",filetype:"",data:""},n=document.getElementById(e);if(!Utils.isCanUploadFileAsync||!n)return t;if(window.URL.createObjectURL){var i=n.files;if(i.length>0){var o=i.item(0);t.data=o,t.url=window.URL.createObjectURL(o),t.filename=o.name||""}}else{var o=document.getElementById(e).value;t.url=o;var r=o.lastIndexOf("/"),s=o.lastIndexOf("\\"),a=Math.max(r,s);0>a?t.filename=o:t.filename=o.substring(a+1)}var c=t.filename.lastIndexOf(".");return-1!=c&&(t.filetype=t.filename.substring(c+1).toLowerCase()),t},getFileSizeFn:function(e){var t=document.getElementById(e),n=0;if(t)if(t.files)t.files.length>0&&(n=t.files[0].size);else if(t.select&&"ActiveXObject"in window){t.select();var i=new ActiveXObject("Scripting.FileSystemObject"),t=i.GetFile(t.value);n=t.Size}return n},hasFlash:i,trim:function(e){return e="string"==typeof e?e:"",e.trim?e.trim():e.replace(/^\s|\s$/g,"")},parseEmotions:function(e){if("undefined"==typeof Easemob.im.EMOTIONS||"undefined"==typeof Easemob.im.EMOTIONS.map)return e;var t=Easemob.im.EMOTIONS;for(var n in t.map)if(t.map.hasOwnProperty(n))for(;e.indexOf(n)>-1;)e=e.replace(n,'<img class="em-emotion" src="'+t.path+t.map[n]+'" alt="表情">');return e},parseLink:function(e){var t=/(https?\:\/\/|www\.)([a-zA-Z0-9-]+(\.[a-zA-Z0-9]+)+)(\:[0-9]{2,4})?\/?((\.[:_0-9a-zA-Z-]+)|[:_0-9a-zA-Z-]*\/?)*\??[:_#@*&%0-9a-zA-Z-\/=]*/gm;return e=e.replace(t,function(e){var t=/^https?/gm.test(e);return"<a href='"+(t?e:"//"+e)+"' target='_blank'>"+e+"</a>"})},parseJSON:function(e){if(window.JSON&&window.JSON.parse)return window.JSON.parse(e+"");var t,n=null,i=Utils.trim(e+"");return i&&!Utils.trim(i.replace(/(,)|(\[|{)|(}|])|"(?:[^"\\\r\n]|\\["\\\/bfnrt]|\\u[\da-fA-F]{4})*"\s*:?|true|false|null|-?(?!0\d)\d+(?:\.\d+|)(?:[eE][+-]?\d+|)/g,function(e,i,o,r){return t&&i&&(n=0),0===n?e:(t=o||i,n+=!r-!o,"")}))?Function("return "+i)():Function("Invalid JSON: "+e)()},parseUploadResponse:function(e){return e.indexOf("callback")>-1?e.slice(9,-1):e},parseDownloadResponse:function(e){return e&&e.type&&"application/json"===e.type||0>Object.prototype.toString.call(e).indexOf("Blob")?this.url+"?token=":window.URL.createObjectURL(e)},uploadFile:function(e){e=e||{},e.onFileUploadProgress=e.onFileUploadProgress||EMPTYFN,e.onFileUploadComplete=e.onFileUploadComplete||EMPTYFN,e.onFileUploadError=e.onFileUploadError||EMPTYFN,e.onFileUploadCanceled=e.onFileUploadCanceled||EMPTYFN;var t=e.accessToken||this.context.accessToken;if(!t)return void e.onFileUploadError({type:EASEMOB_IM_UPLOADFILE_NO_LOGIN,msg:"用户未登录到usergrid服务器,无法使用文件上传功能",id:e.id});if(orgName=e.orgName||this.context.orgName||"",appName=e.appName||this.context.appName||"",appKey=e.appKey||this.context.appKey||"",!orgName&&!appName&&appKey){var n=appKey.split("#");2==n.length&&(orgName=n[0],appName=n[1])}if(!orgName&&!appName)return void e.onFileUploadError({type:EASEMOB_IM_UPLOADFILE_ERROR,msg:"没有指定开发者信息",id:e.id});var i=e.apiUrl||"http://a1.easemob.com",o=i+"/"+orgName+"/"+appName+"/chatfiles";if(!Utils.isCanUploadFileAsync)return void(Utils.hasFlash&&"function"==typeof e.flashUpload?e.flashUpload&&e.flashUpload(o,e):this.onError({type:EASEMOB_IM_UPLOADFILE_BROWSER_ERROR,msg:"当前浏览器不支持异步上传！"}));var r=e.file.data?e.file.data.size:undefined;if(r>EASEMOB_IM_FILESIZE_LIMIT)return void e.onFileUploadError({type:EASEMOB_IM_UPLOADFILE_ERROR,msg:"上传文件超过服务器大小限制（10M）",id:e.id});if(0>=r)return void e.onFileUploadError({type:EASEMOB_IM_UPLOADFILE_ERROR,msg:"上传文件大小为0",id:e.id});var s=Utils.xmlrequest(),a=function(t){e.onFileUploadError({type:EASEMOB_IM_UPLOADFILE_ERROR,msg:"上传文件失败",id:e.id,xhr:s})};s.upload&&s.upload.addEventListener("progress",e.onFileUploadProgress,!1),s.addEventListener?(s.addEventListener("abort",e.onFileUploadCanceled,!1),s.addEventListener("load",function(t){try{var n=Utils.parseJSON(s.responseText);e.onFileUploadComplete(n)}catch(t){e.onFileUploadError({type:EASEMOB_IM_UPLOADFILE_ERROR,msg:"上传文件失败,服务端返回值值不正确",data:s.responseText,id:e.id,xhr:s})}},!1),s.addEventListener("error",a,!1)):s.onreadystatechange&&(s.onreadystatechange=function(){if(4===s.readyState)if(200===ajax.status)try{var t=Utils.parseJSON(s.responseText);e.onFileUploadComplete(t)}catch(n){e.onFileUploadError({type:EASEMOB_IM_UPLOADFILE_ERROR,msg:"上传文件失败,服务端返回值不正确",data:s.responseText,id:e.id,xhr:s})}else e.onFileUploadError({type:EASEMOB_IM_UPLOADFILE_ERROR,msg:"上传文件失败,服务端返回异常",data:s.responseText,id:e.id,xhr:s});else s.abort(),e.onFileUploadCanceled()}),s.open("POST",o),s.setRequestHeader("restrict-access","true"),s.setRequestHeader("Accept","*/*"),s.setRequestHeader("Authorization","Bearer "+t);var c=new FormData;c.append("file",e.file.data),s.send(c)},downloadFn:function(e){e.onFileDownloadComplete=e.onFileDownloadComplete||EMPTYFN,e.onFileDownloadError=e.onFileDownloadError||EMPTYFN;var t=e.accessToken||"";if(!t)return void e.onFileDownloadError({type:EASEMOB_IM_DOWNLOADFILE_NO_LOGIN,msg:"用户未登录到usergrid服务器,无法使用文件下载功能",id:e.id});var n=function(t){e.onFileDownloadError({type:EASEMOB_IM_DOWNLOADFILE_ERROR,msg:"下载文件失败",id:e.id,xhr:i})};if(!Utils.isCanDownLoadFile)return void e.onFileDownloadComplete();var i=Utils.xmlrequest();"addEventListener"in i?(i.addEventListener("load",function(t){e.onFileDownloadComplete(i.response,i)},!1),i.addEventListener("error",n,!1)):"onreadystatechange"in i&&(i.onreadystatechange=function(){4===i.readyState?200===ajax.status?e.onFileDownloadComplete(i.response,i):e.onFileDownloadError({type:EASEMOB_IM_DOWNLOADFILE_ERROR,msg:"下载文件失败,服务端返回异常",id:e.id,xhr:i}):(i.abort(),e.onFileDownloadError({type:EASEMOB_IM_DOWNLOADFILE_ERROR,msg:"错误的下载状态,退出下载",id:e.id,xhr:i}))});var o=e.method||"GET",r=e.responseType||"blob",s=e.mimeType||"text/plain; charset=x-user-defined";i.open(o,e.url),"undefined"!=typeof Blob?i.responseType=r:i.overrideMimeType(s);var a={"X-Requested-With":"XMLHttpRequest",Accept:"application/octet-stream","share-secret":e.secret,Authorization:"Bearer "+t},c=e.headers||{};for(var d in c)a[d]=c[d];for(var d in a)a[d]&&i.setRequestHeader(d,a[d]);i.send(null)},parseTextMessage:function(e,t){if("string"!=typeof e)return void conn.onError({type:EASEMOB_IM_MESSAGE_REC_TEXT_ERROR,msg:"不合法的消息内容格式，请检查发送消息内容！"});if("[object Object]"!==Object.prototype.toString.call(t))return{isemotion:!1,body:[{type:"txt",data:e}]};var n=e,i=[],o=/\[[^[\]]{2,3}\]/gm,r=n.match(o);if(!r||r.length<1)return{isemotion:!1,body:[{type:"txt",data:e}]};for(var s=!1,a=0;a<r.length;a++){var c=n.substring(0,n.indexOf(r[a])),d=Easemob.im.EMOTIONS.map[r[a]];if(c&&i.push({type:"txt",data:c}),d){var l=Easemob.im.EMOTIONS.map?Easemob.im.EMOTIONS.path+d:null;l?(s=!0,i.push({type:"emotion",data:l})):i.push({type:"txt",data:r[a]});var u=n.indexOf(r[a])+r[a].length;n=n.substring(u)}else i.push({type:"txt",data:r[a]})}return n&&i.push({type:"txt",data:n}),s?{isemotion:s,body:i}:{isemotion:!1,body:[{type:"txt",data:e}]}},xmlrequest:n,ajax:function(e){var t=e.dataType||"text",n=e.success||EMPTYFN,i=e.error||EMPTYFN,o=Utils.xmlrequest();if(o.onreadystatechange=function(){if(4===o.readyState){var e=o.status||0;if(200===e){if("text"===t)return void n(o.responseText,o);if("json"===t){try{var r=Utils.parseJSON(o.responseText);n(r,o)}catch(s){i(o.responseText,o,"错误的数据,无法转换为json")}return}return"xml"===t?void(o.responseXML&&o.responseXML.documentElement?n(o.responseXML.documentElement,o):i(o.responseText,o,"浏览器不支持ajax返回xml对象")):void n(o.response||o.responseText,o)}if("json"===t){try{var r=Utils.parseJSON(o.responseText);i(r,o,"服务器返回错误信息")}catch(s){i(o.responseText,o,"服务器返回错误信息")}return}return"xml"===t?void(o.responseXML&&o.responseXML.documentElement?i(o.responseXML.documentElement,o,"服务器返回错误信息"):i(o.responseText,o,"服务器返回错误信息")):void i(o.responseText,o,"服务器返回错误信息")}0===o.readyState&&i(o.responseText,o,"服务器异常")},e.responseType){if(!o.responseType)return i("",o,"当前浏览器不支持设置响应类型"),null;o.responseType=e.responseType}if(e.mimeType){if(!Utils.hasOverrideMimeType)return i("",o,"当前浏览器不支持设置mimeType"),null;o.overrideMimeType(e.mimeType)}var r=e.type||"POST",s=e.data||null,a="";if("get"===r.toLowerCase()&&s){for(var c in s)s.hasOwnProperty(c)&&(a+=c+"="+s[c]+"&");a=a?a.slice(0,-1):a,e.url+=(e.url.indexOf("?")>0?"&":"?")+(a?a+"&":a)+"_v="+(new Date).getTime(),s=null,a=null}if(o.open(r,e.url),Utils.isCanSetRequestHeader){var d=e.headers||{};for(var l in d)d.hasOwnProperty(l)&&o.setRequestHeader(l,d[l])}return o.send(s),o}}}(),EmMessage=function(e,t){return!this instanceof EmMessage?new EmMessage(e):(this._msg={},"function"==typeof EmMessage[e]&&(EmMessage[e].prototype.setGroup=this.setGroup,this._msg=new EmMessage[e](t)),this._msg)};EmMessage.prototype.setGroup=function(e){this.body.group=e};var _msgHash={},Message=function(e){return!this instanceof Message?new Message(e,conn):void(this.msg=e)};Message.prototype.send=function(e){var t=this,n=function(t){t.ext=t.ext||{},t.ext.weichat=t.ext.weichat||{},t.ext.weichat.originType=t.ext.weichat.originType||"webim";var n={from:e.context.userId||"",to:t.to,bodies:[t.body],ext:t.ext||{}},i=Utils.stringify(n),o=$msg({type:t.group||"chat",to:t.toJid,id:t.id,xmlns:"jabber:client"}).c("body").t(i);t.roomType&&o.up().c("roomtype",{xmlns:"easemob:x:roomtype",type:"chatroom"}),setTimeout(function(){_msgHash[t.id]&&_msgHash[t.id].msg.fail instanceof Function&&_msgHash[t.id].msg.fail(t.id)},6e4),e.sendCommand(o.tree(),t.id)};if(t.msg.file){if(t.msg.body&&t.msg.body.url)return void n(t.msg);var i=t.msg.onFileUploadComplete,o=function(e){if(e.entities[0]["file-metadata"]){var o=e.entities[0]["file-metadata"]["content-length"];t.msg.file_length=o,t.msg.filetype=e.entities[0]["file-metadata"]["content-type"],o>204800&&(t.msg.thumbnail=!0)}t.msg.body={type:t.msg.type||"file",url:e.uri+"/"+e.entities[0].uuid,secret:e.entities[0]["share-secret"],filename:t.msg.file.filename||t.msg.filename,size:{width:t.msg.width||0,height:t.msg.height||0},length:t.msg.file_length||0,file_length:t.msg.file_length||0,filetype:t.msg.filetype},n(t.msg),i instanceof Function&&i(e,t.msg.id)};t.msg.onFileUploadComplete=o,Utils.uploadFile.call(e,t.msg)}else t.msg.body={type:"chat"===t.msg.type?"txt":t.msg.type,msg:t.msg.msg},"cmd"===t.msg.type?t.msg.body.action=t.msg.action:"loc"===t.msg.type&&(t.msg.body.addr=t.msg.addr,t.msg.body.lat=t.msg.lat,t.msg.body.lng=t.msg.lng),n(t.msg)};var Connection=function(){var _networkSt,_listenNetwork=function(e,t){window.addEventListener?(window.addEventListener("online",e),window.addEventListener("offline",t)):window.attachEvent&&(document.body?(document.body.attachEvent("onoffline",t),document.body.attachEvent("onoffline",t)):window.attachEvent("load",function(){document.body.attachEvent("onoffline",t),document.body.attachEvent("onoffline",t)}))},_parseRoomFn=function(e){var t=[],n=e.getElementsByTagName("item");if(n)for(var i=0;i<n.length;i++){var o=n[i],r=o.getAttribute("jid"),s=r.split("@")[0],a={jid:r,name:o.getAttribute("name"),roomId:s.split("_")[1]};t.push(a)}return t},_parseRoomOccupantsFn=function(e){var t=[],n=e.getElementsByTagName("item");if(n)for(var i=0;i<n.length;i++){var o=n[i],r={jid:o.getAttribute("jid"),name:o.getAttribute("name")};t.push(r)}return t},_parseResponseMessage=function(msginfo){var parseMsgData={errorMsg:!0,data:[]},msgBodies=msginfo.getElementsByTagName("body");if(msgBodies){for(var i=0;i<msgBodies.length;i++){var msgBody=msgBodies[i],childNodes=msgBody.childNodes;if(childNodes&&childNodes.length>0){var childNode=msgBody.childNodes[0];if(childNode.nodeType==Strophe.ElementType.TEXT){var jsondata=childNode.wholeText||childNode.nodeValue;jsondata=jsondata.replace("\n","<br>");try{var data=eval("("+jsondata+")");parseMsgData.errorMsg=!1,parseMsgData.data=[data]}catch(e){}}}}var delayTags=msginfo.getElementsByTagName("delay");if(delayTags&&delayTags.length>0){var delayTag=delayTags[0],delayMsgTime=delayTag.getAttribute("stamp");delayMsgTime&&(parseMsgData.delayTimeStamp=delayMsgTime)}}else{var childrens=msginfo.childNodes;if(childrens&&childrens.length>0){var child=msginfo.childNodes[0];if(child.nodeType==Strophe.ElementType.TEXT)try{var data=eval("("+child.nodeValue+")");parseMsgData.errorMsg=!1,parseMsgData.data=[data]}catch(e){}}}return parseMsgData},_parseNameFromJidFn=function(e,t){t=t||"";var n=e,i=n.indexOf("_");-1!==i&&(n=n.substring(i+1));var o=n.indexOf("@"+t);return-1!==o&&(n=n.substring(0,o)),n},_parseFriendFn=function(e){var t=[],n=e.getElementsByTagName("item");if(n)for(var i=0;i<n.length;i++){var o=n[i],r=o.getAttribute("jid");if(r){var s=o.getAttribute("subscription"),a={subscription:s,jid:r},c=o.getAttribute("ask");c&&(a.ask=c);var d=o.getAttribute("name");if(d)a.name=d;else{var l=_parseNameFromJidFn(r);a.name=l}var u=[];Strophe.forEachChild(o,"group",function(e){u.push(Strophe.getText(e))}),a.groups=u,t.push(a)}}return t},_dologin2IM=function(e,t){var n=e.access_token||"";if(""==n){var i=Utils.stringify(e);return void t.onError({type:EASEMOB_IM_CONNCTION_OPEN_USERGRID_ERROR,msg:"登录失败,"+i,data:e,xhr:xhr})}t.context.accessToken=e.access_token,t.context.accessTokenExpires=e.expires_in;var o=null;if(t.isOpening()&&t.context.stropheConn)o=t.context.stropheConn;else{if(t.isOpened()&&t.context.stropheConn)return;o=new Strophe.Connection(t.url,{inactivity:t.inactivity,maxRetries:t.maxRetries,pollingTime:t.pollingTime})}var r=function(e,n){_login2ImCallback(e,n,t)};t.context.stropheConn=o,t.route?o.connect(t.context.jid,"$t$"+n,r,t.wait,t.hold,t.route):o.connect(t.context.jid,"$t$"+n,r,t.wait,t.hold)},_parseMessageType=function(e){var t="normal",n=e.getElementsByTagName("received");if(n&&n.length>0&&"urn:xmpp:receipts"===n[0].namespaceURI)t="received";else{var i=e.getElementsByTagName("invite");i&&i.length>0&&(t="invite")}return t},_handleQueueMessage=function(e){for(var t in _msgHash)_msgHash.hasOwnProperty(t)&&_msgHash[t].send(e)},_login2ImCallback=function(e,t,n){if(e==Strophe.Status.CONNFAIL)n.onError({type:EASEMOB_IM_CONNCTION_SERVER_CLOSE_ERROR,msg:t,reconnect:!0});else if(e==Strophe.Status.ATTACHED||e==Strophe.Status.CONNECTED){var i=function(e){var t=_parseMessageType(e);return"received"===t?(n.handleReceivedMessage(e),!0):"invite"===t?(n.handleInviteMessage(e),!0):(n.handleMessage(e),!0)},o=function(e){return n.handlePresence(e),!0},r=function(e){return n.handlePing(e),!0},s=function(e){return n.handleIq(e),!0};n.addHandler(i,null,"message",null,null,null),n.addHandler(o,null,"presence",null,null,null),n.addHandler(r,"urn:xmpp:ping","iq","get",null,null),n.addHandler(s,"jabber:iq:roster","iq","set",null,null),n.context.status=STATUS_OPENED;var a=[EASEMOB_IM_MESSAGE_REC_TEXT,EASEMOB_IM_MESSAGE_REC_EMOTION];Utils.isCanDownLoadFile&&(a.push(EASEMOB_IM_MESSAGE_REC_PHOTO),a.push(EASEMOB_IM_MESSAGE_REC_AUDIO_FILE));var c=[EASEMOB_IM_MESSAGE_SED_TEXT];Utils.isCanUploadFile&&(c.push(EASEMOB_IM_MESSAGE_REC_PHOTO),c.push(EASEMOB_IM_MESSAGE_REC_AUDIO_FILE)),n.notifyVersion(),n.retry&&_handleQueueMessage(n),n.onOpened({canReceive:a,canSend:c,accessToken:n.context.accessToken}),n.heartBeat()}else e==Strophe.Status.DISCONNECTING?n.isOpened()&&(n.stopHeartBeat(),n.context.status=STATUS_CLOSING,n.onError({type:EASEMOB_IM_CONNCTION_SERVER_CLOSE_ERROR,msg:t,reconnect:!0})):e==Strophe.Status.DISCONNECTED?(n.context.status=STATUS_CLOSED,n.clear(),n.onClosed()):e==Strophe.Status.AUTHFAIL?(n.onError({type:EASEMOB_IM_CONNCTION_AUTH_ERROR,msg:"登录失败,请输入正确的用户名和密码"}),n.clear()):e==Strophe.Status.ERROR&&n.onError({type:EASEMOB_IM_CONNCTION_SERVER_ERROR,msg:t||"服务器异常"})},_getJid=function(e,t){var n=e.toJid||"";if(""===n){var i=t.context.appKey||"",o=i+"_"+e.to+"@"+t.domain;e.resource&&(o=o+"/"+e.resource),n=o}return n},_innerCheck=function(e,t){if(e=e||{},""==e.user)return t.onError({type:EASEMOB_IM_CONNCTION_USER_NOT_ASSIGN_ERROR,msg:"未指定用户"}),!1;var n=e.user||"",i=e.appKey||"",o=i.split("#");if(2!==o.length)return t.onError({type:EASEMOB_IM_CONNCTION_OPEN_ERROR,msg:"请指定正确的开发者信息(appKey)"}),!1;var r=o[0],s=o[1];if(!r)return t.onError({type:EASEMOB_IM_CONNCTION_OPEN_ERROR,msg:"请指定正确的开发者信息(appKey)"}),!1;if(!s)return t.onError({type:EASEMOB_IM_CONNCTION_OPEN_ERROR,msg:"请指定正确的开发者信息(appKey)"}),!1;var a=i+"_"+n.toLowerCase()+"@"+t.domain,c=e.resource||"webim";return t.multiResources&&(c+=n+(new Date).getTime()+Math.floor(1e6*Math.random().toFixed(6))),t.context.jid=a+"/"+c,t.context.userId=n,t.context.appKey=i,t.context.appName=s,t.context.orgName=r,!0},_getXmppUrl=function(e,t){if(/^(ws|http)s?:\/\/?/.test(e))return e;var n={prefix:"http",base:"://"+(e||"im-api.easemob.com"),suffix:"/http-bind/"};return t&&Utils.isSupportWss?(n.prefix="wss",n.suffix="/ws/"):t?n.prefix="https":window.WebSocket&&(n.prefix="ws",n.suffix="/ws/"),n.prefix+n.base+n.suffix},connection=function(e){if(!this instanceof Connection)return new Connection(e);var e=e||{};this.multiResources=e.multiResources||!1,this.wait=e.wait||30,this.retry=e.retry||!1,this.https=e.https||https,this.url=_getXmppUrl(e.url,this.https),this.hold=e.hold||1,this.route=e.route||null,this.domain=e.domain||"easemob.com",this.inactivity=e.inactivity||30,this.heartBeatWait=e.heartBeatWait||6e4,this.maxRetries=e.maxRetries||5,this.pollingTime=e.pollingTime||800,this.stropheConn=!1,this.context={status:STATUS_INIT}};return connection.prototype.listen=function(e){e.url&&(this.url=_getXmppUrl(e.url,this.https)),this.onOpened=e.onOpened||EMPTYFN,this.onClosed=e.onClosed||EMPTYFN,this.onTextMessage=e.onTextMessage||EMPTYFN,this.onEmotionMessage=e.onEmotionMessage||EMPTYFN,this.onPictureMessage=e.onPictureMessage||EMPTYFN,this.onAudioMessage=e.onAudioMessage||EMPTYFN,this.onVideoMessage=e.onVideoMessage||EMPTYFN,this.onFileMessage=e.onFileMessage||EMPTYFN,this.onLocationMessage=e.onLocationMessage||EMPTYFN,this.onCmdMessage=e.onCmdMessage||EMPTYFN,this.onPresence=e.onPresence||EMPTYFN,this.onRoster=e.onRoster||EMPTYFN,this.onError=e.onError||EMPTYFN,this.onReceivedMessage=e.onReceivedMessage||EMPTYFN,this.onInviteMessage=e.onInviteMessage||EMPTYFN,this.onOffline=e.onOffline||EMPTYFN,this.onOnline=e.onOnline||EMPTYFN,_listenNetwork(this.onOnline,this.onOffline)},connection.prototype.heartBeat=function(){var e=this;if(!e.heartBeatID){var t={to:e.domain,type:"normal"};e.heartBeatID=setInterval(function(){e.sendHeartBeatMessage(t)},e.heartBeatWait)}},connection.prototype.sendHeartBeatMessage=function(e){var t={},n=Utils.stringify(t),i=$msg({to:e.to,type:e.type,id:this.getUniqueId(),xmlns:"jabber:client"}).c("body").t(n);this.sendCommand(i.tree())},connection.prototype.stopHeartBeat=function(){this.heartBeatID=clearInterval(this.heartBeatID)},connection.prototype.sendReceiptsMessage=function(e){var t=$msg({from:this.context.jid||"",to:"easemob.com",id:e.id||""}).c("received",{xmlns:"urn:xmpp:receipts",id:e.id||""});this.sendCommand(t.tree())},connection.prototype.open=function(e){var t=_innerCheck(e,this);if(t){var n=this;if(!n.isOpening()&&!n.isOpened())if(e.accessToken)e.access_token=e.accessToken,_dologin2IM(e,n);else{var i=e.apiUrl||(this.https?"https":"http")+"://a1.easemob.com",o=this.context.userId,r=e.pwd||"",s=this.context.appName,a=this.context.orgName,c=function(e,t){n.context.status=STATUS_DOLOGIN_IM,_dologin2IM(e,n)},d=function(e,t,i){n.clear(),e.error&&e.error_description?n.onError({type:EASEMOB_IM_CONNCTION_OPEN_USERGRID_ERROR,msg:"登录失败,"+e.error_description,data:e,xhr:t}):n.onError({type:EASEMOB_IM_CONNCTION_OPEN_USERGRID_ERROR,msg:"登录失败",data:e,xhr:t})};this.context.status=STATUS_DOLOGIN_USERGRID;var l={grant_type:"password",username:o,password:r},u=Utils.stringify(l),e={url:i+"/"+a+"/"+s+"/token",dataType:"json",data:u,success:c||EMPTYFN,error:d||EMPTYFN};Utils.ajax(e)}}},connection.prototype.attach=function(e){var t=_innerCheck(e,this);if(t){e=e||{};var n=e.accessToken||"";if(""==n)return void this.onError({type:EASEMOB_IM_CONNCTION_ATTACH_USERGRID_ERROR,msg:"未指定用户的accessToken"});var i=e.sid||"";if(""===i)return void this.onError({type:EASEMOB_IM_CONNCTION_ATTACH_ERROR,msg:"未指定用户的会话信息"});var o=e.rid||"";if(""===o)return void this.onError({type:EASEMOB_IM_CONNCTION_ATTACH_ERROR,msg:"未指定用户的消息id"});var r=new Strophe.Connection(this.url,{inactivity:this.inactivity,maxRetries:this.maxRetries,pollingTime:this.pollingTime});this.context.accessToken=n,this.context.stropheConn=r,this.context.status=STATUS_DOLOGIN_IM;var s=this,a=function(e,t){_login2ImCallback(e,t,s)},c=this.context.jid,d=this.wait,l=this.hold,u=this.wind||5;r.attach(c,i,o,a,d,l,u)}},connection.prototype.close=function(){var e=this.context.status;e!=STATUS_INIT&&(this.isClosed()||this.isClosing()||(this.stopHeartBeat(),this.context.status=STATUS_CLOSING,this.context.stropheConn.disconnect()))},connection.prototype.addHandler=function(e,t,n,i,o,r,s){this.context.stropheConn.addHandler(e,t,n,i,o,r,s)},connection.prototype.notifyVersion=function(e,t){var n=(_getJid({},this),$iq({from:this.context.jid||"",to:this.domain,type:"result"}).c("query",{xmlns:"jabber:iq:version"}).c("name").t("easemob").up().c("version").t(Easemob.im.version).up().c("os").t("webim"));e=e||EMPTYFN,error=t||this.onError;var i=function(e){error({type:EASEMOB_IM_CONNCTION_NOTIFYVERSION_ERROR,msg:"发送版本信息给服务器时失败",data:e})};this.context.stropheConn.sendIQ(n.tree(),e,i)},connection.prototype.handlePresence=function(e){if(!this.isClosed()){var t=e.getAttribute("from")||"",n=e.getAttribute("to")||"",i=e.getAttribute("type")||"",o=e.getAttribute("presence_type")||"",r=_parseNameFromJidFn(t),s=_parseNameFromJidFn(n),a={from:r,to:s,fromJid:t,toJid:n,type:i,chatroom:e.getElementsByTagName("roomtype").length?!0:!1},c=e.getElementsByTagName("show");if(c&&c.length>0){var d=c[0];a.show=Strophe.getText(d)}var l=e.getElementsByTagName("status");if(l&&l.length>0){var u=l[0];a.status=Strophe.getText(u),a.code=u.getAttribute("code")}var p=e.getElementsByTagName("priority");if(p&&p.length>0){var m=p[0];a.priority=Strophe.getText(m)}var h=e.getElementsByTagName("error");if(h&&h.length>0){var h=h[0];a.error={code:h.getAttribute("code")}}var f=e.getElementsByTagName("destroy");if(f&&f.length>0){var f=f[0];a.destroy=!0;var g=f.getElementsByTagName("reason");g&&g.length>0&&(a.reason=Strophe.getText(g[0]))}if(a.chatroom){var _=t.slice(t.lastIndexOf("/")+1);_===this.context.userId&&(""!==a.type||a.code?("unavailable"===o||"unavailable"===a.type)&&(a.status?110==a.code?a.type="leaveChatRoom":a.error&&406==a.error.code&&(a.type="joinChatRoomFailed"):a.type="leaveChatRoom"):a.type="joinChatRoomSuccess")}else("unavailable"===o||"unavailable"===i)&&(a.destroy?a.type="deleteGroupChat":(307==a.code||321==a.code)&&(a.type="leaveGroup"));this.onPresence(a,e)}},connection.prototype.handlePing=function(e){if(!this.isClosed()){var t=e.getAttribute("id"),n=e.getAttribute("from"),i=e.getAttribute("to"),o=$iq({from:i,to:n,id:t,type:"result"});this.sendCommand(o.tree())}},connection.prototype.handleIq=function(e){var t=e.getAttribute("id"),n=e.getAttribute("from")||"",i=(_parseNameFromJidFn(n),this.context.jid),o=(this.context.userId,$iq({type:"result",id:t,from:i}));this.sendCommand(o.tree());var r=e.getElementsByTagName("query");if(r&&r.length>0){var s=r[0],a=_parseFriendFn(s);this.onRoster(a)}return!0},connection.prototype.handleMessage=function(e){if(!this.isClosed()){var t=e.getAttribute("id")||"";this.sendReceiptsMessage({id:t});var n=_parseResponseMessage(e);if(n.errorMsg)return void this.handlePresence(e);var i=n.data;for(var o in i)if(i.hasOwnProperty(o)){var r=i[o];if(r.from&&r.to){var s=r.from.toLowerCase(),a=r.to.toLowerCase(),c=r.ext||{},d="",l=e.getElementsByTagName("roomtype");d=l.length?l[0].getAttribute("type")||"chat":e.getAttribute("type")||"chat";var u=r.bodies;if(u&&0!=u.length){var p=r.bodies[0],m=p.type;if("txt"===m){var h=p.msg,f=Utils.parseTextMessage(h,Easemob.im.EMOTIONS);f.isemotion?this.onEmotionMessage({id:t,type:d,from:s,to:a,delay:n.delayTimeStamp,data:f.body,ext:c}):this.onTextMessage({id:t,type:d,from:s,to:a,delay:n.delayTimeStamp,data:h,ext:c})}else if("img"===m){var g=0,_=0;p.size&&(g=p.size.width,_=p.size.height);var r={id:t,type:d,from:s,to:a,url:p.url,secret:p.secret,filename:p.filename,thumb:p.thumb,thumb_secret:p.thumb_secret,file_length:p.file_length||"",width:g,height:_,filetype:p.filetype||"",accessToken:this.context.accessToken||"",ext:c,delay:n.delayTimeStamp};this.onPictureMessage(r)}else"audio"===m?this.onAudioMessage({id:t,type:d,from:s,to:a,url:p.url,secret:p.secret,filename:p.filename,length:p.length||"",file_length:p.file_length||"",filetype:p.filetype||"",accessToken:this.context.accessToken||"",ext:c,delay:n.delayTimeStamp}):"file"===m?this.onFileMessage({id:t,type:d,from:s,to:a,url:p.url,secret:p.secret,filename:p.filename,file_length:p.file_length,accessToken:this.context.accessToken||"",ext:c,delay:n.delayTimeStamp}):"loc"===m?this.onLocationMessage({id:t,type:d,from:s,to:a,addr:p.addr,lat:p.lat,lng:p.lng,ext:c,delay:n.delayTimeStamp}):"video"===m?this.onVideoMessage({id:t,type:d,from:s,to:a,url:p.url,secret:p.secret,filename:p.filename,file_length:p.file_length,accessToken:this.context.accessToken||"",ext:c,delay:n.delayTimeStamp}):"cmd"===m&&this.onCmdMessage({id:t,from:s,to:a,action:p.action,ext:c,delay:n.delayTimeStamp})}}}}},connection.prototype.handleReceivedMessage=function(e){this.onReceivedMessage(e);var t,n,i=e.getElementsByTagName("received");i.length>0&&(t=i[0].childNodes&&i[0].childNodes.length>0?i[0].childNodes[0].nodeValue:i[0].innerHTML||i[0].innerText,n=i[0].getAttribute("mid")),_msgHash[t]&&(_msgHash[t].msg.success instanceof Function&&_msgHash[t].msg.success(t,n),delete _msgHash[t])},connection.prototype.handleInviteMessage=function(e){var t=null,n=e.getElementsByTagName("invite"),i=e.getAttribute("id")||"";if(this.sendReceiptsMessage({id:i}),n&&n.length>0){var o=n[0].getAttribute("from");t=_parseNameFromJidFn(o)}var r=e.getElementsByTagName("x"),s=null;if(r&&r.length>0)for(var a=0;a<r.length;a++)if("jabber:x:conference"===r[a].namespaceURI){var c=r[a].getAttribute("jid");s=_parseNameFromJidFn(c)}this.onInviteMessage({type:"invite",from:t,roomid:s})},connection.prototype.sendCommand=function(e,t){this.isOpened()?this.context.stropheConn.send(e):this.onError({type:EASEMOB_IM_CONNCTION_OPEN_ERROR,msg:"连接还未建立,请先登录或等待登录处理完毕",reconnect:!0})},connection.prototype.getUniqueId=function(e){var t=new Date,n=new Date(2010,1,1),i=t.getTime()-n.getTime(),o=parseInt(i).toString(16);return"string"==typeof e||"number"==typeof e?e+"_"+o:"WEBIM_"+o},connection.prototype.send=function(e){if("[object Object]"===Object.prototype.toString.call(e)){var t=this.context.appKey||"",n=t+"_"+e.to+"@"+this.domain;e.group&&(n=t+"_"+e.to+"@conference."+this.domain),e.resource&&(n=n+"/"+e.resource),e.toJid=n,e.id=e.id||this.getUniqueId(),_msgHash[e.id]=new Message(e),_msgHash[e.id].send(this)}else"string"==typeof e&&_msgHash[e]&&_msgHash[e].send(this)},connection.prototype.addRoster=function(e){var t=_getJid(e,this),n=e.name||"",i=e.groups||"",o=$iq({type:"set"});if(o.c("query",{xmlns:"jabber:iq:roster"}),o.c("item",{jid:t,name:n}),i)for(var r=0;r<i.length;r++)o.c("group").t(i[r]).up();var s=e.success||EMPTYFN,a=e.error||EMPTYFN;this.context.stropheConn.sendIQ(o.tree(),s,a)},connection.prototype.removeRoster=function(e){var t=_getJid(e,this),n=$iq({type:"set"}).c("query",{xmlns:"jabber:iq:roster"}).c("item",{jid:t,subscription:"remove"}),i=e.success||EMPTYFN,o=e.error||EMPTYFN;this.context.stropheConn.sendIQ(n,i,o)},connection.prototype.getRoster=function(e){var t=$iq({type:"get"}).c("query",{xmlns:"jabber:iq:roster"});e=e||{},suc=e.success||this.onRoster;var n=function(e){var t=[],n=e.getElementsByTagName("query");if(n&&n.length>0){var i=n[0];t=_parseFriendFn(i)}suc(t,e)};error=e.error||this.onError;var i=function(e){error({type:EASEMOB_IM_CONNCTION_GETROSTER_ERROR,msg:"获取联系人信息失败",data:e})};this.isOpened()?this.context.stropheConn.sendIQ(t.tree(),n,i):error({type:EASEMOB_IM_CONNCTION_OPEN_ERROR,msg:"连接还未建立,请先登录或等待登录处理完毕"})},connection.prototype.subscribe=function(e){var t=_getJid(e,this),n=$pres({to:t,type:"subscribe"});e.message&&n.c("status").t(e.message).up(),e.nick&&n.c("nick",{xmlns:"http://jabber.org/protocol/nick"}).t(e.nick),this.sendCommand(n.tree())},connection.prototype.subscribed=function(e){var t=_getJid(e,this),n=$pres({to:t,type:"subscribed"});e.message&&n.c("status").t(e.message).up(),this.sendCommand(n.tree())},connection.prototype.unsubscribe=function(e){var t=_getJid(e,this),n=$pres({to:t,type:"unsubscribe"});e.message&&n.c("status").t(e.message),this.sendCommand(n.tree())},connection.prototype.unsubscribed=function(e){var t=_getJid(e,this),n=$pres({to:t,type:"unsubscribed"});e.message&&n.c("status").t(e.message).up(),this.sendCommand(n.tree())},connection.prototype.createRoom=function(e){var t,n=e.success||EMPTYFN,i=e.error||EMPTYFN;return t=$iq({to:e.rooomName,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).c("x",{xmlns:"jabber:x:data",type:"submit"}),this.context.stropheConn.sendIQ(t.tree(),n,i)},connection.prototype.join=function(e){var t=this.context.appKey+"_"+e.roomId+"@conference."+this.domain,n=t+"/"+this.context.userId,i=e.success||EMPTYFN,o=e.error||EMPTYFN,r=function(e){o({type:EASEMOB_IM_CONNCTION_JOINROOM_ERROR,msg:"加入房间失败",data:e})},s=$pres({from:this.context.jid,to:n}).c("x",{xmlns:Strophe.NS.MUC});this.context.stropheConn.sendIQ(s.tree(),i,r)},connection.prototype.listRooms=function(e){var t=$iq({to:e.server||"conference."+this.domain,from:this.context.jid,type:"get"}).c("query",{xmlns:Strophe.NS.DISCO_ITEMS}),n=e.success||EMPTYFN,i=function(e){var t=[];t=_parseRoomFn(e),n(t)},o=e.error||EMPTYFN,r=function(e){o({type:EASEMOB_IM_CONNCTION_GETROOM_ERROR,msg:"获取群组列表失败",data:e})};this.context.stropheConn.sendIQ(t.tree(),i,r)},connection.prototype.queryRoomMember=function(e){var t=(this.domain,[]),n=$iq({to:this.context.appKey+"_"+e.roomId+"@conference."+this.domain,type:"get"}).c("query",{xmlns:Strophe.NS.MUC+"#admin"}).c("item",{affiliation:"member"}),i=e.success||EMPTYFN,o=function(e){var n=e.getElementsByTagName("item");if(n)for(var o=0;o<n.length;o++){var r=n[o],s={jid:r.getAttribute("jid"),affiliation:"member"};t.push(s)}i(t)},r=e.error||EMPTYFN,s=function(e){r({type:EASEMOB_IM_CONNCTION_GETROOMMEMBER_ERROR,msg:"获取群组成员列表失败",data:e})};this.context.stropheConn.sendIQ(n.tree(),o,s)},connection.prototype.queryRoomInfo=function(e){var t=this.domain,n=$iq({to:this.context.appKey+"_"+e.roomId+"@conference."+t,type:"get"}).c("query",{xmlns:Strophe.NS.DISCO_INFO}),i=e.success||EMPTYFN,o=[],r=function(e){var n=e.getElementsByTagName("field");if(n)for(var r=0;r<n.length;r++){var s=n[r];if("owner"===s.getAttribute("label")){var a={jid:(s.textContent||s.text)+"@"+t,affiliation:"owner"};o.push(a)}}i(o)},s=e.error||EMPTYFN,a=function(e){s({type:EASEMOB_IM_CONNCTION_GETROOMINFO_ERROR,msg:"获取群组信息失败",data:e})};this.context.stropheConn.sendIQ(n.tree(),r,a)},connection.prototype.queryRoomOccupants=function(e){var t=e.success||EMPTYFN,n=function(e){var n=[];n=_parseRoomOccupantsFn(e),t(n)},i=e.error||EMPTYFN,o=function(e){i({type:EASEMOB_IM_CONNCTION_GETROOMOCCUPANTS_ERROR,msg:"获取群组出席者列表失败",data:e})},r={xmlns:Strophe.NS.DISCO_ITEMS},s=$iq({from:this.context.jid,to:this.context.appKey+"_"+e.roomId+"@conference."+this.domain,type:"get"}).c("query",r);this.context.stropheConn.sendIQ(s.tree(),n,o);
},connection.prototype.setUserSig=function(e){var t=$pres({xmlns:"jabber:client"});e=e||"",t.c("status").t(e),this.sendCommand(t.tree())},connection.prototype.setPresence=function(e,t){var n=$pres({xmlns:"jabber:client"});e&&(t?(n.c("show").t(e),n.up().c("status").t(t)):n.c("show").t(e)),this.sendCommand(n.tree())},connection.prototype.getPresence=function(){var e=$pres({xmlns:"jabber:client"});this.sendCommand(e.tree())},connection.prototype.ping=function(e){e=e||{};var t=_getJid(e,this),n=$iq({from:this.context.jid||"",to:t,type:"get"}).c("ping",{xmlns:"urn:xmpp:ping"});suc=e.success||EMPTYFN,error=e.error||this.onError;var i=function(e){error({type:EASEMOB_IM_CONNCTION_PING_ERROR,msg:"ping失败",data:e})};this.isOpened()?this.context.stropheConn.sendIQ(n.tree(),suc,i):error({type:EASEMOB_IM_CONNCTION_OPEN_ERROR,msg:"连接还未建立,请先登录或等待登录处理完毕"})},connection.prototype.isOpened=function(){return this.context.status==STATUS_OPENED},connection.prototype.isOpening=function(){var e=this.context.status;return e==STATUS_DOLOGIN_USERGRID||e==STATUS_DOLOGIN_IM},connection.prototype.isClosing=function(){return this.context.status==STATUS_CLOSING},connection.prototype.isClosed=function(){return this.context.status==STATUS_CLOSED},connection.prototype.clear=function(){var e=this.context.appKey;this.context={status:STATUS_INIT,appKey:e}},connection.prototype.getChatRooms=function(e){if(!Utils.isCanSetRequestHeader)return void t.onError({type:EASEMOB_IM_CONNCTION_AUTH_ERROR,msg:"当前浏览器不支持聊天室功能"});var t=this,n=e.accessToken||this.context.accessToken;if(n){var i=e.apiUrl||(this.https?"https":"http")+"://a1.easemob.com",o=this.context.appName,r=this.context.orgName;if(!o||!r)return void t.onError({type:EASEMOB_IM_CONNCTION_AUTH_ERROR,msg:"token无效",data:null});var s=function(t,n){"function"==typeof e.success&&e.success(t)},a=function(e,n,i){e.error&&e.error_description&&t.onError({type:EASEMOB_IM_LOAD_CHATROOM_ERROR,msg:"获取聊天室失败,"+e.error_description,data:e,xhr:n})},c={url:i+"/"+r+"/"+o+"/chatrooms",dataType:"json",type:"get",headers:{Authorization:"Bearer "+n},success:s||EMPTYFN,error:a||EMPTYFN};Utils.ajax(c)}else t.onError({type:EASEMOB_IM_CONNCTION_AUTH_ERROR,msg:"token无效",data:null})},connection.prototype.joinChatRoom=function(e){var t=this.context.appKey+"_"+e.roomId+"@conference."+this.domain,n=t+"/"+this.context.userId,i=e.success||EMPTYFN,o=e.error||EMPTYFN,r=function(e){o({type:EASEMOB_IM_CONNCTION_JOINROOM_ERROR,msg:"加入聊天室失败",data:e})},s=$pres({from:this.context.jid,to:n}).c("x",{xmlns:Strophe.NS.MUC+"#user"}).c("item",{affiliation:"member",role:"participant"}).up().up().c("roomtype",{xmlns:"easemob:x:roomtype",type:"chatroom"});this.context.stropheConn.sendIQ(s.tree(),i,r)},connection.prototype.quitChatRoom=function(e){var t=this.context.appKey+"_"+e.roomId+"@conference."+this.domain,n=t+"/"+this.context.userId,i=e.success||EMPTYFN,o=e.error||EMPTYFN,r=function(e){o({type:EASEMOB_IM_CONNCTION_JOINROOM_ERROR,msg:"退出房间失败",data:e})},s=$pres({from:this.context.jid,to:n,type:"unavailable"}).c("x",{xmlns:Strophe.NS.MUC+"#user"}).c("item",{affiliation:"none",role:"none"}).up().up().c("roomtype",{xmlns:"easemob:x:roomtype",type:"chatroom"});this.context.stropheConn.sendIQ(s.tree(),i,r)},connection}(),EMPTYFN=function(){};tempIndex=0,EASEMOB_IM_CONNCTION_USER_NOT_ASSIGN_ERROR=tempIndex++,EASEMOB_IM_CONNCTION_OPEN_ERROR=tempIndex++,EASEMOB_IM_CONNCTION_AUTH_ERROR=tempIndex++,EASEMOB_IM_CONNCTION_OPEN_USERGRID_ERROR=tempIndex++,EASEMOB_IM_CONNCTION_ATTACH_ERROR=tempIndex++,EASEMOB_IM_CONNCTION_ATTACH_USERGRID_ERROR=tempIndex++,EASEMOB_IM_CONNCTION_REOPEN_ERROR=tempIndex++,EASEMOB_IM_CONNCTION_SERVER_CLOSE_ERROR=tempIndex++,EASEMOB_IM_CONNCTION_SERVER_ERROR=tempIndex++,EASEMOB_IM_CONNCTION_IQ_ERROR=tempIndex++,EASEMOB_IM_CONNCTION_PING_ERROR=tempIndex++,EASEMOB_IM_CONNCTION_NOTIFYVERSION_ERROR=tempIndex++,EASEMOB_IM_CONNCTION_GETROSTER_ERROR=tempIndex++,EASEMOB_IM_CONNCTION_CROSSDOMAIN_ERROR=tempIndex++,EASEMOB_IM_CONNCTION_LISTENING_OUTOF_MAXRETRIES=tempIndex++,EASEMOB_IM_CONNCTION_RECEIVEMSG_CONTENTERROR=tempIndex++,EASEMOB_IM_CONNCTION_JOINROOM_ERROR=tempIndex++,EASEMOB_IM_CONNCTION_GETROOM_ERROR=tempIndex++,EASEMOB_IM_CONNCTION_GETROOMINFO_ERROR=tempIndex++,EASEMOB_IM_CONNCTION_GETROOMMEMBER_ERROR=tempIndex++,EASEMOB_IM_CONNCTION_GETROOMOCCUPANTS_ERROR=tempIndex++,EASEMOB_IM_UPLOADFILE_BROWSER_ERROR=tempIndex++,EASEMOB_IM_UPLOADFILE_ERROR=tempIndex++,EASEMOB_IM_UPLOADFILE_NO_LOGIN=tempIndex++,EASEMOB_IM_UPLOADFILE_NO_FILE=tempIndex++,EASEMOB_IM_DOWNLOADFILE_ERROR=tempIndex++,EASEMOB_IM_DOWNLOADFILE_NO_LOGIN=tempIndex++,EASEMOB_IM_DOWNLOADFILE_BROWSER_ERROR=tempIndex++,EASEMOB_IM_RESISTERUSER_ERROR=tempIndex++,EASEMOB_IM_LOAD_CHATROOM_ERROR=tempIndex++,EASEMOB_IM_JOIN_CHATROOM_ERROR=tempIndex++,EASEMOB_IM_QUIT_CHATROOM_ERROR=tempIndex++,tempIndex=0,EASEMOB_IM_MESSAGE_REC_TEXT=tempIndex++,EASEMOB_IM_MESSAGE_REC_TEXT_ERROR=tempIndex++,EASEMOB_IM_MESSAGE_REC_EMOTION=tempIndex++,EASEMOB_IM_MESSAGE_REC_PHOTO=tempIndex++,EASEMOB_IM_MESSAGE_REC_AUDIO=tempIndex++,EASEMOB_IM_MESSAGE_REC_AUDIO_FILE=tempIndex++,EASEMOB_IM_MESSAGE_REC_VEDIO=tempIndex++,EASEMOB_IM_MESSAGE_REC_VEDIO_FILE=tempIndex++,EASEMOB_IM_MESSAGE_REC_FILE=tempIndex++,EASEMOB_IM_MESSAGE_SED_TEXT=tempIndex++,EASEMOB_IM_MESSAGE_SED_EMOTION=tempIndex++,EASEMOB_IM_MESSAGE_SED_PHOTO=tempIndex++,EASEMOB_IM_MESSAGE_SED_AUDIO=tempIndex++,EASEMOB_IM_MESSAGE_SED_AUDIO_FILE=tempIndex++,EASEMOB_IM_MESSAGE_SED_VEDIO=tempIndex++,EASEMOB_IM_MESSAGE_SED_VEDIO_FILE=tempIndex++,EASEMOB_IM_MESSAGE_SED_FILE=tempIndex++,EASEMOB_IM_FILESIZE_LIMIT=10485760,tempIndex=0;var STATUS_INIT=tempIndex++,STATUS_DOLOGIN_USERGRID=tempIndex++,STATUS_DOLOGIN_IM=tempIndex++,STATUS_OPENED=tempIndex++,STATUS_CLOSING=tempIndex++,STATUS_CLOSED=tempIndex++;delete tempIndex,Easemob.im.Connection=Connection,Easemob.im.EmMessage=EmMessage,Easemob.im.Helper=Easemob.im.Utils=Utils,window.Easemob=Easemob}(window,void 0),function(e){function t(i){if(n[i])return n[i].exports;var o=n[i]={exports:{},id:i,loaded:!1};return e[i].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var n={};return t.m=e,t.c=n,t.p="./",t(0)}({0:function(e,t,n){e.exports=n(228)},228:function(e,t,n){var i,o;(function(e){"use strict";var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s=n(230),a=n(231);window.WebIM="undefined"!=typeof WebIM?WebIM:{},WebIM.WebRTC=WebIM.WebRTC||{},WebIM.WebRTC.Call=a,WebIM.WebRTC.Util=s,"object"===r(e)&&"object"===r(e.exports)?e.exports=WebIM.WebRTC:(i=[],o=function(){return WebIM.WebRTC}.apply(t,i),!(void 0!==o&&(e.exports=o))),/Chrome/.test(navigator.userAgent)&&(WebIM.WebRTC.supportPRAnswer=navigator.userAgent.split("Chrome/")[1].split(".")[0]>=50?!0:!1)}).call(t,n(229)(e))},229:function(e,t){e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children=[],e.webpackPolyfill=1),e}},230:function(e,t){"use strict";function n(){}var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(){var e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");Math.uuid=function(t,n){var i,o=e,r=[];if(n=n||o.length,t)for(i=0;t>i;i++)r[i]=o[0|Math.random()*n];else{var s;for(r[8]=r[13]=r[18]=r[23]="-",r[14]="4",i=0;36>i;i++)r[i]||(s=0|16*Math.random(),r[i]=o[19==i?3&s|8:s])}return r.join("")},Math.uuidFast=function(){for(var t,n=e,i=new Array(36),o=0,r=0;36>r;r++)8==r||13==r||18==r||23==r?i[r]="-":14==r?i[r]="4":(2>=o&&(o=33554432+16777216*Math.random()|0),t=15&o,o>>=4,i[r]=n[19==r?3&t|8:t]);return i.join("")},Math.uuidCompact=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,n="x"==e?t:3&t|8;return n.toString(16)})}}();var o=function(){function e(e,n){var i=[];i.push(e);for(var o in n)i.push(n[o]);t.log.apply(t,i)}var t=this,n={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,FATAL:5},i=["TRACE","DEBUG","INFO","WARN","ERROR","FATAL"];this.log=function(){var e=arguments[0];e=arguments[0]="["+i[e]+"] ";arguments[1];WebIM&&WebIM.config&&WebIM.config.isDebug&&console.log.apply(console,arguments)},this.trace=function(){this.log&&e(n.TRACE,arguments)},this.debug=function(){this.log&&e(n.DEBUG,arguments)},this.info=function(){this.log&&e(n.INFO,arguments)},this.warn=function(){this.log&&e(n.WARN,arguments)},this.error=function(){this.log&&e(n.ERROR,arguments)},this.fatal=function(){this.log&&e(n.FATAL,arguments)}};n.prototype.logger=new o,n.prototype.parseJSON=function(e){return JSON.parse(e)};var r=(n.prototype.stringifyJSON=function(e){return JSON.stringify(e)},{}),s=r.toString,a=r.hasOwnProperty,c=a.toString,d=c.call(Object);n.prototype.isPlainObject=function(e){var t,n;return e&&"[object Object]"===s.call(e)?(t=Object.getPrototypeOf(e))?(n=a.call(t,"constructor")&&t.constructor,"function"==typeof n&&c.call(n)===d):!0:!1};n.prototype.isArray=Array.isArray,n.prototype.isEmptyObject=function(e){var t;for(t in e)return!1;return!0},n.prototype.type=function(e){return null==e?e+"":"object"===("undefined"==typeof e?"undefined":i(e))||"function"==typeof e?r[s.call(e)]||"object":"undefined"==typeof e?"undefined":i(e)},n.prototype.extend=function(){var e,t,n,o,r,s,a=this,c=arguments[0]||{},d=1,l=arguments.length,u=!1;for("boolean"==typeof c&&(u=c,c=arguments[d]||{},d++),"object"===("undefined"==typeof c?"undefined":i(c))||a.isFunction(c)||(c={}),d===l&&(c=this,d--);l>d;d++)if(null!=(e=arguments[d]))for(t in e)n=c[t],o=e[t],c!==o&&(u&&o&&(a.isPlainObject(o)||(r=a.isArray(o)))?(r?(r=!1,s=n&&a.isArray(n)?n:[]):s=n&&a.isPlainObject(n)?n:{},c[t]=a.extend(u,s,o)):void 0!==o&&(c[t]=o));return c},n.prototype.hasLocalStorage=function(e){return null==localStorage.getItem(e)||"{}"==localStorage.getItem(e)?!1:!0},n.prototype.toggleClass=function(e,t){return e.hasClass(t)?void e.removeClass(t):void e.addClass(t)},n.prototype.setCookie=function(e,t,n){var i=new Date;i.setTime(i.getTime()+60*n*60*1e3),document.cookie=e+"="+escape(t)+";expires="+i.toGMTString()},n.prototype.getCookie=function(e){var t=document.cookie.match(new RegExp("(^| )"+e+"=([^;]*)(;|$)"));return null!=t?unescape(t[2]):null},n.prototype.parseURL=function(e){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)","i"),n=window.location.search.substr(1).match(t);return null!=n?unescape(n[2]):null},e.exports=new n},231:function(e,t,n){"use strict";var i=n(230),o=n(232),r=n(233),s=n(234),a=n(235),c=r.RouteTo,d=r.Api,l=i.logger,u={api:null,caller:"",connection:null,pattern:null,listener:{onAcceptCall:function(e,t){},onRinging:function(e){},onTermCall:function(){},onIceConnectionStateChange:function(e){}},mediaStreamConstaints:{audio:!0,video:!0},init:function(){var e=this;if("undefined"==typeof e.connection)throw"Caller need a instance of Easemob.im.Connection";e.api=e.api||new d({imConnection:e.connection,rtcHandler:new o({imConnection:e.connection})}),e.api.onInitC=function(){e._onInitC.apply(e,arguments)},e.api.onIceConnectionStateChange=function(){e.listener.onIceConnectionStateChange.apply(e,arguments)}},makeVideoCall:function(e,t){var n={};i.extend(n,this.mediaStreamConstaints),this.call(e,n,t)},makeVoiceCall:function(e,t){var n=this,o={};i.extend(o,n.mediaStreamConstaints),n.mediaStreamConstaints.video=!1,n.call(e,o,t)},acceptCall:function(){var e=this;e.pattern.accept()},endCall:function(e){var t=this;t.caller="",t.pattern.termCall()},call:function(e,t,n){var i=this;this.callee=this.api.jid(e);var o=new c({rtKey:"",sid:n,success:function(e){l.debug("iq to server success",e)},fail:function(e){l.debug("iq to server error",e),i.onError(e)}});this.api.reqP2P(o,t.video?1:0,t.audio?1:0,this.api.jid(e),function(e,t){return"0"==t.online?void i.listener.onError({message:"callee is not online!"}):(i._onGotServerP2PConfig(e,t),void i.pattern.initC(i.mediaStreamConstaints,n))})},_onInitC:function(e,t,n,i,o){var r=this;r.callee=e,r._rtcCfg=t.rtcCfg,r._WebRTCCfg=t.WebRTC,r.sessId=t.sessId,r.rtcId=t.rtcId,r.switchPattern(),r.pattern._onInitC(e,t,n,i,o)},_onGotServerP2PConfig:function(e,t){var n=this;0==t.result&&(n._p2pConfig=t,n._rtcCfg=t.rtcCfg,n._rtcCfg2=t.rtcCfg2,n.sessId=t.sessId,n.rtcId="Channel_webIM",n._rtKey=n._rtkey=t.rtKey||t.rtkey,n._rtFlag=n._rtflag=t.rtFlag||t.rtflag,n._WebRTCCfg=t.WebRTC,n.admtok=t.admtok,n.tkt=t.tkt,n.switchPattern())},switchPattern:function(){var e=this;!e._WebRTCCfg&&(e.pattern=new a({callee:e.callee,_p2pConfig:e._p2pConfig,_rtcCfg:e._rtcCfg,_rtcCfg2:e._rtcCfg2,_rtKey:e._rtKey||e._rtkey,_rtFlag:e._rtFlag||e._rtflag,_sessId:e.sessId,_rtcId:e.rtcId,webRtc:new s({onGotLocalStream:e.listener.onGotLocalStream,onGotRemoteStream:e.listener.onGotRemoteStream,onError:e.listener.onError}),api:e.api,onAcceptCall:e.listener&&e.listener.onAcceptCall||function(){},onRinging:e.listener&&e.listener.onRinging||function(){},onTermCall:e.listener&&e.listener.onTermCall||function(){}}))}};e.exports=function(e){i.extend(!0,this,u,e||{}),this.init()}},232:function(e,t,n){"use strict";var i=n(230),o=i.logger,r=n(233),s=r.RouteTo,a="urn:xmpp:media-conference",c={_apiCallbacks:{},imConnection:null,_connectedSid:"",init:function(){var e,t=this,n=t.imConnection;n.addHandler=function(i,r,s,c,d,l,u){"function"!=typeof e&&(e=function(e){try{t.handleRtcMessage(e)}catch(n){throw o.error(n.stack||n),n}return!0},n.addHandler(e,a,"iq","set",null,null),n.addHandler(e,a,"iq","get",null,null)),n.context.stropheConn.addHandler(i,r,s,c,d,l,u)}},handleRtcMessage:function(e){var t=this,n=(e.getAttribute("id"),e.getAttribute("from")||"");n.lastIndexOf("/")>=0&&(n=n.substring(0,n.lastIndexOf("/")));var r=e.getElementsByTagName("rtkey")[0].innerHTML,a=e.getElementsByTagName("sid")[0].innerHTML;(t._fromSessionID||(t._fromSessionID={}))[n]=a;var c=e.getElementsByTagName("content"),d=(e.getElementsByTagName("stream_type")[0].innerHTML,c[0].innerHTML),l=i.parseJSON(d),u=l,p=l.tsxId;if(t.ctx=l.ctx,o.debug("Recv [op = "+u.op+"] [tsxId="+p+"]\r\n json :",e),n.indexOf("@")>=0)if(""==t._connectedSid&&102==u.op)t._connectedSid=a;else if(t._connectedSid!=a){if(102==u.op){var m=new s({to:n,rtKey:r,sid:a,success:function(e){o.debug("iq to server success",e)},fail:function(e){o.debug("iq to server error",e),t.onError(e)}}),h={data:{op:107,sessId:u.sessId,rtcId:u.rtcId,reason:"busy"},reason:"busy"};t.sendRtcMessage(m,h)}return}if(107==u.op&&(t._connectedSid="",t._fromSessionID={}),u.sdp&&("string"==typeof u.sdp&&(u.sdp=i.parseJSON(u.sdp)),u.sdp.type&&(u.sdp.type=u.sdp.type.toLowerCase())),u.cands){"string"==typeof u.cands&&(u.cands=i.parseJSON(u.cands));for(var f=0;f<u.cands.length;f++)"string"==typeof u.cands[f]&&(u.cands[f]=i.parseJSON(u.cands[f])),u.cands[f].sdpMLineIndex=u.cands[f].mlineindex,u.cands[f].sdpMid=u.cands[f].mid,delete u.cands[f].mlineindex,delete u.cands[f].mid}if(u.rtcCfg&&"string"==typeof u.rtcCfg&&(u.rtcCfg=i.parseJSON(u.rtcCfg)),u.rtcCfg2&&"string"==typeof u.rtcCfg2&&(u.rtcCfg2=i.parseJSON(u.rtcCfg2)),u.WebRTC&&"string"==typeof u.WebRTC&&(u.WebRTC=i.parseJSON(u.WebRTC)),p&&t._apiCallbacks[p])try{t._apiCallbacks[p].callback&&t._apiCallbacks[p].callback(n,u)}catch(g){throw g}finally{delete t._apiCallbacks[p]}else t.onRecvRtcMessage(n,u,r,p,a);return!0},onRecvRtcMessage:function(e,t,n,r,s){o.debug(" form : "+e+" \r\n json :"+i.stringifyJSON(rtcJSON))},convertRtcOptions:function(e){var t=e.data.sdp;if(t){var n={type:t.type,sdp:t.sdp};t=n,t.type=t.type.toUpperCase(),t=i.stringifyJSON(t),e.data.sdp=t}var o=e.data.cands;if(o){if(i.isArray(o));else{var r=[];r.push(o),o=r}for(var s in o)if(o[s]instanceof RTCIceCandidate){var a={type:"candidate",candidate:o[s].candidate,mlineindex:o[s].sdpMLineIndex,mid:o[s].sdpMid};o[s]=i.stringifyJSON(a)}e.data.cands=o}var c=e.data.rtcCfg;c&&"string"!=typeof c&&(e.data.rtcCfg=i.stringifyJSON(c));var d=e.data.WebRTC;d&&"string"!=typeof d&&(e.data.WebRTC=i.stringifyJSON(d))},sendRtcMessage:function(e,t,n){var r=this,s=r.imConnection,c=e.tsxId||s.getUniqueId(),d=e.to||s.domain,l=e.sid||r._fromSessionID&&r._fromSessionID[d];l=l||s.getUniqueId("CONFR_"),(r._fromSessionID||(r._fromSessionID={}))[d]=l,d.indexOf("@")>=0&&""==r._connectedSid&&102==t.data.op&&(r._connectedSid=l);var u=e.rtKey||e.rtkey;u||(u="");var p=e.rtflag;p||(p=1),t.data||(t.data={}),t.data.tsxId=c,r.ctx&&(t.data.ctx=r.ctx),r.convertRtcOptions(t);var m="VIDEO",h=e.id||s.getUniqueId("CONFR_"),f=$iq({id:h,to:d,from:s.context.jid,type:e.type||"get"}).c("query",{xmlns:a}).c("MediaReqExt").c("rtkey").t(u).up().c("rtflag").t(p).up().c("stream_type").t(m).up().c("sid").t(l).up().c("content").t(i.stringifyJSON(t.data));107==t.data.op&&t.reason&&f.up().c("reaseon").t(t.reason),o.debug("Send [op = "+t.data.op+"] : \r\n",f.tree()),n&&(r._apiCallbacks[c]={callback:n});var g=function(t){e.success(t)}||function(e){o.debug("send result. op:"+t.data.op+".",e)},_=function(t){e.fail(t)}||function(e){o.debug(e)};s.context.stropheConn.sendIQ(f.tree(),g,_),107==t.data.op&&r._connectedSid&&(e.sid&&r._connectedSid!=e.sid||(r._connectedSid="",r._fromSessionID={}))}},d=function(e){i.extend(!0,this,c,e||{}),this.init()};e.exports=d},233:function(e,t,n){"use strict";var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=n(230),r=o.logger,s={rtFlag:1,success:function(e){},fail:function(e){}},a=function d(e){if(!(this instanceof d)){var t=function(e){var t=this;o.extend(!0,t,e||{})};return o.extend(!0,t.prototype,s,e||{}),t}var n=this;o.extend(!0,n,s,e||{})};t.RouteTo=a;var c={imConnection:null,rtcHandler:null,events:{0:"onReqP2P",1:"onNewCfr",2:"onDelCfr",3:"onReqTkt",100:"onPing",101:"onPong",102:"onInitC",103:"onReqC",104:"onAcptC",105:"onTcklC",106:"onAnsC",107:"onTermC",300:"onEvEnter",301:"onEvExit",302:"onEvPub",303:"onEvUnpub",304:"onEvMems",204:"onEvClose",onServerError:"onServerError"},register:function(e){if("object"===("undefined"==typeof e?"undefined":i(e)))for(var t in e)this.bind(t,e[t])},bind:function(e,t){var n,i=this;(n=i.events[e])?i[n]=t:(n=i.events[e]="on_"+e,i[n]=t)},jid:function(e){return/^.+#.+_.+@.+$/g.test(e)?e:this.imConnection.context.appKey+"_"+e+"@"+this.imConnection.domain},reqP2P:function(e,t,n,i,o){r.debug("req p2p ...");var s={data:{op:0,video:t,audio:n,peer:i}};this.rtcHandler.sendRtcMessage(e,s,o)},newCfr:function(e,t,n,i){r.debug("newCfr ...");var o=this,s={data:{op:1}};t&&(s.data.reqTkt=t),n&&(s.data.password=n),o.rtcHandler.sendRtcMessage(e,s,i)},enter:function(e,t,n,i,o,s,a){r.debug("enter ...");var c=this,d={data:{op:200}};t&&(d.data.WebRTCId=t),n&&(d.data.reqMembers=n),i&&(d.data.tkt=i),o&&(d.data.nonce=o),s&&(d.data.digest=s),c.rtcHandler.sendRtcMessage(e,d,a)},ping:function(e,t,n){r.debug("ping ...");var i=this,o={data:{op:100}};t&&(o.data.sessId=t),i.rtcHandler.sendRtcMessage(e,o,n)},reqTkt:function(e,t,n){r.debug("reqTkt ...");var i=this,o={data:{op:3}};t&&(o.data.WebRTCId=t),i.rtcHandler.sendRtcMessage(e,o,n)},initC:function(e,t,n,i,o,s,a,c,d,l,u,p){r.debug("initC ...");var m={data:{op:102}};t&&(m.data.WebRTCId=t),n&&(m.data.tkt=n),i&&(m.data.sessId=i),o&&(m.data.rtcId=o),s&&(m.data.pubS=s),a&&(m.data.subS=a),c&&(m.data.sdp=c),d&&(m.data.cands=d),l&&(m.data.rtcCfg=l),u&&(m.data.WebRTC=u),this.rtcHandler.sendRtcMessage(e,m,p)},tcklC:function(e,t,n,i,o,s){r.debug("tcklC ...");var a=this,c={data:{op:105}};t&&(c.data.sessId=t),n&&(c.data.rtcId=n),i&&(c.data.sdp=i),o&&(c.data.cands=o),a.rtcHandler.sendRtcMessage(e,c,s)},ansC:function(e,t,n,i,o,s){r.debug("ansC ...");var a=this,c={data:{op:106}};t&&(c.data.sessId=t),n&&(c.data.rtcId=n),i&&(c.data.sdp=i),o&&(c.data.cands=o),a.rtcHandler.sendRtcMessage(e,c,s)},acptC:function(e,t,n,i,o,s,a){r.debug("acptC ...");var c=this,d={data:{op:104}};t&&(d.data.sessId=t),n&&(d.data.rtcId=n),i&&(d.data.sdp=i),o&&(d.data.cands=o),s&&(d.data.ans=s),c.rtcHandler.sendRtcMessage(e,d,a)},getMems:function(e,t,n,i){r.debug("getMems ...");var o=this,s={data:{op:203}};t&&(s.data.WebRTCId=t),n&&(s.data.sessId=n),o.rtcHandler.sendRtcMessage(e,s,i)},subC:function(e,t,n,i,o){r.debug("subC ...");var s=this,a={data:{op:205}};t&&(a.data.sessId=t),n&&(a.data.rtcId=n),i&&(a.data.subS=i),s.rtcHandler.sendRtcMessage(e,a,o)},usubC:function(e,t,n,i){r.debug("usubC ...");var o=this,s={data:{op:206}};t&&(s.data.sessId=t),n&&(s.data.rtcId=n),o.rtcHandler.sendRtcMessage(e,s,i)},termC:function(e,t,n,i,o){r.debug("termC ...");var s=this,a={data:{op:107}};t&&(a.data.sessId=t),n&&(a.data.rtcId=n),i&&(a.reason=i),s.rtcHandler.sendRtcMessage(e,a,o)},exit:function(e,t,n,i){r.debug("exit ...");var o=this,s={data:{op:201}};t&&(s.data.WebRTCId=t),n&&(s.data.sessId=n),o.rtcHandler.sendRtcMessage(e,s,i)},delCfr:function(e,t,n,i){r.debug("delCfr ...");var o=this,s={data:{op:2}};t&&(s.data.WebRTCId=t),n&&(s.data.admtok=n),o.rtcHandler.sendRtcMessage(e,s,i)}};t.Api=function(e){function t(e,t,i,o,s){if(0!=t.result&&n.onServerError)n.onServerError.call(n,e,t,i,o,s);else{var a;n.events[t.op]&&(a=n[n.events[t.op]])?a.call(n,e,t,i,o,s):r.info("can not handle(recvRtcMessage) the op: "+t.op,t)}}var n=this;o.extend(!0,this,c,e||{}),this.rtcHandler.onRecvRtcMessage=t}},234:function(e,t,n){"use strict";var i=n(230),o=i.logger,r={headerSection:null,audioSection:null,videoSection:null,_parseHeaderSection:function(e){var t=e.indexOf("m=audio");return t>=0?e.slice(0,t):(t=e.indexOf("m=video"),t>=0?e.slice(0,t):e)},_parseAudioSection:function(e){var t=e.indexOf("m=audio");if(t>=0){var n=e.indexOf("m=video");return e.slice(t,0>n?e.length:n)}},_parseVideoSection:function(e){var t=e.indexOf("m=video");return t>=0?e.slice(t):void 0},spiltSection:function(e){var t=this;t.headerSection=t._parseHeaderSection(e),t.audioSection=t._parseAudioSection(e),t.videoSection=t._parseVideoSection(e)},removeSSRC:function(e){for(var t=[],n=e.split(/a=ssrc:[^\n]+/g),i=0;i<n.length;i++)"\n"!=n[i]&&t.push(n[i]);return t.join("\n")},updateHeaderMsidSemantic:function(e){var t=this,n="a=msid-semantic: WMS "+e,i=t.headerSection.split(/a=msid\-semantic: WMS.*/g),o=[];switch(i.length){case 1:o.push(i[0]);break;case 2:o.push(i[0]),o.push(n),o.push("\n");break;case 3:o.push(i[0]),o.push(n),o.push("\n"),o.push(i[2]),o.push("\n")}return t.headerSection=o.join("")},updateAudioSSRCSection:function(e,t,n,i){var o=this;o.audioSection&&(o.audioSection=o.removeSSRC(o.audioSection)+o.ssrcSection(e,t,n,i))},updateVideoSSRCSection:function(e,t,n,i){var o=this;o.videoSection&&(o.videoSection=o.removeSSRC(o.videoSection)+o.ssrcSection(e,t,n,i))},getUpdatedSDP:function(){var e=this,t="";return e.headerSection&&(t+=e.headerSection),e.audioSection&&(t+=e.audioSection),e.videoSection&&(t+=e.videoSection),t},parseMsidSemantic:function(e){var t=this,n=/a=msid\-semantic: WMS (\S+)/gi,i=t._parseLine(e,n);return i&&2==i.length&&(t.msidSemantic={line:i[0],WMS:i[1]}),t.msidSemantic},ssrcSection:function(e,t,n,i){var o=["a=ssrc:"+e+" cname:"+t,"a=ssrc:"+e+" msid:"+n+" "+i,"a=ssrc:"+e+" mslabel:"+n,"a=ssrc:"+e+" label:"+i,""];return o.join("\n")},parseSSRC:function(e){var t=this,n=new RegExp("a=(ssrc):(\\d+) (\\S+):(\\S+)","ig"),i=t._parseLine(e,n);if(i){for(var o={lines:[],updateSSRCSection:t.ssrcSection},r=0;r<i.length;r++){var s=i[r];if(s.indexOf("a=ssrc")>=0)o.lines.push(s);else switch(s){case"ssrc":case"cname":case"msid":case"mslabel":case"label":o[s]=i[++r]}}return o}},_parseLine:function(e,t){for(var n,i=[];null!=(n=t.exec(e));)for(var o=0;o<n.length;o++)i.push(n[o]);return i.length>0?i:void 0}},s=function(e){i.extend(this,r),this.spiltSection(e)},a={mediaStreamConstaints:{audio:!0,video:!0},localStream:null,rtcPeerConnection:null,offerOptions:{offerToReceiveAudio:1,offerToReceiveVideo:1},createMedia:function(e,t){function n(e){o.debug("[WebRTC-API] got local stream"),i.localStream=e;var n=i.localStream.getVideoTracks(),r=i.localStream.getAudioTracks();n.length>0&&o.debug("[WebRTC-API] Using video device: "+n[0].label),r.length>0&&o.debug("[WebRTC-API] Using audio device: "+r[0].label),t?t(i,e):i.onGotStream(e)}var i=this;return e&&"function"==typeof e&&(t=e,e=null),o.debug("[WebRTC-API] begin create media ......"),navigator.mediaDevices.getUserMedia(e||i.mediaStreamConstaints).then(n).then(i.onCreateMedia)["catch"](function(e){o.debug("[WebRTC-API] getUserMedia() error: ",e),i.onError(e)})},setLocalVideoSrcObject:function(e){this.onGotLocalStream(e),o.debug("[WebRTC-API] you can see yourself !")},createRtcPeerConnection:function(e){o.debug("[WebRTC-API] begin create RtcPeerConnection ......");var t=this;e?(!e.iceServers&&(e.iceServers=[]),e.rtcpMuxPolicy="require",e.bundlePolicy="max-bundle",e.relayOnly&&(e.iceTransportPolicy="relay")):e=null,o.debug("[WebRTC-API] RtcPeerConnection config:",e),t.startTime=window.performance.now();var n=t.rtcPeerConnection=new RTCPeerConnection(e);o.debug("[WebRTC-API] Created local peer connection object",n),n.onicecandidate=function(e){("icecandidate"!=e.type||null!=e.candidate&&!/ tcp /.test(e.candidate.candidate))&&t.onIceCandidate(e)},n.onicestatechange=function(e){t.onIceStateChange(e)},n.oniceconnectionstatechange=function(e){t.onIceStateChange(e)},n.onaddstream=function(e){t._onGotRemoteStream(e)}},_uploadLocalStream:function(){this.rtcPeerConnection.addStream(this.localStream),o.debug("[WebRTC-API] Added local stream to RtcPeerConnection")},createOffer:function(e,t){var n=this;return n._uploadLocalStream(),o.debug("[WebRTC-API] createOffer start..."),n.rtcPeerConnection.createOffer(n.offerOptions).then(function(t){n.offerDescription=t,o.debug("[WebRTC-API] Offer "),o.debug("[WebRTC-API] setLocalDescription start"),n.rtcPeerConnection.setLocalDescription(t).then(n.onSetLocalSessionDescriptionSuccess,n.onSetSessionDescriptionError).then(function(){(e||n.onCreateOfferSuccess)(t)})},t||n.onCreateSessionDescriptionError)},createPRAnswer:function(e,t){var n=this;return o.info(" createPRAnswer start"),n.rtcPeerConnection.createAnswer().then(function(t){o.debug("[WebRTC-API] _____________PRAnswer "),t.type="pranswer",t.sdp=t.sdp.replace(/a=recvonly/g,"a=inactive"),n.prAnswerDescription=t,o.debug("[WebRTC-API] inactive PRAnswer "),o.debug("[WebRTC-API] setLocalDescription start"),n.rtcPeerConnection.setLocalDescription(t).then(n.onSetLocalSuccess,n.onSetSessionDescriptionError).then(function(){var i=new s(t.sdp);i.updateHeaderMsidSemantic("MS_0000"),i.updateAudioSSRCSection(1e3,"CHROME0000","MS_0000","LABEL_AUDIO_1000"),i.updateVideoSSRCSection(2e3,"CHROME0000","MS_0000","LABEL_VIDEO_2000"),t.sdp=i.getUpdatedSDP(),o.debug("[WebRTC-API] Send PRAnswer "),(e||n.onCreatePRAnswerSuccess)(t)})},t||n.onCreateSessionDescriptionError)},createAnswer:function(e,t){var n=this;return n._uploadLocalStream(),o.info("[WebRTC-API] createAnswer start"),n.rtcPeerConnection.createAnswer().then(function(t){o.debug("[WebRTC-API] _____________________Answer "),t.type="answer";var i=new s(t.sdp),r=i.parseMsidSemantic(i.headerSection),a=i.parseSSRC(i.audioSection),c=i.parseSSRC(i.videoSection);i.updateAudioSSRCSection(1e3,"CHROME0000",r.WMS,a.label),i.updateVideoSSRCSection(2e3,"CHROME0000",r.WMS,c.label),t.sdp=i.getUpdatedSDP(),n.answerDescription=t,o.debug("[WebRTC-API] Answer "),o.debug("[WebRTC-API] setLocalDescription start"),n.rtcPeerConnection.setLocalDescription(t).then(n.onSetLocalSuccess,n.onSetSessionDescriptionError).then(function(){var i=new s(t.sdp);i.updateHeaderMsidSemantic("MS_0000"),i.updateAudioSSRCSection(1e3,"CHROME0000","MS_0000","LABEL_AUDIO_1000"),i.updateVideoSSRCSection(2e3,"CHROME0000","MS_0000","LABEL_VIDEO_2000"),t.sdp=i.getUpdatedSDP(),o.debug("[WebRTC-API] Send Answer "),(e||n.onCreateAnswerSuccess)(t)})},t||n.onCreateSessionDescriptionError)},close:function(){var e=this;try{e.rtcPeerConnection&&e.rtcPeerConnection.close()}catch(t){}e.localStream&&e.localStream.getTracks().forEach(function(e){e.stop()}),e.localStream=null},addIceCandidate:function(e){var t=this;if(t.rtcPeerConnection){o.debug("[WebRTC-API] Add ICE candidate: \n",e);var n=i.isArray(e)?e:[];!i.isArray(e)&&n.push(e);for(var r=0;r<n.length;r++)e=n[r],t.rtcPeerConnection.addIceCandidate(new RTCIceCandidate(e)).then(t.onAddIceCandidateSuccess,t.onAddIceCandidateError)}},setRemoteDescription:function(e){var t=this;return o.debug("[WebRTC-API] setRemoteDescription start. "),e=new RTCSessionDescription(e),t.rtcPeerConnection.setRemoteDescription(e).then(t.onSetRemoteSuccess,t.onSetSessionDescriptionError)},iceConnectionState:function(){var e=this;return e.rtcPeerConnection.iceConnectionState},onCreateMedia:function(){o.debug("[WebRTC-API] media created.")},_onGotRemoteStream:function(e){o.debug("[WebRTC-API] onGotRemoteStream.",e),this.onGotRemoteStream(e.stream),o.debug("[WebRTC-API] received remote stream, you will see the other.")},onGotStream:function(e){o.debug("[WebRTC-API] on got a local stream")},onSetRemoteSuccess:function(){o.info("[WebRTC-API] onSetRemoteSuccess complete")},onSetLocalSuccess:function(){o.info("[WebRTC-API] setLocalDescription complete")},onAddIceCandidateSuccess:function(){o.debug("[WebRTC-API] addIceCandidate success")},onAddIceCandidateError:function(e){o.debug("[WebRTC-API] failed to add ICE Candidate: "+e.toString())},onIceCandidate:function(e){o.debug("[WebRTC-API] onIceCandidate : ICE candidate: \n"+e.candidate)},onIceStateChange:function(e){o.debug("[WebRTC-API] onIceStateChange : ICE state change event: ",e)},onCreateSessionDescriptionError:function(e){o.error("[WebRTC-API] Failed to create session description: "+e.toString())},onCreateOfferSuccess:function(e){o.debug("[WebRTC-API] create offer success")},onCreatePRAnswerSuccess:function(e){o.debug("[WebRTC-API] create answer success")},onCreateAnswerSuccess:function(e){o.debug("[WebRTC-API] create answer success")},onSetSessionDescriptionError:function(e){o.error("[WebRTC-API] onSetSessionDescriptionError : Failed to set session description: "+e.toString())},onSetLocalSessionDescriptionSuccess:function(){o.debug("[WebRTC-API] onSetLocalSessionDescriptionSuccess : setLocalDescription complete")}};e.exports=function(e){i.extend(!0,this,a,e||{})}},235:function(e,t,n){"use strict";var i=n(230),o=n(233).RouteTo,r=i.logger,s=o({success:function(e){r.debug("iq to server success",e)},fail:function(e){r.debug("iq to server error",e)}}),a={_pingIntervalId:null,_p2pConfig:null,_rtcCfg:null,_rtcCfg2:null,_rtKey:null,_rtFlag:null,webRtc:null,api:null,callee:null,consult:!1,init:function(){var e=this;e.api.onPing=function(){e._onPing.apply(e,arguments)},e.api.onTcklC=function(){e._onTcklC.apply(e,arguments)},e.api.onAcptC=function(){e._onAcptC.apply(e,arguments)},e.api.onAnsC=function(){e._onAnsC.apply(e,arguments)},e.api.onTermC=function(){e._onTermC.apply(e,arguments)},e.webRtc.onIceCandidate=function(){e._onIceCandidate.apply(e,arguments)},e.webRtc.onIceStateChange=function(){e._onIceStateChange.apply(e,arguments)}},_ping:function(){function e(){var e=new s({to:t.callee,rtKey:t._rtKey});t.api.ping(e,t._sessId,function(e,t){r.debug("ping result",t)})}var t=this;t._pingIntervalId=window.setInterval(e,59e3)},_onPing:function(e,t,n,i,o){r.debug("_onPing from",o)},initC:function(e,t){var n=this;n.sid=t,n.createLocalMedia(e)},createLocalMedia:function(e){var t=this;t.consult=!1,this.webRtc.createMedia(e,function(e,n){e.setLocalVideoSrcObject(n),t.webRtc.createRtcPeerConnection(t._rtcCfg),t.webRtc.createOffer(function(e){t._onGotWebRtcOffer(e),t._onHandShake()})})},_onGotWebRtcOffer:function(e){var t=this,n=new s({sid:t.sid,to:t.callee,rtKey:t._rtKey});t.api.initC(n,null,null,t._sessId,t._rtcId,null,null,e,null,t._rtcCfg2,null,function(e,t){r.debug("initc result",t)}),t._ping()},_onAcptC:function(e,t){var n=this;t.ans&&1==t.ans&&(r.info("[WebRTC-API] _onAcptC : 104, ans = 1, it is a answer. will onAcceptCall"),n.onAcceptCall(e,t),n._onAnsC(e,t)),WebIM.WebRTC.supportPRAnswer?(r.info("[WebRTC-API] _onAcptC : recv pranswer. "),(t.sdp||t.cands)&&(t.sdp&&n.webRtc.setRemoteDescription(t.sdp),
t.cands&&n._onTcklC(e,t),n.onAcceptCall(e,t))):(r.info("[WebRTC-API] _onAcptC : not supported pranswer. drop it. will onAcceptCall"),n.onAcceptCall(e,t))},onAcceptCall:function(e,t){},_onAnsC:function(e,t){var n=this;r.info("[WebRTC-API] _onAnsC : recv answer. "),t.sdp&&n.webRtc.setRemoteDescription(t.sdp),t.cands&&n._onTcklC(e,t)},_onInitC:function(e,t,n,i,o){var s=this;s.consult=!1,s.callee=e,s._rtcCfg2=t.rtcCfg,s._rtKey=n,s._tsxId=i,s._fromSid=o,s._rtcId=t.rtcId,s._sessId=t.sessId,s.webRtc.createRtcPeerConnection(s._rtcCfg2),t.cands&&s._onTcklC(e,t),t.sdp&&s.webRtc.setRemoteDescription(t.sdp).then(function(){s._onHandShake(e,t),WebIM.WebRTC.supportPRAnswer?s.webRtc.createPRAnswer(function(e){s._onGotWebRtcPRAnswer(e),setTimeout(function(){r.info("[WebRTC-API] onRinging : after send pranswer. ",s.callee),s.onRinging(s.callee)},500)}):(setTimeout(function(){r.info("[WebRTC-API] onRinging : After iniC, cause by: not supported pranswer. ",s.callee),s.onRinging(s.callee)},500),s._ping())})},_onGotWebRtcPRAnswer:function(e){var t=this,n=new s({to:t.callee,rtKey:t._rtKey});t.api.acptC(n,t._sessId,t._rtcId,e),t._ping()},onRinging:function(e){},accept:function(){function e(){r.info("createAndSendAnswer : ...... "),t.webRtc.createAnswer(function(e){var n=new s({to:t.callee,rtKey:t._rtKey});WebIM.WebRTC.supportPRAnswer?t.api.ansC(n,t._sessId,t._rtcId,e):t.api.acptC(n,t._sessId,t._rtcId,e,null,1)})}var t=this;t.webRtc.createMedia(function(t,n){t.setLocalVideoSrcObject(n),e()})},_onHandShake:function(e,t){var n=this;n.consult=!0,r.info("hand shake over. may switch cands."),t&&setTimeout(function(){n._onTcklC(e,t)},100),setTimeout(function(){n._onIceCandidate()},100)},_onTcklC:function(e,t){var n=this;if(n.consult)r.info("[WebRTC-API] recv and add cands."),n._recvCands&&n._recvCands.length>0&&n.webRtc.addIceCandidate(n._recvCands),t&&t.cands&&n.webRtc.addIceCandidate(t.cands);else if(t&&t.cands&&t.cands.length>0){for(var i=0;i<t.cands.length;i++)(n._recvCands||(n._recvCands=[])).push(t.cands[i]);r.debug("[_onTcklC] temporary memory[recv] ice candidate. util consult = true")}},_onIceStateChange:function(e){var t=this;e&&r.debug("[WebRTC-API] "+t.webRtc.iceConnectionState()+" |||| ice state is "+e.target.iceConnectionState),t.api.onIceConnectionStateChange(t.webRtc.iceConnectionState())},_onIceCandidate:function(e){var t=this;if(t.consult){var n=function(e){r.debug("send ice candidate...");var n=new s({to:t.callee,rtKey:t._rtKey});e&&t.api.tcklC(n,t._sessId,t._rtcId,null,e)};t._cands&&t._cands.length>0&&(n(t._cands),t._cands=[]),e&&e.candidate&&n(e.candidate)}else e&&e.candidate&&(t._cands||(t._cands=[])).push(e.candidate),r.debug("[_onIceCandidate] temporary memory[send] ice candidate. util consult = true")},termCall:function(e){var t=this;t._pingIntervalId&&window.clearInterval(t._pingIntervalId);var n=new s({to:t.callee,rtKey:t._rtKey});t.hangup||t.api.termC(n,t._sessId,t._rtcId,e),t.webRtc.close(),t.hangup=!0,t.onTermCall(e)},_onTermC:function(e,t){var n=this;n.hangup=!0,n.termCall(t.reason)},onTermCall:function(){}};e.exports=function(e){var t=this;i.extend(!0,this,a,e||{}),t.init()}}}),window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL,Date.prototype.format=function(e){var t={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds()};/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var n in t)new RegExp("("+n+")").test(e)&&(e=e.replace(RegExp.$1,1===RegExp.$1.length?t[n]:("00"+t[n]).substr((""+t[n]).length)));return e},Array.prototype.indexOf||(Array.prototype.indexOf=function(e){var t=this.length,n=Number(arguments[1])||0;for(n=0>n?Math.ceil(n):Math.floor(n),0>n&&(n+=t);t>n;n++)if(n in this&&this[n]===e)return n;return-1}),String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")}),function(){window.easemobim=window.easemobim||{};var e=/android/i.test(navigator.useragent),t=/mobile/i.test(navigator.userAgent),n=function(){var e,t;return t=navigator.userAgent.match(/MSIE (\d+)/i),e=t&&t[1]?+t[1]:9999}();easemobim.utils={isTop:window.top===window.self,nodeListType:{"[object Object]":!0,"[object NodeList]":!0,"[object HTMLCollection]":!0,"[object Array]":!0},isSupportWebRTC:!!(window.webkitRTCPeerConnection||window.mozRTCPeerConnection||window.RTCPeerConnection),filesizeFormat:function(e){var t,n,i=["B","KB","MB","GB","TB","PB","EB","ZB"];return e?(t=Math.floor(Math.log(e)/Math.log(1024)),n=(e/Math.pow(1024,t)).toFixed(2)+" "+i[t]):n="0 B",n},uuid:function(){for(var e=[],t="0123456789abcdef",n=0;36>n;n++)e[n]=t.substr(Math.floor(16*Math.random()),1);return e[14]="4",e[19]=t.substr(3&e[19]|8,1),e[8]=e[13]=e[18]=e[23]="-",e.join("")},convertFalse:function(e){return e="undefined"==typeof e?"":e,"false"===e?!1:e},$Dom:function(e){return document.getElementById(e)},each:function(e,t){for(var n in e)e.hasOwnProperty(n)&&"function"==typeof t&&t(n,e[n])},$Remove:function(e){e&&(e.remove?e.remove():e.parentNode&&e.parentNode.removeChild(e))},siblings:function(e,t){if(!e||!e.parentNode)return null;for(var n=e.parentNode.childNodes,i=[],o=0,r=n.length;r>o;o++)1===n[o].nodeType&&n[o]!=e&&t&&this.hasClass(n[o],t)&&i.push(n[o]);return i},insertBefore:function(e,t,n){e&&t&&(0===e.childNodes.length?e.appendChild(t):e.insertBefore(t,n||null))},getIEVersion:n,live:function(e,t,n,i){var o=this,r=i||document;o.on(r,t,function(t){var i=t||window.event,s=i.target||i.srcElement,a=e.split(".").length<2?r.getElementsByTagName(e):o.$Class(e);if(a.length)for(var c=a.length,d=0;c>d;d++)(a[d]==s||a[d]==s.parentNode)&&n.apply(a[d]==s?s:s.parentNode,arguments);else a==e&&n.apply(e,arguments)})},on:function(){var e=function(e,t,n,i){if(!t)return!1;for(var o=t.split(" "),r=0,s=o.length;s>r;r++)e.addEventListener?e.addEventListener(o[r],n,i):e.attachEvent?(e["_"+o[r]]=function(){n.apply(e,arguments)},e.attachEvent("on"+o[r],e["_"+o[r]])):e["on"+o[r]]=n};return function(t,n,i,o){if(Object.prototype.toString.call(t)in this.nodeListType&&t.length)for(var r=0,s=t.length;s>r;r++)1===t[r].nodeType&&e(t[r],n,i,o);else e(t,n,i,o)}}(),remove:function(e,t,n){e&&(e.removeEventListener?e.removeEventListener(t,n):e.detachEvent?e.detachEvent("on"+t,e["_"+t]):e["on"+t]=null)},one:function(e,t,n,i){var o=this,r=function(){n.apply(this,arguments),o.remove(e,t,r)};o.on(e,t,r,i)},trigger:function(e,t){if(document.createEvent){var n=document.createEvent("HTMLEvents");n.initEvent(t,!0,!1),e.dispatchEvent(n)}else e.fireEvent("on"+t)},extend:function(e,t){for(var n in t)if(t.hasOwnProperty(n)){var i=Object.prototype.toString.call(t[n]);"[object Array]"===i?(e[n]=[],this.extend(e[n],t[n])):"[object Object]"===i?(e[n]={},this.extend(e[n],t[n])):e[n]=t[n]}return e},addClass:function(e,t){var n,i;if(e){if(Object.prototype.toString.call(e)in this.nodeListType&&e.length)for(n=0,i=e.length;i>n;n++)this.hasClass(e[n],t)||"undefined"==typeof e[n].className||(e[n].className+=" "+t);else this.hasClass(e,t)||(e.className+=" "+t);return e}},removeClass:function(e,t){var n,i;if(e){if(e.length&&Object.prototype.toString.call(e)in this.nodeListType)for(n=0,i=e.length;i>n;n++)"undefined"!=typeof e[n].className&&this.hasClass(e[n],t)&&(e[n].className=(" "+e[n].className+" ").replace(new RegExp(" "+t+" ","g")," ").trim());else"undefined"!=typeof e.className&&this.hasClass(e,t)&&(e.className=(" "+e.className+" ").replace(new RegExp(" "+t+" ","g")," ").trim());return e}},hasClass:function(e,t){return e?!!~(" "+e.className+" ").indexOf(" "+t+" "):!1},toggleClass:function(e,t,n){var i;e&&t&&(i="undefined"!=typeof n?n:!this.hasClass(e,t),i?this.addClass(e,t):this.removeClass(e,t))},$Class:function(e,t){var n=e.split("."),i=n[0],o=n[1],r=t||document;if(r.getElementsByClassName)return r.getElementsByClassName(o);for(var s=r.getElementsByTagName(i),a=[],c=0,d=s.length;d>c;c++)this.hasClass(s[c],o)&&a.push(s[c]);return s=null,a},html:function(e,t){return e?"undefined"==typeof t?e.innerHTML:(e.innerHTML=t,e):void 0},encode:function(e){if(!e||0===e.length)return"";var t="";return t=e.replace(/&amp;/g,"&"),t=t.replace(/<(?=[^o][^)])/g,"&lt;"),t=t.replace(/>/g,"&gt;"),t=t.replace(/\"/g,"&quot;")},decode:function(e){if(!e||0===e.length)return"";var t="";return t=e.replace(/&amp;/g,"&"),t=t.replace(/&#39;/g,"'"),t=t.replace(/&lt;o\)/g,"<o)")},query:function(e){var t=new RegExp("[?&]"+e+"=([^&]*)(?=&|$)"),n=t.exec(location.search);return n?n[1]:""},isAndroid:e,isMobile:t,click:t&&"ontouchstart"in window?"touchstart":"click",isQQBrowserInAndroid:e&&/MQQBrowser/.test(navigator.userAgent),isMin:function(){return document.visibilityState&&"hidden"===document.visibilityState||document.hidden},setStore:function(e,t){try{localStorage.setItem(e,t)}catch(n){}},getStore:function(e){try{return localStorage.getItem(e)}catch(t){}},clearStore:function(e){try{localStorage.removeItem(e)}catch(t){}},clearAllStore:function(){try{localStorage.clear()}catch(e){}},set:function(e,t,n){var i=new Date,o=i.getTime()+24*(n||30)*3600*1e3;i.setTime(o),document.cookie=encodeURIComponent(e)+"="+encodeURIComponent(t)+";path=/;expires="+i.toGMTString()},get:function(e){var t,n=document.cookie.match("(^|;) ?"+encodeURIComponent(e)+"=([^;]*)(;|$)");return t=n?decodeURIComponent(n[2]):""},getAvatarsFullPath:function(e,t){var n=null;if(!e)return n;e=e.replace(/^(https?:)?\/\/?/,"");var i=e.indexOf("img-cn")>0?!0:!1,o=e.indexOf("ossimages")>0?!0:!1;return i&&!o?t+"/ossimages/"+e:"//"+e},getConfig:function(e){for(var t,n={},i=document.scripts,o=0,r=i.length;r>o;o++)if(~i[o].src.indexOf("easemob.js")){t=i[o].src;break}if(!t)return{json:n,domain:""};for(var s,a=t.indexOf("?"),c=~t.indexOf("//")?t.indexOf("//"):0,d=t.slice(c,t.indexOf("/",c+2)),l=t.slice(a+1).split("&"),u=0,p=l.length;p>u;u++)s=l[u].split("="),n[s[0]]=s.length>1?decodeURIComponent(s[1]):"";return{json:n,domain:d}},updateAttribute:function(e,t,n){var i=e||location.protocol+n+"/im.html?tenantId=";for(var o in t)t.hasOwnProperty(o)&&"undefined"!=typeof t[o]&&(~i.indexOf(o+"=")?i=i.replace(new RegExp(o+"=[^&#?]*","gim"),o+"="+(""!==t[o]?t[o]:"")):i+="&"+o+"="+(""!==t[o]?t[o]:""));return i},copy:function(e){return this.extend({},e)},code:function(){var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",t={encode:function(t){var n,i,o,r,s,a,c,d="",l=0;do n=t.charCodeAt(l++),i=t.charCodeAt(l++),o=t.charCodeAt(l++),r=n>>2,s=(3&n)<<4|i>>4,a=(15&i)<<2|o>>6,c=63&o,isNaN(i)?a=c=64:isNaN(o)&&(c=64),d=d+e.charAt(r)+e.charAt(s)+e.charAt(a)+e.charAt(c);while(l<t.length);return d},byteEncode:function(t){var n,i,o,r,s,a,c,d="",l=0;do n=t[l++],i=t[l++],o=t[l++],r=n>>2,s=(3&n)<<4|i>>4,a=(15&i)<<2|o>>6,c=63&o,isNaN(i)?a=c=64:isNaN(o)&&(c=64),d=d+e.charAt(r)+e.charAt(s)+e.charAt(a)+e.charAt(c);while(l<t.length);return d},decode:function(t){var n,i,o,r,s,a,c,d="",l=0;t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");do r=e.indexOf(t.charAt(l++)),s=e.indexOf(t.charAt(l++)),a=e.indexOf(t.charAt(l++)),c=e.indexOf(t.charAt(l++)),n=r<<2|s>>4,i=(15&s)<<4|a>>2,o=(3&a)<<6|c,d+=String.fromCharCode(n),64!=a&&(d+=String.fromCharCode(i)),64!=c&&(d+=String.fromCharCode(o));while(l<t.length);return d}};return t}()}}(),function(){var e={agentStatusText:{Idle:"(离线)",Online:"(空闲)",Busy:"(忙碌)",Leave:"(离开)",Hidden:"(隐身)",Offline:"(离线)",Logout:"(离线)",Other:""},UPLOAD_FILESIZE_LIMIT:10485760,UPLOAD_IMG_TYPE:["gif","jpg","jpeg","png","bmp"],agentStatusClassName:{Idle:"online",Online:"online",Busy:"busy",Leave:"leave",Hidden:"hidden",Offline:"offline",Logout:"offline",Other:"hide"},eventMessageText:{TRANSFERING:"会话转接中，请稍候",TRANSFER:"会话已被转接至其他客服",LINKED:"会话已被客服接起",CLOSED:"会话已结束",NOTE:"当前暂无客服在线，请您留下联系方式，稍后我们将主动联系您",CREATE:"会话创建成功"},themeMap:{"天空之城":"theme-1","丛林物语":"theme-2","红瓦洋房":"theme-3","鲜美橙汁":"theme-4","青草田间":"theme-5","湖光山色":"theme-6","冷峻山峰":"theme-7","月色池塘":"theme-8","天籁湖光":"theme-9","商务风格":"theme-10"}};window.easemobim=window.easemobim||{},easemobim._const=e,easemobim.LISTSPAN=10,easemobim.PICTYPE={jpg:!0,gif:!0,png:!0,bmp:!0},easemobim.FILETYPE={zip:!0,doc:!0,docx:!0,txt:!0,gif:!0},easemobim.LOADING=!easemobim.utils.isQQBrowserInAndroid&&easemobim.utils.getIEVersion>9?["<div class='em-widget-loading'><svg version='1.1' id='图层_1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' x='0px' y='0px'"," viewBox='0 0 70 70' enable-background='new 0 0 70 70' xml:space='preserve'>","<circle opacity='0.3' fill='none' stroke='#000000' stroke-width='4' stroke-miterlimit='10' cx='35' cy='35' r='11'/>","<path fill='none' stroke='#E5E5E5' stroke-width='4' stroke-linecap='round' stroke-miterlimit='10' d='M24,35c0-6.1,4.9-11,11-11","c2.8,0,5.3,1,7.3,2.8'/><image src='//kefu.easemob.com/webim/static/img/loading.gif' width='20' style='margin-top:10px;' /></svg></div>"].join(""):"<img src='//kefu.easemob.com/webim/static/img/loading.gif' width='20' style='margin-top:10px;'/>",Easemob.im.EMOTIONS={path:"static/img/faces/",map:{"[):]":"ee_1.png","[:D]":"ee_2.png","[;)]":"ee_3.png","[:-o]":"ee_4.png","[:p]":"ee_5.png","[(H)]":"ee_6.png","[:@]":"ee_7.png","[:s]":"ee_8.png","[:$]":"ee_9.png","[:(]":"ee_10.png","[:'(]":"ee_11.png","[:|]":"ee_12.png","[(a)]":"ee_13.png","[8o|]":"ee_14.png","[8-|]":"ee_15.png","[+o(]":"ee_16.png","[<o)]":"ee_17.png","[|-)]":"ee_18.png","[*-)]":"ee_19.png","[:-#]":"ee_20.png","[:-*]":"ee_21.png","[^o)]":"ee_22.png","[8-)]":"ee_23.png","[(|)]":"ee_24.png","[(u)]":"ee_25.png","[(S)]":"ee_26.png","[(*)]":"ee_27.png","[(#)]":"ee_28.png","[(R)]":"ee_29.png","[({)]":"ee_30.png","[(})]":"ee_31.png","[(k)]":"ee_32.png","[(F)]":"ee_33.png","[(W)]":"ee_34.png","[(D)]":"ee_35.png"}}}(),function(){var e=function(){},t=function(){try{return new window.XMLHttpRequest}catch(e){return!1}},n=function(){try{return new window.ActiveXObject("Microsoft.XMLHTTP")}catch(e){return!1}},i=function(i){var o=i.dataType||"text",r=i.success||e,s=i.error||e,a=t()||n();a.onreadystatechange=function(){if(4===a.readyState){var e=a.status||0;if(200===e){if("text"===o)return void r(a.responseText,a);if("json"===o){try{var t=JSON.parse(a.responseText);r(t,a)}catch(n){}return}return void r(a.response||a.responseText,a)}if("json"==o){try{var t=JSON.parse(a.responseText);s(t,a,"服务器返回错误信息")}catch(n){s(a.responseText,a,"服务器返回错误信息")}return}return void s(a.responseText,a,"服务器返回错误信息")}0===a.readyState&&s(a.responseText,a,"服务器异常")};var c=i.type||"GET",d=i.data||{},l="";if("get"===c.toLowerCase()){for(var u in d)d.hasOwnProperty(u)&&(l+=u+"="+d[u]+"&");l=l?l.slice(0,-1):l,i.url+=(i.url.indexOf("?")>0?"&":"?")+(l?l+"&":l)+"_v="+(new Date).getTime(),d=null}else d._v=(new Date).getTime(),d=JSON.stringify(d);if(a.open(c,i.url),a.setRequestHeader){var p=i.headers||{};p["Content-Type"]=p["Content-Type"]||"application/json";for(var m in p)p.hasOwnProperty(m)&&a.setRequestHeader(m,p[m])}return a.send(d),a};window.easemobim=window.easemobim||{},window.easemobim.emajax=i}(),window.easemobim=window.easemobim||{},window.easemobIM=window.easemobIM||{},easemobIM.Transfer=easemobim.Transfer=function(){"use strict";var e=function(e,t,n){if("string"==typeof e.data){var i=JSON.parse(e.data),o=!1;if(n&&n.length)for(var r=0,s=n.length;s>r;r++)i.key===n[r]&&(o=!0,"function"==typeof t&&t(i));else"function"==typeof t&&t(i);if(!o&&n)for(var r=0,s=n.length;s>r;r++)if("data"===n[r]){"function"==typeof t&&t(i);break}}},t=function(e,n){return this instanceof t?(this.key=n,this.iframe=document.getElementById(e),void(this.origin=location.protocol+"//"+location.host)):new t(e)};return t.prototype.send=function(e,t){return e.origin=this.origin,e.key=this.key,t&&(e.to=t),e=JSON.stringify(e),this.iframe?this.iframe.contentWindow.postMessage(e,"*"):window.parent.postMessage(e,"*"),this},t.prototype.listen=function(t,n){var i=this;return window.addEventListener?window.addEventListener("message",function(o){e.call(i,o,t,n)},!1):window.attachEvent&&window.attachEvent("onmessage",function(o){e.call(i,o,t,n)}),this},t}(),function(){var e=new easemobim.Transfer(null,"api"),t=function(t){var n=null;return t.msg.data&&t.msg.data.headers&&(n=t.msg.data.headers,delete t.msg.data.headers),{url:t.url,headers:n,data:t.excludeData?null:t.msg.data,type:t.type||"GET",success:function(n){try{n=JSON.parse(n)}catch(i){}e.send({call:t.msg.api,timespan:t.msg.timespan,status:0,data:n})},error:function(n){try{n=JSON.parse(n)}catch(i){}e.send({call:t.msg.api,timespan:t.msg.timespan,status:1,data:n})}}};e.listen(function(n){switch(e.targetOrigin=n.origin,n.api){case"getRelevanceList":easemobim.emajax(t({url:"/v1/webimplugin/targetChannels",msg:n}));break;case"getDutyStatus":easemobim.emajax(t({url:"/v1/webimplugin/showMessage",msg:n}));break;case"getWechatVisitor":easemobim.emajax(t({url:"/v1/webimplugin/visitors/wechat/"+n.data.openid+"?tenantId="+n.data.tenantId,msg:n,type:"POST"}));break;case"createVisitor":easemobim.emajax(t({url:"/v1/webimplugin/visitors?tenantId="+n.data.tenantId,msg:n,type:"POST"}));break;case"getSession":easemobim.emajax(t({url:"/v1/webimplugin/visitors/"+n.data.id+"/schedule-data?techChannelInfo="+n.data.orgName+"%23"+n.data.appName+"%23"+n.data.imServiceNumber+"&tenantId="+n.data.tenantId,msg:n,excludeData:!0}));break;case"getExSession":easemobim.emajax(t({url:"/v1/webimplugin/visitors/"+n.data.id+"/schedule-data-ex?techChannelInfo="+n.data.orgName+"%23"+n.data.appName+"%23"+n.data.imServiceNumber+"&tenantId="+n.data.tenantId,msg:n,excludeData:!0}));break;case"getPassword":easemobim.emajax(t({url:"/v1/webimplugin/visitors/password",msg:n}));break;case"getGroup":easemobim.emajax(t({url:"/v1/webimplugin/visitors/"+n.data.id+"/ChatGroupId?techChannelInfo="+n.data.orgName+"%23"+n.data.appName+"%23"+n.data.imServiceNumber+"&tenantId="+n.data.tenantId,msg:n,excludeData:!0}));break;case"getGroupNew":easemobim.emajax(t({url:"/v1/webimplugin/tenant/"+n.data.tenantId+"/visitors/"+n.data.id+"/ChatGroupId?techChannelInfo="+n.data.orgName+"%23"+n.data.appName+"%23"+n.data.imServiceNumber+"&tenantId="+n.data.tenantId,msg:n,excludeData:!0}));break;case"getHistory":easemobim.emajax(t({url:"/v1/webimplugin/visitors/msgHistory",msg:n}));break;case"getSlogan":easemobim.emajax(t({url:"/v1/webimplugin/notice/options",msg:n}));break;case"getTheme":easemobim.emajax(t({url:"/v1/webimplugin/theme/options",msg:n}));break;case"getSystemGreeting":easemobim.emajax(t({url:"/v1/webimplugin/welcome",msg:n}));break;case"getRobertGreeting":easemobim.emajax(t({url:"/v1/Tenants/"+n.data.tenantId+"/robots/visitor/greetings/"+n.data.originType+"?tenantId="+n.data.tenantId,msg:n,excludeData:!0}));break;case"sendVisitorInfo":easemobim.emajax(t({url:"/v1/webimplugin/tenants/"+n.data.tenantId+"/visitors/"+n.data.visitorId+"/attributes?tenantId="+n.data.tenantId,msg:n,type:"POST"}));break;case"getProject":easemobim.emajax(t({url:"/tenants/"+n.data.tenantId+"/projects",msg:n}));break;case"createTicket":easemobim.emajax(t({url:"/tenants/"+n.data.tenantId+"/projects/"+n.data.projectId+"/tickets?tenantId="+n.data.tenantId+"&easemob-target-username="+n.data["easemob-target-username"]+"&easemob-appkey="+n.data["easemob-appkey"]+"&easemob-username="+n.data["easemob-username"],msg:n,type:"POST"}));break;case"receiveMsgChannel":easemobim.emajax(t({url:"/v1/imgateway/messages",msg:n}));break;case"sendMsgChannel":easemobim.emajax(t({url:"/v1/imgateway/messages?tenantId="+n.data.tenantId,msg:n,type:"POST"}));break;case"getAgentStatus":easemobim.emajax(t({url:"/v1/tenants/"+n.data.tenantId+"/agents/"+n.data.agentUserId+"/agentstate",msg:n}));break;case"getNickNameOption":easemobim.emajax(t({url:"/v1/webimplugin/agentnicename/options?tenantId="+n.data.tenantId,msg:n,excludeData:!0}));break;case"reportEvent":easemobim.emajax(t({url:"/v1/event_collector/events",msg:n,type:"POST"}));break;case"deleteEvent":easemobim.emajax(t({url:"/v1/event_collector/event/"+encodeURIComponent(n.data.userId),msg:n,type:"DELETE",excludeData:!0}));break;case"mediaStreamUpdateStatus":var i=n.data.streamId;delete n.data.streamId,easemobim.emajax(t({url:"/v1/rtcmedia/media_streams/"+i,msg:n,type:"PUT"}));break;case"graylist":easemobim.emajax(t({url:"/management/graylist",msg:n,excludeData:!0}));break;case"getCurrentServiceSession":easemobim.emajax(t({url:"/v1/webimplugin/tenant/"+n.data.tenantId+"/visitors/"+n.data.id+"/CurrentServiceSession?techChannelInfo="+n.data.orgName+"%23"+n.data.appName+"%23"+n.data.imServiceNumber+"&tenantId="+n.data.tenantId,msg:n,excludeData:!0}))}},["data"])}(),easemobim.EVENTS={NOTIFY:{event:"notify"},RECOVERY:{event:"recoveryTitle"},SHOW:{event:"showChat"},CLOSE:{event:"closeChat"},CACHEUSER:{event:"setUser"},DRAGREADY:{event:"dragReady"},DRAGEND:{event:"dragEnd"},SLIDE:{event:"titleSlide"},ONMESSAGE:{event:"onMessage"},ONSESSIONCLOSED:{event:"onSessionClosed"},EXT:{event:"ext"},TEXTMSG:{event:"textmsg"},ONREADY:{event:"onready"}},easemobim.autogrow=function(){return function(e){var t=easemobim.utils,n=e.dom,i=n.getBoundingClientRect().height,o=(n.style.lineHeight,document.createElement("div"));o.style.cssText=["position:absolute;","top:-10000px;","left:-10000px;","width:"+(n.getBoundingClientRect().width-45)+"px;","font-size:"+(n.style.fontSize||17)+"px;","line-height:"+(n.style.lineHeight||17)+"px;","resize:none;","word-wrap:break-word;"].join(""),document.body.appendChild(o);var r=function(){var t=function(e,t){for(var n=0,i="";t>n;n++)i+=e;return i},n=this.value.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/&/g,"&amp;").replace(/\n$/,"<br/>&nbsp;").replace(/\n/g,"<br/>").replace(/ {2,}/g,function(e){return t("&nbsp;",e.length-1)+" "});o.innerHTML=n,n&&(this.style.height=Math.max(o.getBoundingClientRect().height+17,i)+"px"),"function"==typeof e.callback&&e.callback()};t.on(n,"change",r),t.on(n,"keyup",r),t.on(n,"keydown",r),e.update=function(){r.apply(n)},r.apply(n)}}(),Easemob.im.EmMessage.txt=function(e){this.id=e,this.type="txt",this.brief="",this.body={}},Easemob.im.EmMessage.txt.prototype.get=function(e){return this.value?(this.value=this.emotion?this.value:easemobim.utils.decode(this.value),[e?"<div class='em-widget-left'>":"<div id='"+this.id+"' class='em-widget-right'>","<div class='em-widget-msg-wrapper'>","<i class='"+(e?"icon-corner-left":"icon-corner-right")+"'></i>",this.id?"<div id='"+this.id+"_failed' data-type='txt' class='em-widget-msg-status em-hide'><span>发送失败</span><i class='icon-circle'><i class='icon-exclamation'></i></i></div>":"",this.id?"<div id='"+this.id+"_loading' class='em-widget-msg-loading'>"+easemobim.LOADING+"</div>":"","<div class='em-widget-msg-container'>","<pre>"+Easemob.im.Utils.parseLink(this.emotion?this.value:Easemob.im.Utils.parseEmotions(this.value))+"</pre>","</div>","</div>","</div>"].join("")):""},Easemob.im.EmMessage.txt.prototype.set=function(e){this.value=e.value,this.emotion=e.emotion,this.value&&(this.brief=(e.brief||this.value).replace(/\n/gm,""),this.brief=this.brief.length>15?this.brief.slice(0,15)+"...":this.brief),this.body={id:this.id,to:e.to,msg:this.value,type:this.type,ext:e.ext||{},success:e.success,fail:e.fail}},Easemob.im.EmMessage.cmd=function(e){this.id=e,this.type="cmd",this.body={}},Easemob.im.EmMessage.cmd.prototype.set=function(e){this.value="",this.body={to:e.to,action:e.action,msg:this.value,type:this.type,ext:e.ext||{}}},Easemob.im.EmMessage.img=function(e){this.id=e,this.type="img",this.brief="图片",this.body={}},Easemob.im.EmMessage.img.prototype.get=function(e){return[e?"<div class='em-widget-left'>":"<div id='"+this.id+"' class='em-widget-right'>","<div class='em-widget-msg-wrapper'>","<i class='"+(e?"icon-corner-left":"icon-corner-right")+"'></i>",,this.id?"<div id='"+this.id+"_failed' class='em-widget-msg-status em-hide'><span>发送失败</span><i class='icon-circle'><i class='icon-exclamation'></i></i></div>":"",this.id?"<div id='"+this.id+"_loading' class='em-widget-msg-loading'>"+easemobim.LOADING+"</div>":"","<div class='em-widget-msg-container'>",null===this.value?"<i class='icon-broken-pic'></i>":"<a href='javascript:;'><img class='em-widget-imgview' src='"+this.value.url+"'/></a>",,"</div>","</div>","</div>"].join("")},Easemob.im.EmMessage.img.prototype.set=function(e){this.value=e.file,this.body={id:this.id,file:this.value,apiUrl:e.apiUrl,accessToken:e.accessToken,to:e.to,type:this.type,onFileUploadError:e.uploadError,onFileUploadComplete:e.uploadComplete,success:e.success,fail:e.fail,flashUpload:e.flashUpload}},Easemob.im.EmMessage.list=function(e){this.id=e,this.type="list",this.brief="",this.body={}},Easemob.im.EmMessage.list.prototype.get=function(e){return this.value?["<div class='em-widget-left'>","<div class='em-widget-msg-wrapper'>","<i class='"+(e?"icon-corner-left":"icon-corner-right")+"'></i>",,"<div class='em-widget-msg-container em-widget-msg-menu'>","<p>"+Easemob.im.Utils.parseLink(Easemob.im.Utils.parseEmotions(easemobim.utils.encode(this.value)))+"</p>",this.listDom,"</div>","<div id='"+this.id+"_failed' class='em-widget-msg-status em-hide'><span>发送失败</span><i class='icon-circle'><i class='icon-exclamation'></i></i></div>","</div>","</div>"].join(""):""},Easemob.im.EmMessage.list.prototype.set=function(e){this.value=e.value,this.value&&(this.brief=this.value.replace(/\n/gm,""),this.brief=this.brief.length>15?this.brief.slice(0,15)+"...":this.brief),this.listDom=e.list},Easemob.im.EmMessage.file=function(e){this.id=e,this.type="file",this.brief="文件",this.body={}},Easemob.im.EmMessage.file.prototype.get=function(e){var t,n=this.filename;t=this.value.filesize>0?easemobim.utils.filesizeFormat(this.value.filesize):"";var i=this.value.url;return[e?"<div class='em-widget-left'>":"<div id='"+this.id+"' class='em-widget-right'>","<div class='em-widget-msg-wrapper em-widget-msg-file'>","<i class='"+(e?"icon-corner-left":"icon-corner-right")+"'></i>",,this.id?"<div id='"+this.id+"_failed' class='em-widget-msg-status em-hide'><span>发送失败</span><i class='icon-circle'><i class='icon-exclamation'></i></i></div><div id='"+this.id+"_loading' class='em-widget-msg-loading'>"+easemobim.LOADING+"</div>":"","<div class='em-widget-msg-container'>",null===this.value?"<i class='icon-broken-pic'></i>":'<i class="icon-attachment container-icon-attachment"></i><span class="file-info"><p class="filename ">'+n+'</p><p class="filesize">'+t+"</p></span><a target='_blank' href='"+i+"' class='icon-download container-icon-download' title='"+n+"'></a>","</div>","</div>","</div>"].join("")},Easemob.im.EmMessage.file.prototype.set=function(e){this.value=e.file,this.filename=e.filename||this.value.filename||"文件",this.body={id:this.id,file:this.value,filename:this.filename,apiUrl:e.apiUrl,to:e.to,type:this.type,onFileUploadError:e.uploadError,onFileUploadComplete:e.uploadComplete,success:e.success,fail:e.fail,flashUpload:e.flashUpload}},easemobim.paste=function(e){var t,n=document.createElement("div"),i=easemobim.utils;i.addClass(n,"em-widget-dialog em-widget-paste-wrapper em-hide"),i.html(n,"		<div class='em-widget-paste-image'></div>		<div>			<button class='em-widget-cancel'>取消</button>			<button class='bg-color'>发送</button>		</div>	"),easemobim.imChat.appendChild(n);var o=n.getElementsByTagName("button"),r=o[0],s=o[1],a=n.getElementsByTagName("div")[0];return i.on(r,"click",function(){easemobim.paste.hide()}),i.on(s,"click",function(){e.sendImgMsg({data:t,url:n.getElementsByTagName("img")[0].getAttribute("src")}),easemobim.paste.hide()}),{show:function(e){var o=new Image;"string"==typeof e?o.src=e:o.src=window.URL.createObjectURL(e),t=e,a.appendChild(o),i.removeClass(n,"em-hide"),o=null},hide:function(){a.innerHTML="",i.addClass(n,"em-hide")},bind:function(){var e=this;return i.on(easemobim.textarea,"paste",function(t){var n=t||window.event;try{if(n.clipboardData&&n.clipboardData.types)n.clipboardData.items.length>0&&/^image\/\w+$/.test(n.clipboardData.items[0].type)&&e.show(n.clipboardData.items[0].getAsFile());else if(window.clipboardData){var i=window.clipboardData.getData("URL");e.show(i)}}catch(o){}}),this}}.bind()},function(){easemobim.leaveMessage=function(e,t){var n=this.leaveMessage,i=this.utils,o=easemobim.imChat;if(n.dom)return!1;n.domBg=document.createElement("div"),n.dom=document.createElement("div"),n.domBg.id="em-widgetOffline",i.addClass(n.domBg,"em-widget-offline-bg em-hide"),i.addClass(n.dom,"em-widget-offline"),i.html(n.dom,"			<h3>请填写以下内容以方便我们及时联系您</h3>			<input type='text' placeholder='姓名'/>			<input type='text' placeholder='电话'/>			<input type='text' placeholder='邮箱'/>			<textarea spellcheck='false' placeholder='请输入留言'></textarea>			<button class='em-widget-offline-cancel'>取消</button>			<button class='em-widget-offline-ok bg-color'>留言</button>			<div class='em-widget-success-prompt em-hide'><i class='icon-circle'><i class='icon-good'></i></i><p>留言发送成功</p></div>			"),n.domBg.appendChild(n.dom),o.appendChild(n.domBg);var r=n.dom.getElementsByTagName("textarea")[0],s=n.dom.getElementsByTagName("input")[0],a=n.dom.getElementsByTagName("input")[1],c=n.dom.getElementsByTagName("input")[2],d=n.dom.getElementsByTagName("button")[1],l=n.dom.getElementsByTagName("button")[0],u=n.dom.getElementsByTagName("div")[0];i.on(l,i.click,function(){i.addClass(n.domBg,"em-hide")}),i.on(d,i.click,function(){return g?(e.errorPrompt("留言提交中..."),!1):void(p&&m?!s.value||s.value.length>140?e.errorPrompt("姓名输入不正确"):!a.value||a.value.length>24?e.errorPrompt("电话输入不正确"):!c.value||c.value.length>127?e.errorPrompt("邮箱输入不正确"):!r.value||r.value.length>2e3?e.errorPrompt("留言内容不能为空，长度小于2000字"):(g=!0,setTimeout(function(){g=!1},1e4),easemobim.api("createTicket",{tenantId:t,"easemob-target-username":m,"easemob-appkey":f,"easemob-username":_,headers:{Authorization:"Easemob IM "+h},projectId:p,subject:"",content:r.value,status_id:"",priority_id:"",category_id:"",creator:{name:s.value,avatar:"",email:c.value,phone:a.value,qq:"",company:"",description:""},attachments:null},function(t){g=!1,t&&t.data&&t.data.id?(i.removeClass(u,"em-hide"),setTimeout(function(){i.addClass(u,"em-hide")},1500),s.value="",a.value="",c.value="",r.value=""):e.errorPrompt("留言失败，请稍后重试")})):e.errorPrompt("留言失败，token无效"))});var p=null,m=null,h=null,f=null,g=!1,_=null;return{auth:function(e,n){h=e,m=n.toUser,_=n.user.username,f=n.appKey.replace("#","%23"),p||easemobim.api("getProject",{tenantId:t,"easemob-target-username":m,"easemob-appkey":f,"easemob-username":_,headers:{Authorization:"Easemob IM "+h}},function(e){e.data&&e.data.entities&&e.data.entities.length>0&&(p=e.data.entities[0].id)})},show:function(e){e&&i.addClass(l,"em-hide"),i.removeClass(n.domBg,"em-hide")}}}}(),easemobim.satisfaction=function(e){function t(){for(var e=0,t=d.length;t>0;t--)s.hasClass(d[t-1],"sel")&&(e+=1);return e}function n(){for(var e=d.length;e>0;e--)s.removeClass(d[e-1],"sel")}var i,o,r=document.querySelector(".em-widget-satisfaction-dialog"),s=easemobim.utils,a=document.querySelector(".em-widget-satisfaction"),c=r.getElementsByTagName("ul")[0],d=c.getElementsByTagName("li"),l=r.getElementsByTagName("textarea")[0],u=r.getElementsByTagName("button"),p=u[0],m=u[1],h=r.getElementsByTagName("div")[1];s.on(a,s.click,function(){i=null,o=null,s.removeClass(r,"hide"),clearInterval(e.focusText)}),s.live("button.js_satisfybtn","click",function(){i=this.getAttribute("data-servicesessionid"),o=this.getAttribute("data-inviteid"),s.removeClass(r,"hide"),clearInterval(e.focusText)}),s.on(p,"click",function(){s.addClass(r,"hide")}),s.on(m,"click",function(){var a=t();return 0===a?(e.errorPrompt("请先选择星级"),!1):(e.sendSatisfaction(a,l.value,i,o),l.blur(),s.removeClass(h,"hide"),void setTimeout(function(){l.value="",n(),s.addClass(h,"hide"),s.addClass(r,"hide")},1500))}),s.on(c,"click",function(e){var t=e||window.event,n=t.target||t.srcElement,i=n.getAttribute("idx");if(!i)return!1;for(var o=0,r=d.length;r>o;o++)console.log(o),+i>o?s.addClass(d[o],"sel"):s.removeClass(d[o],"sel")})},easemobim.imgView=function(e){var t=document.querySelector("div.img-view"),n=t.querySelector("img");return e.on(t,"click",function(){e.addClass(t,"hide")},!1),{show:function(i){n.setAttribute("src",i),e.removeClass(t,"hide")}}}(easemobim.utils),easemobim.uploadShim=function(e,t){
var n=this,i=easemobim.utils;n.flashUpload=function(e,t){n.swfupload.setUploadURL(e),n.swfupload.startUpload(),n.swfupload.uploadOptions=t},n.uploadShim=function(n){if(Easemob.im.Utils.isCanUploadFile){var o=(document.title,i.$Dom(n));if(!("undefined"==typeof SWFUpload||o.length<1))return new SWFUpload({file_post_name:"file",flash_url:location.protocol+e.staticPath+"/js/swfupload/swfupload.swf",button_placeholder_id:n,button_width:120,button_height:30,button_cursor:SWFUpload.CURSOR.HAND,button_window_mode:SWFUpload.WINDOW_MODE.TRANSPARENT,file_size_limit:10485760,file_upload_limit:0,file_queued_error_handler:function(){},file_dialog_start_handler:function(){},file_dialog_complete_handler:function(){},file_queued_handler:function(e){this.getStats().files_queued>1&&this.cancelUpload(),10485760<e.size?(t.errorPrompt("请上传大小不超过10M的文件"),this.cancelUpload()):easemobim.PICTYPE[e.type.slice(1).toLowerCase()]?t.sendImgMsg({name:e.name,data:e}):easemobim.FILETYPE[e.type.slice(1).toLowerCase()]?t.sendFileMsg({name:e.name,data:e}):(t.errorPrompt("不支持此类型"+e.type),this.cancelUpload())},upload_error_handler:function(n,i,o){if(i!=SWFUpload.UPLOAD_ERROR.FILE_CANCELLED&&i!=SWFUpload.UPLOAD_ERROR.UPLOAD_LIMIT_EXCEEDED&&i!=SWFUpload.UPLOAD_ERROR.FILE_VALIDATION_FAILED){var o=new Easemob.im.EmMessage("img");o.set({file:null}),t.appendMsg(e.user.username,e.toUser,o),t.appendDate((new Date).getTime(),e.toUser)}},upload_success_handler:function(n,i){if(!n||!i){var o=new Easemob.im.EmMessage("img");return o.set({file:null}),t.appendMsg(e.user.username,e.toUser,o),void t.appendDate((new Date).getTime(),e.toUser)}try{var r=Easemob.im.Utils.parseUploadResponse(i);r=JSON.parse(r),n&&!n.url&&r.entities&&r.entities.length>0&&(n.url=r.uri+"/"+r.entities[0].uuid);var o=new Easemob.im.EmMessage("img");o.set({file:n}),t.appendDate((new Date).getTime(),e.toUser),t.appendMsg(e.user.username,e.toUser,o),t.scrollBottom(1e3),this.uploadOptions.onFileUploadComplete(r)}catch(s){t.errorPrompt("上传图片发生错误")}}})}},!Easemob.im.Utils.isCanUploadFileAsync&&Easemob.im.Utils.isCanUploadFile&&(n.swfupload=n.uploadShim("em-widget-file-input"))},function(){var e=/MicroMessenger/.test(navigator.userAgent),t=easemobim.utils.query("wechatAuth"),n=easemobim.utils.query("appid"),i=easemobim.utils.query("code"),o=easemobim.utils.query("tenantId");e&&t&&o&&n&&(easemobim.wechat=function(e){var t=function(e){easemobim.emajax({url:"/v1/weixin/admin/appid",success:function(t){e(t)},error:function(t){e(null)}})},r=function(e,t){easemobim.emajax({url:"/v1/weixin/sns/userinfo/"+n+"/"+e,data:{tenantId:o},type:"GET",success:function(e){t(e)},error:function(e){var t=location.href.replace(/&code=[^&]+/,"");t.indexOf("appid")!==t.lastIndexOf("appid")&&(t=t.replace(/&appid=wx[^&]+/,"")),location.href=t}})};i?r(i,function(t){return t?void e(t):void e()}):t(function(t){if(!t)return void e();var i=encodeURIComponent(location.href),o="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+n+"&redirect_uri="+i+"&response_type=code&scope=snsapi_userinfo&state=STATE&component_appid="+t+"#wechat_redirect";location.href=o})})}(),function(){var e=function(){this.list={}};e.prototype.set=function(e,t){return"undefined"==typeof this.list[e]&&(this.list[e]=t),this},e.prototype.get=function(e){return this.list.hasOwnProperty(e)?this.list[e]:null},e.prototype.remove=function(e){"undefined"!=typeof this.list[e]&&delete this.list[e]},easemobim.site=e}(),function(){var e=function(e,t){this.fn=e,this.isStarted=!1,this.timerHandler=null,this.interval=t};e.prototype.start=function(){this.isStarted||(this.isStarted=!0,setTimeout(this.fn,0),this.timerHandler=setInterval(this.fn,this.interval))},e.prototype.stop=function(){this.isStarted&&(this.isStarted=!1,clearInterval(this.timerHandler))},e.prototype.isStarted=function(){return this.isStarted},easemobim.Polling=e}(),easemobim.channel=function(e){var t,n=2e4,i=6e4,o=6e4,r=3e4,s=1,a=this,c=easemobim.utils,d=easemobim.api,l=new easemobim.site,u=new easemobim.site,p=new easemobim.site,m={getConnection:function(){return new WebIM.connection({url:e.xmppServer,retry:!0,isMultiLoginSessions:e.resources,heartBeatWait:i})},reSend:function(e,t){if(t){var n=u.get(t);switch(e){case"txt":f(n,0)}}},send:function(e){var t=c.uuid();switch(e){case"txt":arguments[2]||v(t),m.sendText(arguments[1],arguments[2],arguments[3],t);break;case"transferToKf":v(t),m.transferToKf(arguments[1],arguments[2],t);break;case"img":m.sendImg(arguments[1],arguments[2],t);break;case"file":m.sendFile(arguments[1],arguments[2],t);break;case"satisfaction":v(t),m.sendSatisfaction(arguments[1],arguments[2],arguments[3],arguments[4],t)}},appendAck:function(e,t){e.body.ext.weichat.msg_id_for_ack=t},sendSatisfaction:function(t,n,i,o,r){var s=new Easemob.im.EmMessage("txt",r);s.set({value:"",to:e.toUser}),c.extend(s.body,{ext:{weichat:{ctrlType:"enquiry",ctrlArgs:{inviteId:o||"",serviceSessionId:i||"",detail:n,summary:t}}}}),m.appendAck(s,r),a.conn.send(s.body),u.set(r,s)},sendText:function(t,n,i,o){var r=new Easemob.im.EmMessage("txt",n?null:o);if(r.set({value:t||easemobim.utils.encode(easemobim.textarea.value),to:e.toUser,success:function(e){},fail:function(e){}}),i&&c.extend(r.body,i),c.addClass(easemobim.sendBtn,"disabled"),n)a.appendMsg(e.user.username,n,r,!0);else{if(a.setExt(r),m.appendAck(r,o),a.conn.send(r.body),u.set(o,r),easemobim.textarea.value="",r.body.ext&&"custom"===r.body.ext.type)return;a.appendDate((new Date).getTime(),e.toUser),a.appendMsg(e.user.username,e.toUser,r)}},transferToKf:function(t,n,i){var o=new Easemob.im.EmMessage("cmd",i);o.set({to:e.toUser,action:"TransferToKf",ext:{weichat:{ctrlArgs:{id:t,serviceSessionId:n}}}}),m.appendAck(o,i),a.conn.send(o.body),u.set(i,o),a.handleEventStatus(null,null,!0)},sendImg:function(t,n,i){var o=new Easemob.im.EmMessage("img",n?null:i);o.set({apiUrl:location.protocol+"//"+e.restServer,file:t,accessToken:a.token,to:e.toUser,uploadError:function(e){setTimeout(function(){if(Easemob.im.Utils.isCanUploadFileAsync){var t=e.id,n=c.$Dom(t+"_loading"),i=document.getElementById(t).querySelector(".em-widget-msg-container");i.innerHTML='<i class="icon-broken-pic"></i>',c.addClass(n,"hide"),a.scrollBottom()}else easemobim.swfupload&&easemobim.swfupload.settings.upload_error_handler()},50)},uploadComplete:function(){a.handleEventStatus()},success:function(e){c.$Remove(c.$Dom(e+"_loading")),c.$Remove(c.$Dom(e+"_failed"))},fail:function(e){c.addClass(c.$Dom(e+"_loading"),"hide"),c.removeClass(c.$Dom(e+"_failed"),"em-hide")},flashUpload:easemobim.flashUpload}),n?a.appendMsg(e.user.username,t.to,o,!0):(a.setExt(o),a.conn.send(o.body),Easemob.im.Utils.isCanUploadFileAsync&&(a.appendDate((new Date).getTime(),e.toUser),a.appendMsg(e.user.username,e.toUser,o)))},sendFile:function(t,n,i){var o=new Easemob.im.EmMessage("file",n?null:i);o.set({apiUrl:location.protocol+"//"+e.restServer,file:t,to:e.toUser,uploadError:function(e){if(Easemob.im.Utils.isCanUploadFileAsync){var t=e.id,n=c.$Dom(t+"_loading"),i=document.getElementById(t).querySelector(".em-widget-msg-container");i.innerHTML='<i class="icon-broken-pic"></i>',c.addClass(n,"hide"),a.scrollBottom()}else easemobim.swfupload&&easemobim.swfupload.settings.upload_error_handler()},uploadComplete:function(){a.handleEventStatus()},success:function(e){c.$Remove(c.$Dom(e+"_loading")),c.$Remove(c.$Dom(e+"_failed"))},fail:function(e){c.addClass(c.$Dom(e+"_loading"),"em-hide"),c.removeClass(c.$Dom(e+"_failed"),"em-hide")},flashUpload:easemobim.flashUpload}),n?a.appendMsg(e.user.username,t.to,o,!0):(a.setExt(o),a.conn.send(o.body),Easemob.im.Utils.isCanUploadFileAsync&&(a.appendDate((new Date).getTime(),e.toUser),a.appendMsg(e.user.username,e.toUser,o)))},handleReceive:function(t,n,i){if(!e.offDuty){if(t&&t.ext&&t.ext.weichat&&t.ext.weichat.ack_for_msg_id)return void g(t.ext.weichat.ack_for_msg_id);var o=a.getMsgid(t);if(!p.get(o)&&(o&&p.set(o,1),i||!t.from||t.from.toLowerCase()==e.toUser.toLowerCase()||t.noprompt)){var r=null;switch(t.ext&&t.ext.weichat&&t.ext.weichat.ctrlType&&"inviteEnquiry"==t.ext.weichat.ctrlType?n="satisfactionEvaluation":t.ext&&t.ext.msgtype&&t.ext.msgtype.choice?n="robotList":t.ext&&t.ext.weichat&&"TransferToKfHint"===t.ext.weichat.ctrlType&&(n="robotTransfer"),n){case"txt":case"face":r=new Easemob.im.EmMessage("txt"),r.set({value:i?t.data:a.getSafeTextValue(t)});break;case"img":if(r=new Easemob.im.EmMessage("img"),t.url)r.set({file:{url:t.url}});else try{r.set({file:{url:t.bodies[0].url}})}catch(s){}break;case"file":if(r=new Easemob.im.EmMessage("file"),t.url)r.set({file:{url:t.url,filename:t.filename,filesize:t.file_length}});else try{r.set({file:{url:t.bodies[0].url,filename:t.bodies[0].filename}})}catch(s){}break;case"satisfactionEvaluation":if(r=new Easemob.im.EmMessage("list"),r.set({value:"请对我的服务做出评价",list:['						<div class="em-widget-list-btns">							<button class="em-widget-list-btn bg-hover-color js_satisfybtn" data-inviteid="'+t.ext.weichat.ctrlArgs.inviteId+'"							 data-servicesessionid="'+t.ext.weichat.ctrlArgs.serviceSessionId+'">立即评价</button>						</div>']}),"undefined"==typeof i){var d=document.createElement("BUTTON");d.className="js_satisfybtn",d.style.display="none",d.setAttribute("data-inviteid",t.ext.weichat.ctrlArgs.inviteId),d.setAttribute("data-servicesessionid",t.ext.weichat.ctrlArgs.serviceSessionId),document.body.appendChild(d),c.trigger(d,"click"),easemobim.textarea.blur()}break;case"robotList":r=new Easemob.im.EmMessage("list");var l,u=t.ext.msgtype.choice.items||t.ext.msgtype.choice.list;if(u.length>0){l='<div class="em-widget-list-btns">';for(var m=0,h=u.length;h>m;m++)l+="TransferToKf"===u[m].id?'<button class="em-widget-list-btn-white bg-color border-color bg-hover-color-dark js_robotbtn" data-id="'+u[m].id+'">'+(u[m].name||u[m])+"</button>":'<button class="em-widget-list-btn bg-hover-color js_robotbtn" data-id="'+u[m].id+'">'+(u[m].name||u[m])+"</button>";l+="</div>"}r.set({value:t.ext.msgtype.choice.title,list:l});break;case"robotTransfer":r=new Easemob.im.EmMessage("list");var f=t.ext.weichat.ctrlArgs,_=t.data||t.bodies&&t.bodies[0]&&t.bodies[0].msg||t.ext.weichat.ctrlArgs.label,l=['<div class="em-widget-list-btns">','<button class="em-widget-list-btn-white bg-color border-color bg-hover-color-dark js_robotTransferBtn" ','data-sessionid="'+f.serviceSessionId+'" ','data-id="'+f.id+'">'+f.label+"</button>","</div>"].join("");r.set({value:_,list:l})}if(i){if(!r||!r.value)return;a.appendMsg(t.from,t.to,r,!0)}else{if(t.ext&&t.ext.weichat)if(t.ext.weichat.event)switch(t.ext.weichat.event.eventName){case"ServiceSessionTransferedEvent":a.handleEventStatus("transferd",t.ext.weichat.event.eventObj);break;case"ServiceSessionTransferedToAgentQueueEvent":a.handleEventStatus("transfering",t.ext.weichat.event.eventObj);break;case"ServiceSessionClosedEvent":a.session=null,a.sessionSent=!1,e.agentUserId=null,a.stopGettingAgentStatus(),a.setAgentProfile({tenantName:e.defaultAgentName,avatar:e.tenantAvatar}),a.clearAgentStatus(),a.handleEventStatus("close"),c.isTop||transfer.send(easemobim.EVENTS.ONSESSIONCLOSED,window.transfer.to);break;case"ServiceSessionOpenedEvent":a.agentCount<1&&(a.agentCount=1),a.handleEventStatus("linked",t.ext.weichat.event.eventObj);break;case"ServiceSessionCreatedEvent":a.handleEventStatus("create");break;default:a.handleEventStatus("reply",t.ext.weichat.agent)}else a.handleEventStatus("reply",t.ext.weichat.agent);if(!r||!r.value)return;if(t.noprompt||a.messagePrompt(r),a.appendDate((new Date).getTime(),t.from),a.resetSpan(),a.appendMsg(t.from,t.to,r),a.scrollBottom(50),e.hasReceiveCallback&&!c.isTop){easemobim.EVENTS.ONMESSAGE.data={from:t.from,to:t.to,message:r};try{transfer.send(easemobim.EVENTS.ONMESSAGE,window.transfer.to)}catch(s){}}}}}},listen:function(){a.conn.listen({onOpened:function(e){_(),a.reOpen&&clearTimeout(a.reOpen),a.token=e.accessToken,a.conn.setPresence(),a.handleReady(e)},onTextMessage:function(e){a.receiveMsg(e,"txt")},onEmotionMessage:function(e){a.receiveMsg(e,"face")},onPictureMessage:function(e){a.receiveMsg(e,"img")},onFileMessage:function(e){a.receiveMsg(e,"file")},onCmdMessage:function(e){a.receiveMsg(e,"cmd")},onOnline:function(){c.isMobile&&a.open()},onOffline:function(){c.isMobile&&a.conn.close(),console.log("onOffline-channel"),c.isSupportWebRTC&&easemobim.videoChat.onOffline()},onError:function(t){t.reconnect?a.open():2===t.type?a.reOpen||(a.reOpen=setTimeout(function(){a.open()},2e3)):"function"==typeof e.onerror&&e.onerror(t)}})},handleHistory:function(t){t.length>0&&c.each(t,function(t,n){var i,o=n.body,r=o.from===e.user.username;if(o&&o.bodies.length>0){if(i=o.bodies[0],o.from===e.user.username)switch(i.type){case"img":i.url=/^http/.test(i.url)?i.url:e.base+i.url,i.to=o.to,a.sendImgMsg(i,!0);break;case"file":i.url=/^http/.test(i.url)?i.url:e.base+i.url,i.to=o.to,i.filesize=i.file_length,a.sendFileMsg(i,!0);break;case"txt":a.sendTextMsg(i.msg,!0)}else if(o.ext&&o.ext.weichat&&o.ext.weichat.ctrlType&&"inviteEnquiry"==o.ext.weichat.ctrlType||o.ext&&o.ext.msgtype&&o.ext.msgtype.choice||o.ext&&o.ext.weichat&&"TransferToKfHint"===o.ext.weichat.ctrlType)a.receiveMsg(o,"",!0);else{var s=i.msg;"txt"===i.type&&(s=a.getSafeTextValue(o)),a.receiveMsg({msgId:n.msgId,data:s,filename:i.filename,file_length:i.file_length,url:/^http/.test(i.url)?i.url:e.base+i.url,from:o.from,to:o.to},i.type,!0)}"cmd"===i.type||"txt"===i.type&&!i.msg||p.get(n.msgId)||a.appendDate(n.timestamp||o.timestamp,r?o.to:o.from,!0)}})}},h=function(){e.offDuty||setInterval(function(){d("receiveMsgChannel",{orgName:e.orgName,appName:e.appName,easemobId:e.toUser,tenantId:e.tenantId,visitorEasemobId:e.user.username},function(e){if(e&&"OK"===e.data.status)for(var t=0,n=e.data.entities.length;n>t;t++)try{m.handleReceive(e.data.entities[t],e.data.entities[t].bodies[0].type,!1)}catch(i){}})},o)},f=function(t,n){var n=0===n?0:n||s,i=t.id;d("sendMsgChannel",{from:e.user.username,to:e.toUser,tenantId:e.tenantId,bodies:[{type:"txt",msg:t.value}],ext:t.body?t.body.ext:null,orgName:e.orgName,appName:e.appName,originType:"webim"},function(){g(i)},function(){n>0?f(t,--n):(c.addClass(c.$Dom(i+"_loading"),"em-hide"),c.removeClass(c.$Dom(i+"_failed"),"em-hide"))})},g=function(e){clearTimeout(l.get(e)),l.remove(e),c.$Remove(c.$Dom(e+"_loading")),c.$Remove(c.$Dom(e+"_failed")),u.get(e)&&a.handleEventStatus(null,null,"转人工"===u.get(e).value||"转人工客服"===u.get(e).value),u.remove(e)},_=function(){clearTimeout(t)},v=function(e){l.set(e,setTimeout(function(){f(u.get(e))},r))};return t=setTimeout(function(){a.handleReady()},n),h(),m},easemobim.ui={},easemobim.ui.videoConfirmDialog=easemobim.utils.isSupportWebRTC&&function(){function e(){i.classList.remove("hide")}function t(){i.classList.add("hide")}function n(t,n){r=t,s=n,e()}var i=document.querySelector("div.em-dialog-video-confirm"),o=i.querySelector("div.button-panel"),r=(i.querySelector(".btn-confirm"),i.querySelector(".btn-cancel"),null),s=null;return o.addEventListener("click",function(e){var n=e.target.className;if(~n.indexOf("btn-cancel"))"function"==typeof s&&s();else{if(!~n.indexOf("btn-confirm"))return;"function"==typeof r&&r()}r=null,s=null,t()},!1),{show:e,hide:t,init:n}}(),easemobim.videoChat=function(e){function t(){console.log("send video invite"),m("txt","邀请客服进行实时视频",!1,{ext:{type:"rtcmedia/video",msgtype:{liveStreamInvitation:{msg:"邀请客服进行实时视频",orgName:u.orgName,appName:u.appName,userName:u.user.username,resource:"webim"}}}})}function n(n,b,E){m=b,u=E,r.style.display="",o.classList.remove("hide"),o.addEventListener("click",function(){e.init(t)},!1),r.addEventListener("click",function(e){var t=e.target.className;Object.keys(y).forEach(function(e){~t.indexOf(e)&&y[e]()})},!1),p=new WebIM.WebRTC.Call({connection:n,mediaStreamConstaints:{audio:!0,video:!0},listener:{onAcceptCall:function(e,t){console.log("onAcceptCall",e,t)},onGotRemoteStream:function(e){console.log("onGotRemoteStream",e),d.src=URL.createObjectURL(e),f=e,d.play()},onGotLocalStream:function(e){console.log("onGotLocalStream",e),l.src=URL.createObjectURL(e),h=e,l.play()},onRinging:function(e){console.log("onRinging",e),l.muted=!0,d.muted=!1,_.isConnected=!1,c.classList.add("hide"),a.classList.add("hide"),i.classList.add("has-video"),g.start("视频连接请求，等待你的确认"),s.classList.remove("hide")},onTermCall:function(){console.log("onTermCall"),v()},onError:function(e){console.log(e&&e.message?e.message:"An error occured when calling webrtc")}}})}var i=document.getElementById("em-kefu-webim-chat"),o=document.querySelector(".em-video-invite"),r=document.querySelector(".em-widget-video"),s=r.querySelector(".btn-accept-call"),a=r.querySelector(".toolbar-control"),c=r.querySelector(".sub-win"),d=r.querySelector("video.main"),l=r.querySelector("video.sub"),u=null,p=null,m=null,h=null,f=null,g={timer:null,counter:0,prompt:r.querySelector(".status p.prompt"),timeSpan:r.querySelector(".status p.time-escape"),start:function(e){function t(e){return new Date(1e3*e).toISOString().slice(-"00:00.000Z".length).slice(0,"00:00".length)}var n=this;n.counter=0,n.prompt.innerHTML=e,n.timeSpan.innerHTML="00:00",n.timer=setInterval(function(){n.timeSpan.innerHTML=t(++n.counter)},1e3)},stop:function(){var e=this;clearInterval(e.timer)}},_={isConnected:!1,timer:null,delay:3e3,closingPrompt:r.querySelector(".full-screen-prompt"),timeSpan:r.querySelector(".full-screen-prompt p.time-escape"),show:function(){var e=this;e.isConnected?e.timeSpan.innerHTML=g.timeSpan.innerHTML:e.timeSpan.innerHTML="00:00",e.closingPrompt.classList.remove("hide"),setTimeout(function(){i.classList.remove("has-video"),e.closingPrompt.classList.add("hide")},e.delay)}},v=function(){g.stop(),_.show(),h&&h.getTracks().forEach(function(e){e.stop()}),f&&f.getTracks().forEach(function(e){e.stop()}),d.src="",l.src=""},y={"btn-end-call":function(){try{p.endCall()}catch(e){console.error("end call:",e)}finally{v()}},"btn-accept-call":function(){_.isConnected=!0,s.classList.add("hide"),a.classList.remove("hide"),c.classList.remove("hide"),g.stop(),g.start("视频通话中"),p.acceptCall()},"btn-toggle":function(){h&&h.getVideoTracks().forEach(function(e){e.enabled=!e.enabled})},"btn-change":function(){var e;e=l.src,l.src=d.src,d.src=e,l.play(),d.play(),l.muted=!l.muted,d.muted=!d.muted},"btn-minimize":function(){r.classList.add("minimized")},"btn-maximize":function(){r.classList.remove("minimized")}};return{init:n,onOffline:function(){console.log("onOffline"),v()}}}(easemobim.ui.videoConfirmDialog),function(){easemobim.chat=function(e){var t=easemobim.utils,n=easemobim._const,i={agentStatusText:document.querySelector(".em-header-status-text"),agentStatusSymbol:t.$Dom("em-widgetAgentStatus"),nickname:document.querySelector(".em-widgetHeader-nickname"),imgInput:document.querySelector(".upload-img-container"),fileInput:document.querySelector(".upload-file-container")};return easemobim.doms=i,easemobim.im=t.$Dom("EasemobKefuWebim"),easemobim.imBtn=t.$Dom("em-widgetPopBar"),easemobim.imChat=t.$Dom("em-kefu-webim-chat"),easemobim.imChatBody=t.$Dom("em-widgetBody"),easemobim.send=t.$Dom("em-widgetSend"),easemobim.textarea=easemobim.send.querySelector(".em-widget-textarea"),easemobim.sendBtn=t.$Dom("em-widgetSendBtn"),easemobim.faceBtn=easemobim.send.querySelector(".em-bar-face"),easemobim.sendImgBtn=t.$Dom("em-widgetImg"),easemobim.sendFileBtn=t.$Dom("em-widgetFile"),easemobim.noteBtn=t.$Dom("em-widgetNote"),easemobim.dragHeader=t.$Dom("em-widgetDrag"),easemobim.dragBar=easemobim.dragHeader.querySelector(".drag-bar"),easemobim.chatFaceWrapper=t.$Dom("EasemobKefuWebimFaceWrapper"),easemobim.avatar=document.querySelector(".em-widgetHeader-portrait"),easemobim.swfupload=null,e.agentUserId=null,{init:function(){this.channel=easemobim.channel.call(this,e),this.conn=this.channel.getConnection(),this.scbT=0,this.msgCount=0,this.msgTimeSpan={},this.opened=!0,this.setTheme(),this.soundReminder(),this.fillFace(),this.bindEvents()},handleReady:function(n){var i=this;if(easemobim.textarea.value&&t.removeClass(easemobim.sendBtn,"disabled"),easemobim.sendBtn.innerHTML="发送",!i.readyHandled)if(i.readyHandled=!0,(e.minimum===!1||e.eventCollector===!0)&&transfer.send(easemobim.EVENTS.SHOW,window.transfer.to),n&&e.user&&(e.user.token=e.user.token||n.accessToken),easemobim.leaveMessage&&easemobim.leaveMessage.auth(i.token,e),this.cachedCommandMessage&&(i.sendTextMsg("",!1,this.cachedCommandMessage),this.cachedCommandMessage=null),t.isTop){var o=e.visitor;if(!o){o=t.getStore(e.tenantId+e.emgroup+"visitor");try{e.visitor=Easemob.im.Utils.parseJSON(o)}catch(r){}t.clearStore(e.tenantId+e.emgroup+"visitor")}var s=t.getStore(e.tenantId+e.emgroup+"ext");try{s&&i.sendTextMsg("",!1,{ext:Easemob.im.Utils.parseJSON(s)})}catch(r){}t.clearStore(e.tenantId+e.emgroup+"ext")}else transfer.send(easemobim.EVENTS.ONREADY,window.transfer.to)},setExt:function(t){t.body.ext=t.body.ext||{},t.body.ext.weichat=t.body.ext.weichat||{},e.emgroup&&(t.body.ext.weichat.queueName=decodeURIComponent(e.emgroup)),e.visitor&&(t.body.ext.weichat.visitor=e.visitor),e.agentName&&(t.body.ext.weichat.agentUsername=e.agentName),e.language&&(t.body.ext.weichat.language=e.language),e.grUserId&&(t.body.ext.weichat.visitor=t.body.ext.weichat.visitor||{},t.body.ext.weichat.visitor.gr_user_id=e.grUserId)},ready:function(){this.setNotice(),this.channel.listen(),this.open(),this.handleGroup(),this.getSession(),this.setLogo(),t.isMobile&&this.initAutoGrow(),this.chatWrapper.getAttribute("data-getted")||e.newuser||this.getHistory()},initAutoGrow:function(){var e=this;e.autoGrowOptions||(e.autoGrowOptions={},e.autoGrowOptions.callback=function(){var t=easemobim.send.getBoundingClientRect().height;"up"===e.direction?easemobim.chatFaceWrapper.style.top=43+t+"px":(easemobim.imChatBody.style.bottom=t+"px",easemobim.chatFaceWrapper.style.bottom=t+"px")},e.autoGrowOptions.dom=easemobim.textarea,setTimeout(function(){easemobim.autogrow(e.autoGrowOptions)},1e3))},handleChatWrapperByHistory:function(e,t){if(e.length===easemobim.LISTSPAN){var n=Number(e[easemobim.LISTSPAN-1].chatGroupSeqId)-1;n>0?(t.setAttribute("data-start",n),t.setAttribute("data-history",0)):t.setAttribute("data-history",1)}else t.setAttribute("data-history",1)},getHistory:function(t){if(!e.offDuty){var n=this,i=n.chatWrapper,o=i.getAttribute("data-groupid");o?Number(i.getAttribute("data-history"))||easemobim.api("getHistory",{fromSeqId:i.getAttribute("data-start")||0,size:easemobim.LISTSPAN,chatGroupId:o,tenantId:e.tenantId},function(e){n.handleChatWrapperByHistory(e.data,i),e.data&&e.data.length>0&&(n.channel.handleHistory(e.data),t||n.scrollBottom())}):Number(i.getAttribute("data-history"))||easemobim.api("getGroupNew",{id:e.user.username,orgName:e.orgName,appName:e.appName,imServiceNumber:e.toUser,tenantId:e.tenantId},function(o){o&&o.data&&(i.setAttribute("data-groupid",o.data),easemobim.api("getHistory",{fromSeqId:i.getAttribute("data-start")||0,size:easemobim.LISTSPAN,chatGroupId:o.data,tenantId:e.tenantId},function(e){n.handleChatWrapperByHistory(e.data,i),e&&e.data&&e.data.length>0&&(n.channel.handleHistory(e.data),t||n.scrollBottom())}))}),i.setAttribute("data-getted",1)}},getGreeting:function(){var t=this;t.greetingGetted||(t.greetingGetted=!0,easemobim.api("getSystemGreeting",{tenantId:e.tenantId},function(n){n&&n.data&&t.receiveMsg({data:n.data,ext:{weichat:{html_safe_body:{msg:n.data}}},type:"txt",noprompt:!0},"txt"),easemobim.api("getRobertGreeting",{tenantId:e.tenantId,originType:"webim"},function(e){var n=e&&e.data;if(n)switch(n.greetingTextType){case 0:t.receiveMsg({data:n.greetingText,ext:{weichat:{html_safe_body:{msg:n.greetingText}}},type:"txt",noprompt:!0},"txt");break;case 1:try{var i=Easemob.im.Utils.parseJSON(n.greetingText.replace(/&quot;/g,'"'));"{}"===n.greetingText?t.receiveMsg({data:"该菜单不存在",type:"txt",noprompt:!0},"txt"):t.receiveMsg({ext:i.ext,noprompt:!0})}catch(o){}}})}))},getNickNameOption:function(){e.offDuty||easemobim.api("getNickNameOption",{tenantId:e.tenantId},function(t){t&&t.data&&t.data.length?e.nickNameOption="true"===t.data[0].optionValue:e.nickNameOption=null},function(){e.nickNameOption=null})},getSession:function(){if(!e.offDuty){var t=this;t.agent=t.agent||{},easemobim.api("getExSession",{id:e.user.username,orgName:e.orgName,appName:e.appName,imServiceNumber:e.toUser,tenantId:e.tenantId},function(n){n&&n.data?(t.onlineHumanAgentCount=n.data.onlineHumanAgentCount,t.onlineRobotAgentCount=n.data.onlineRobotAgentCount,t.agentCount=+t.onlineHumanAgentCount+ +t.onlineRobotAgentCount,e.agentUserId=n.data.serviceSession?n.data.serviceSession.agentUserId:null,0===t.agentCount&&(t.noteShow=!1),e.agentUserId&&t.startToGetAgentStatus()):t.getGreeting(),n.data.serviceSession?(t.session=n.data.serviceSession,n.data.serviceSession.visitorUser&&n.data.serviceSession.visitorUser.userId&&easemobim.api("sendVisitorInfo",{tenantId:e.tenantId,visitorId:n.data.serviceSession.visitorUser.userId,referer:document.referrer})):t.getGreeting(),t.nicknameGetted||(t.nicknameGetted=!0,t.getNickNameOption())})}},handleGroup:function(){this.chatWrapper=easemobim.imChatBody.querySelector(".em-widget-chat"),this.setAgentProfile({tenantName:e.defaultAgentName,avatar:e.tenantAvatar})},getMsgid:function(e){return e?e.ext&&e.ext.weichat?e.ext.weichat.msgId:e.msgId:null},startToGetAgentStatus:function(){var t=this;e.agentStatusTimer||(e.agentStatusTimer=setInterval(function(){t.updateAgentStatus()},5e3))},stopGettingAgentStatus:function(){e.agentStatusTimer=clearInterval(e.agentStatusTimer)},clearAgentStatus:function(){i.agentStatusSymbol.className="em-hide",i.agentStatusText.innerText=""},updateAgentStatus:function(){var t=this;return e.agentUserId&&e.nickNameOption?void easemobim.api("getAgentStatus",{tenantId:e.tenantId,orgName:e.orgName,appName:e.appName,agentUserId:e.agentUserId,userName:e.user.username,token:e.user.token,imServiceNumber:e.toUser},function(e){var t;e&&e.data&&e.data.state&&(t=e.data.state,i.agentStatusText.innerText=n.agentStatusText[t],i.agentStatusSymbol.className="em-widget-agent-status "+n.agentStatusClassName[t])}):void t.stopGettingAgentStatus()},setAgentProfile:function(n){var o=n&&n.avatar?t.getAvatarsFullPath(n.avatar,e.domain):e.tenantAvatar||e.defaultAvatar;if(n.tenantName&&(i.nickname.innerText=n.tenantName,easemobim.avatar.setAttribute("src",o)),e.nickNameOption&&"调度员"!==n.userNickname&&n.userNickname){i.nickname.innerText=n.userNickname,this.currentAvatar=o;easemobim.avatar.getAttribute("src");this.currentAvatar&&easemobim.avatar.setAttribute("src",this.currentAvatar)}},setTheme:function(){easemobim.api("getTheme",{tenantId:e.tenantId},function(e){var i=e.data&&e.data.length&&e.data[0].optionValue,o=n.themeMap[i];o&&t.addClass(document.body,o)})},setLogo:function(){e.logo&&(t.removeClass(document.querySelector(".em-widget-tenant-logo"),"hide"),document.querySelector(".em-widget-tenant-logo img").src=e.logo)},setNotice:function(){var n=this;n.hasSetSlogan||e.offDuty||easemobim.api("getSlogan",{tenantId:e.tenantId},function(e){n.hasSetSlogan=!0;var i=e.data&&e.data.length&&e.data[0].optionValue;i&&(document.querySelector(".em-widget-tip .content").innerHTML=Easemob.im.Utils.parseLink(i),t.addClass(easemobim.imChat,"has-tip"),t.on(document.querySelector(".em-widget-tip .tip-close"),t.click,function(){t.removeClass(easemobim.imChat,"has-tip")}))})},fillFace:function(){if(!t.html(easemobim.chatFaceWrapper.getElementsByTagName("ul")[0])){var e="",n=0,i=this;t.on(easemobim.faceBtn,t.click,function(){return easemobim.textarea.blur(),t.toggleClass(easemobim.chatFaceWrapper,"em-hide"),e?!1:(e='<li class="e-face">',t.each(Easemob.im.EMOTIONS.map,function(t,i){n+=1,e+=["<div class='em-bar-face-bg e-face'>","<img class='em-bar-face-img e-face em-emotion' ","src='"+Easemob.im.EMOTIONS.path+i+"' ","data-value="+t+" />","</div>"].join(""),n%7===0&&(e+='</li><li class="e-face">')}),n%7===0?e=e.slice(0,-'<li class="e-face">'.length):e+="</li>",void t.html(easemobim.chatFaceWrapper.getElementsByTagName("ul")[0],e))}),t.live("img.em-emotion",t.click,function(e){!t.isMobile&&easemobim.textarea.focus(),easemobim.textarea.value=easemobim.textarea.value+this.getAttribute("data-value"),t.isMobile&&(i.autoGrowOptions.update(),setTimeout(function(){easemobim.textarea.scrollTop=1e4},100)),i.readyHandled&&t.removeClass(easemobim.sendBtn,"disabled")},easemobim.chatFaceWrapper)}},errorPrompt:function(e,n){var i=this;i.ePrompt=i.ePrompt||document.querySelector(".em-widget-error-prompt"),i.ePromptContent=i.ePromptContent||i.ePrompt.querySelector("span"),i.ePromptContent.innerHTML=e,t.removeClass(i.ePrompt,"hide"),n||setTimeout(function(){t.addClass(i.ePrompt,"hide")},2e3)},getSafeTextValue:function(e){if(e&&e.ext&&e.ext.weichat&&e.ext.weichat.html_safe_body)return e.ext.weichat.html_safe_body.msg;try{return e.bodies[0].msg}catch(t){}return""},setOffline:function(n){if(n)switch(e.offDutyType){case"chat":break;case"none":var i=e.offDutyWord||"现在是下班时间。";try{i=decodeURIComponent(i)}catch(o){}var r=new Easemob.im.EmMessage("txt");r.set({value:i}),this.chatWrapper||this.handleGroup(),this.appendMsg(e.toUser,e.user.username,r),t.addClass(easemobim.send,"em-widget-send-disable");break;default:this.slogan&&t.addClass(this.slogan,"em-hide"),t.removeClass(easemobim.leaveMessage.dom,"em-hide"),t.addClass(easemobim.imChatBody,"em-hide"),t.addClass(easemobim.send,"em-hide"),easemobim.leaveMessage.show(n)}},close:function(){this.opened=!1,e.hide||(t.addClass(easemobim.imChat,"em-hide"),setTimeout(function(){t.removeClass(easemobim.imBtn,"em-hide")},60))},show:function(){var n=this;if(n.opened=!0,n.scrollBottom(50),t.addClass(easemobim.imBtn,"em-hide"),t.removeClass(easemobim.imChat,"em-hide"),!e.offDuty||"none"!==e.offDutyType)try{easemobim.textarea.focus()}catch(i){}!t.isTop&&transfer.send(easemobim.EVENTS.RECOVERY,window.transfer.to)},appendDate:function(e,n,i){var o=this.chatWrapper,r=document.createElement("div"),s="M月d日 hh:mm";o&&(r.innerHTML=new Date(e).format(s),t.addClass(r,"em-widget-date"),i?t.insertBefore(o,r,o.getElementsByTagName("div")[0]):n?((!this.msgTimeSpan[n]||e-this.msgTimeSpan[n]>6e4)&&o.appendChild(r),this.resetSpan(n)):o.appendChild(r))},resetSpan:function(e){this.msgTimeSpan[e]=(new Date).getTime()},open:function(){var n=this,i={user:e.user.username,appKey:e.appKey,apiUrl:location.protocol+"//"+e.restServer};e.user.token?i.accessToken=e.user.token:i.pwd=e.user.password,n.conn.open(i),t.isSupportWebRTC&&easemobim.api("graylist",{},function(t){t.data&&t.data.audioVideo&&~t.data.audioVideo.indexOf(+e.tenantId)&&easemobim.videoChat.init(n.conn,n.channel.send,e)})},soundReminder:function(){var n=this,i=0;window.HTMLAudioElement&&!t.isMobile&&e.soundReminder&&(n.reminder=document.querySelector(".em-widgetHeader-audio"),t.on(n.reminder,"mousedown touchstart",function(){return n.slience=!n.slience,t.toggleClass(n.reminder,"icon-slience",n.slience),t.toggleClass(n.reminder,"icon-bell",!n.slience),!1}),n.audio=document.createElement("audio"),n.audio.src=e.staticPath+"/mp3/msg.m4a",n.soundReminder=function(){(t.isMin()?!1:n.opened)||0!==i||n.slience||(i=setTimeout(function(){i=0},3e3),n.audio.play())})},bindEvents:function(){function o(){t.toggleClass(easemobim.sendBtn,"disabled",!r.readyHandled||!easemobim.textarea.value)}var r=this;if(t.on(document.querySelector(".em-widgetHeader-keyboard"),t.click,function(){var e=t.hasClass(this,"icon-keyboard-down");switch(r.direction=e?"down":"up",t.toggleClass(this,"icon-keyboard-up",e),t.toggleClass(this,"icon-keyboard-down",!e),r.direction){case"up":easemobim.send.style.bottom="auto",easemobim.send.style.zIndex="3",easemobim.send.style.top="43px",easemobim.imChatBody.style.bottom="0",easemobim.chatFaceWrapper.style.bottom="auto",easemobim.chatFaceWrapper.style.top=43+easemobim.send.getBoundingClientRect().height+"px";break;case"down":easemobim.send.style.bottom="0",easemobim.send.style.zIndex="3",easemobim.send.style.top="auto",easemobim.imChatBody.style.bottom=easemobim.send.getBoundingClientRect().height+"px",easemobim.chatFaceWrapper.style.bottom=easemobim.send.getBoundingClientRect().height+"px",
easemobim.chatFaceWrapper.style.top="auto",r.scrollBottom(50)}}),t.isTop||(t.on(document.querySelector(".em-widgetHeader-min"),"click",function(){transfer.send(easemobim.EVENTS.CLOSE,window.transfer.to)}),t.on(easemobim.imBtn,t.click,function(){transfer.send(easemobim.EVENTS.SHOW,window.transfer.to)}),t.on(document,"mouseover",function(){transfer.send(easemobim.EVENTS.RECOVERY,window.transfer.to)})),t.on(easemobim.imChatBody,t.click,function(){return easemobim.textarea.blur(),!1}),t.live("img.em-widget-imgview","click",function(){easemobim.imgView.show(this.getAttribute("src"))}),e.dragenable&&!t.isTop&&(easemobim.dragBar.style.cursor="move",t.on(easemobim.dragBar,"mousedown",function(e){var t=window.event||e;return easemobim.textarea.blur(),easemobim.EVENTS.DRAGREADY.data={x:t.clientX,y:t.clientY},transfer.send(easemobim.EVENTS.DRAGREADY,window.transfer.to),!1},!1)),function(){var e,n,i;t.live("div.em-widget-date","touchstart",function(e){var t=e||window.event,i=t.touches;t.touches&&t.touches.length>0&&(n=i[0].pageY)}),t.live("div.em-widget-date","touchmove",function(t){var o=t||window.event,s=o.touches;o.touches&&o.touches.length>0&&(i=s[0].pageY,i-n>8&&this.getBoundingClientRect().top>=0&&(clearTimeout(e),e=setTimeout(function(){r.getHistory(!0)},100)))});var o=function(t){var n=t||window.event,i=this;(n.wheelDelta/120>0||n.detail<0)&&(clearTimeout(e),e=setTimeout(function(){i.getBoundingClientRect().top>=0&&r.getHistory(!0)},400))};t.live("div.em-widget-chat","mousewheel",o),t.live("div.em-widget-chat","DOMMouseScroll",o)}(),t.live("div.em-widget-msg-status",t.click,function(){var e=this.getAttribute("id").slice(0,-"_failed".length);t.addClass(this,"em-hide"),t.removeClass(t.$Dom(e+"_loading"),"em-hide"),"txt"===this.getAttribute("data-type")?r.channel.reSend("txt",e):r.conn.send(e)}),t.live("button.js_robotTransferBtn",t.click,function(){return this.clicked?!1:(this.clicked=!0,r.transferToKf(this.getAttribute("data-id"),this.getAttribute("data-sessionid")),!1)}),t.live("button.js_robotbtn",t.click,function(){return r.sendTextMsg(t.html(this),null,{ext:{msgtype:{choice:{menuid:this.getAttribute("data-id")}}}}),!1}),t.on(easemobim.textarea,"keyup",o),t.on(easemobim.textarea,"change",o),t.on(easemobim.textarea,"input",o),t.isMobile){var s=function(){easemobim.textarea.style.overflowY="auto",r.scrollBottom(800),clearInterval(r.focusText),r.focusText=setInterval(function(){document.body.scrollTop=1e4},100)};t.on(easemobim.textarea,"input",function(){r.autoGrowOptions.update(),r.scrollBottom(800)}),t.on(easemobim.textarea,"focus",s),t.one(easemobim.textarea,"touchstart",s),t.on(easemobim.textarea,"blur",function(){clearInterval(r.focusText)})}t.on(i.fileInput,"change",function(){var e=i.fileInput,t=e.files&&e.files[0];e.value&&(t.size<n.UPLOAD_FILESIZE_LIMIT?r.sendFileMsg(Easemob.im.Utils.getFileUrl("em-widget-file-input")):r.errorPrompt("文件大小不能超过10MB"))}),t.on(i.imgInput,"change",function(){var e=i.imgInput,t=e.files&&e.files[0],o=t.name.split(".").pop().toLowerCase();return e.value?~n.UPLOAD_IMG_TYPE.indexOf(o)?void(t.size<n.UPLOAD_FILESIZE_LIMIT?r.sendImgMsg(Easemob.im.Utils.getFileUrl("em-widget-img-input")):r.errorPrompt("文件大小不能超过10MB")):void r.errorPrompt("不支持的图片格式"):void 0}),t.on(document,t.click,function(e){var n=window.event||e,i=n.srcElement||n.target;t.hasClass(i,"e-face")||t.addClass(easemobim.chatFaceWrapper,"em-hide")}),t.on(easemobim.sendFileBtn,"touchend",function(){easemobim.textarea.blur()}),t.on(easemobim.sendFileBtn,"click",function(){return r.readyHandled?Easemob.im.Utils.isCanUploadFileAsync?void i.fileInput.click():(r.errorPrompt("当前浏览器需要安装flash发送wenj"),!1):(r.errorPrompt("正在连接中..."),!1)}),t.on(easemobim.sendImgBtn,"touchend",function(){easemobim.textarea.blur()}),t.on(easemobim.sendImgBtn,"click",function(){return r.readyHandled?Easemob.im.Utils.isCanUploadFileAsync?void i.imgInput.click():(r.errorPrompt("当前浏览器需要安装flash发送图片"),!1):(r.errorPrompt("正在连接中..."),!1)}),t.on(easemobim.noteBtn,"click",function(){easemobim.leaveMessage.show()}),t.on(easemobim.textarea,"keydown",function(e){return 13===e.keyCode?t.isMobile||e.ctrlKey||e.shiftKey?!1:(t.addClass(easemobim.chatFaceWrapper,"em-hide"),t.hasClass(easemobim.sendBtn,"disabled")?!1:(r.sendTextMsg(),void setTimeout(function(){easemobim.textarea.value=""},0))):void 0}),t.on(easemobim.sendBtn,"click",function(){if(t.hasClass(this,"disabled"))return!1;var e=easemobim.textarea.value;return e.length>1500?(r.errorPrompt("输入字数过多"),!1):(t.addClass(easemobim.chatFaceWrapper,"em-hide"),r.sendTextMsg(),t.isMobile&&(easemobim.textarea.style.height="34px",easemobim.textarea.style.overflowY="hidden","up"===r.direction||(easemobim.imChatBody.style.bottom="77px"),easemobim.textarea.focus()),!1)})},scrollBottom:function(e){var t=easemobim.imChatBody;e?(clearTimeout(this.scbT),this.scbT=setTimeout(function(){t.scrollTop=t.scrollHeight-t.offsetHeight+1e4},e)):t.scrollTop=t.scrollHeight-t.offsetHeight+1e4},sendImgMsg:function(e,t){this.channel.send("img",e,t)},sendFileMsg:function(e,t){this.channel.send("file",e,t)},handleEventStatus:function(t,i,o){var r=o?this.onlineHumanAgentCount<1:this.agentCount<1;r&&(this.noteShow||(this.noteShow=!0,this.appendEventMsg(n.eventMessageText.NOTE))),"reply"===t&&i?(e.agentUserId&&this.startToGetAgentStatus(),this.setAgentProfile({userNickname:i.userNickname,avatar:i.avatar})):"create"===t?this.appendEventMsg(n.eventMessageText.CREATE):"close"===t?this.appendEventMsg(n.eventMessageText.CLOSED):"transferd"===t?this.appendEventMsg(n.eventMessageText.TRANSFER):"transfering"===t?this.appendEventMsg(n.eventMessageText.TRANSFERING):"linked"===t&&this.appendEventMsg(n.eventMessageText.LINKED),("transferd"===t||"linked"===t)&&this.handleAgentStatusChanged(i)},handleAgentStatusChanged:function(t){t&&(e.agentUserId=t.userId,this.updateAgentStatus(),this.startToGetAgentStatus(),this.setAgentProfile({userNickname:t.agentUserNiceName,avatar:t.avatar}))},appendEventMsg:function(n){if(!e.hideStatus){var i=document.createElement("div");i.innerText=n,i.className="em-widget-event",this.appendDate((new Date).getTime()),this.chatWrapper.appendChild(i),this.scrollBottom(t.isMobile?800:null)}},appendMsg:function(n,i,o,r){var s=this,a=n==e.user.username&&(n||e.user.username),c=s.chatWrapper,d=document.createElement("div");t.html(d,o.get(!a)),r?t.insertBefore(c,d,c.childNodes[0]):(c.appendChild(d),s.scrollBottom(t.isMobile?800:null));var l=t.$Class("img.em-widget-imgview",d),u=l.length>0?l[0]:null;u&&t.on(u,"load",function(){s.scrollBottom(),u=null}),d=null},sendTextMsg:function(e,t,n){this.channel.send("txt",e,t,n)},transferToKf:function(e,t){this.channel.send("transferToKf",e,t)},sendSatisfaction:function(e,t,n,i){this.channel.send("satisfaction",e,t,n,i)},messagePrompt:function(e){if(!t.isMobile){var n=this;n.opened&&!t.isTop&&transfer.send(easemobim.EVENTS.RECOVERY,window.transfer.to),(t.isMin()||!n.opened)&&(n.soundReminder(),t.isTop||transfer.send(easemobim.EVENTS.SLIDE,window.transfer.to),t.isTop||transfer.send({event:"notify",data:{avatar:this.currentAvatar,title:"新消息",brief:e.brief}},window.transfer.to))}},receiveMsg:function(t,n,i){e.offDuty||this.channel.handleReceive(t,n,i)}}},easemobim.api=function(e,t,n,i){easemobim.api[e]=easemobim.api[e]||{};var o=(new Date).getTime();easemobim.api[e][o]={success:n,error:i},easemobim.getData.send({api:e,data:t,timespan:o}).listen(function(e){if(easemobim.api[e.call]&&easemobim.api[e.call][e.timespan]){var t=easemobim.api[e.call][e.timespan];delete easemobim.api[e.call][e.timespan],0!==e.status?"function"==typeof t.error&&t.error(e):"function"==typeof t.success&&t.success(e)}},["api"])}}(),function(e,t,n){function i(t,n){transfer.send({event:"updateURL"},window.transfer.to),h&&easemobim.api("reportEvent",{type:"VISIT_URL",url:h,userId:{type:t,id:n}},function(t){var n=t.data;switch(n&&n.type){case"OK":break;case"INIT_CALL":d()&&(n.userName&&(m=n.orgName+"#"+n.appName+"_"+n.userName,l.stop(),l=new e(function(){i("VISITOR",m)},f)),c(),u(n))}})}function o(){m&&n("deleteEvent",{userId:m})}function r(e,n){u||(u=n),p||(p=e),t.isTop||(transfer.send({event:"updateURL"},window.transfer.to),p?l?l.start():p.user.username?a(p.user.username):s():console.log("not config yet."))}function s(){var n=p.guestId||t.uuid();transfer.send({event:"setItem",data:{key:"guestId",value:n}},window.transfer.to),l=new e(function(){i("GUEST",n)},f),l.start()}function a(t){n("getRelevanceList",{tenantId:p.tenantId},function(o){if(!o.data.length)throw"未创建关联";var r=p.appKey.split("#"),s=o.data[0],a=r[0]||s.orgName,c=r[1]||s.appName,d=s.imServiceNumber;p.restServer=p.restServer||s.restDomain;var u=p.restServer?p.restServer.match(/vip\d/):"";u=u&&u.length?"-"+u[0]:"",p.xmppServer=p.xmppServer||"im-api"+u+".easemob.com",m=a+"#"+c+"_"+t,l=new e(function(){i("VISITOR",m)},f),n("getCurrentServiceSession",{tenantId:p.tenantId,orgName:a,appName:c,imServiceNumber:d,id:t},function(e){e.data||l.start()})})}function c(){l&&l.stop(),o()}function d(){return l&&l.isStarted}var l,u,p,m,h,f=5e3;easemobim.eventCollector={startToReport:r,stopReporting:c,isStarted:d,updateURL:function(e){h=e}}}(easemobim.Polling,easemobim.utils,easemobim.api),function(e,t){"use strict";function n(){if(a.isTop){var t=a.query("tenantId");s={};try{s=JSON.parse(a.code.decode(a.getStore("emconfig"+t)))}catch(n){}s.tenantId=t,s.hide=!0,s.offDutyType=a.query("offDutyType"),s.grUserId=a.query("grUserId"),s.to=a.convertFalse(a.query("to")),s.xmppServer=a.convertFalse(a.query("xmppServer")),s.restServer=a.convertFalse(a.query("restServer")),s.agentName=a.convertFalse(a.query("agentName")),s.resources=a.convertFalse(a.query("resources")),s.hideStatus=a.convertFalse(a.query("hideStatus")),s.satisfaction=a.convertFalse(a.query("sat")),s.wechatAuth=a.convertFalse(a.query("wechatAuth")),s.hideKeyboard=a.convertFalse(a.query("hideKeyboard")),s.appKey=a.convertFalse(decodeURIComponent(a.query("appKey"))),s.domain=s.domain||"//"+location.host,s.offDutyWord=decodeURIComponent(a.query("offDutyWord")),s.language=a.query("language")||"zh_CN",s.ticket=""===a.query("ticket")?!0:a.convertFalse(a.query("ticket"));try{s.emgroup=decodeURIComponent(a.query("emgroup"))}catch(n){s.emgroup=a.query("emgroup")}a.query("user")?(!s.user||s.user.username&&s.user.username!==a.query("user"))&&(s.user={username:"",password:"",token:""}):s.user={username:a.get("root"+s.tenantId+s.emgroup),password:"",token:""},r=easemobim.chat(s),o(s,i)}else e.transfer=new easemobim.Transfer(null,"main").listen(function(t){switch(t.event){case easemobim.EVENTS.SHOW.event:d.isStarted()?(d.stopReporting(),l.init(s),l.open()):l.open();break;case easemobim.EVENTS.CLOSE.event:l.close();break;case easemobim.EVENTS.EXT.event:r.sendTextMsg("",!1,t.data.ext);break;case easemobim.EVENTS.TEXTMSG.event:r.sendTextMsg(t.data.data,!1,t.data.ext);break;case"updateURL":easemobim.eventCollector.updateURL(t.data);break;case"initConfig":r=easemobim.chat(t.data),e.transfer.to=t.data.parentId,o(t.data,i),s=t.data}},["easemob"])}function i(e){e.base=location.protocol+e.domain,easemobim.leaveMessage=easemobim.leaveMessage(r,e.tenantId),easemobim.paste=easemobim.paste(r),easemobim.satisfaction(r),e.eventCollector&&!d.isStarted()?(d.startToReport(e,function(t){l.init(e,t)}),a.one(easemobim.imBtn,"click",function(){l.init(e),l.open()})):l.init(e)}function o(t,n){var i=document.getElementById("EasemobKefuWebimIframe");if(i.src=t.domain+"/webim/transfer.html?v=43.12.013",a.on(i,"load",function(){easemobim.getData=new easemobim.Transfer("EasemobKefuWebimIframe","data"),n(t)}),a.toggleClass(a.$Dom("em-widgetPopBar"),"em-hide",a.isTop||!t.minimum||t.hide),a.toggleClass(a.$Dom("em-kefu-webim-chat"),"em-hide",!(a.isTop||!t.minimum)),document.querySelector(".em-widget-pop-bar").innerText=t.buttonText,a.isMobile&&a.addClass(document.body,"em-mobile"),a.toggleClass(a.$Dom("em-widgetNote"),"em-hide",!t.ticket),a.toggleClass(document.querySelector(".em-widgetHeader-min"),"hide",!t.minimum||a.isTop),a.toggleClass(document.querySelector(".em-widgetHeader-audio"),"hide",!e.HTMLAudioElement||a.isMobile||!t.soundReminder),a.toggleClass(document.querySelector(".em-widgetHeader-keyboard"),"hide",!a.isMobile||t.offDuty||t.hideKeyboard),a.toggleClass(document.querySelector(".em-widget-satisfaction"),"hide",!t.satisfaction),!Easemob.im.Utils.isCanUploadFileAsync&&Easemob.im.Utils.isCanUploadFile){var o=document.createElement("script");o.onload=o.onreadystatechange=function(){this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||easemobim.uploadShim(t,r)},o.src=location.protocol+t.staticPath+"/js/swfupload/swfupload.min.js",document.body.appendChild(o)}}var r,s,a=easemobim.utils,c=easemobim.api,d=easemobim.eventCollector;n();var l={init:function(t,n){var i=this;t.toUser=t.toUser||t.to,c("getDutyStatus",{tenantId:t.tenantId},function(e){t.offDuty=e.data?e.data&&"chat"!==t.offDutyType:!1,r.setOffline(t.offDuty)}),t.orgName=t.appKey.split("#")[0],t.appName=t.appKey.split("#")[1],c("getRelevanceList",{tenantId:t.tenantId},function(o){if(0===o.data.length)return void r.errorPrompt("未创建关联",!0);t.relevanceList=o.data,t.tenantAvatar=a.getAvatarsFullPath(o.data[0].tenantAvatar,t.domain),t.defaultAvatar=t.staticPath?t.staticPath+"/img/default_avatar.png":"static/img/default_avatar.png",t.defaultAgentName=o.data[0].tenantName,t.logo=t.logo||o.data[0].tenantLogo,t.toUser=t.toUser||o.data[0].imServiceNumber,t.orgName=t.orgName||o.data[0].orgName,t.appName=t.appName||o.data[0].appName,t.channelid=t.channelid||o.data[0].channelId,t.appKey=t.appKey||t.orgName+"#"+t.appName,t.restServer=t.restServer||o.data[0].restDomain;var s=t.restServer?t.restServer.match(/vip\d/):"";s=s&&s.length?"-"+s[0]:"",t.xmppServer=t.xmppServer||"im-api"+s+".easemob.com",r.init(),n?(t.toUser=n.agentImName,n.userName?(t.user={username:n.userName,password:n.userPassword},r.cachedCommandMessage={ext:{weichat:{agentUsername:n.agentUserName}}},r.ready(),r.show(),transfer.send(easemobim.EVENTS.SHOW,e.transfer.to),transfer.send({event:"setUser",data:{username:n.userName,group:t.user.emgroup}},e.transfer.to)):c("getPassword",{userId:t.user.username,tenantId:t.tenantId},function(i){i.data?(t.user.password=i.data,r.cachedCommandMessage={ext:{weichat:{agentUsername:n.agentUserName}}},r.ready(),r.show(),transfer.send(easemobim.EVENTS.SHOW,e.transfer.to)):console.log("用户不存在！")})):t.user.username&&(t.user.password||t.user.token)?r.ready():t.wechatAuth?easemobim.wechat(function(e){try{e=JSON.parse(e)}catch(n){e=null}if(e){t.visitor=t.visitor||{},t.visitor.userNickname=e.nickname;var o=t.tenantId+"_"+t.orgName+"_"+t.appName+"_"+t.toUser+"_"+e.openid;easemobim.emajax({url:"/v1/webimplugin/visitors/wechat/"+o+"?tenantId="+t.tenantId,data:{orgName:t.orgName,appName:t.appName,imServiceNumber:t.toUser},type:"POST",success:function(e){try{e=JSON.parse(e)}catch(n){e=null}e&&"OK"===e.status?(t.user.username=e.entity.userId,t.user.password=e.entity.userPassword,r.ready()):i.go(t)},error:function(e){i.go(t)}})}else i.go(t)}):t.user.username?c("getPassword",{userId:t.user.username,tenantId:t.tenantId},function(e){e.data?(t.user.password=e.data,r.ready()):i.go(t)}):i.go(t)})},go:function(t){c("createVisitor",{orgName:t.orgName,appName:t.appName,imServiceNumber:t.toUser,tenantId:t.tenantId},function(n){t.newuser=!0,t.user.username=n.data.userId,t.user.password=n.data.userPassword,a.isTop?a.set("root"+t.tenantId+t.emgroup,t.user.username):transfer.send({event:"setUser",data:{username:t.user.username,group:t.user.emgroup}},e.transfer.to),r.ready()})},open:function(){r.show()},close:function(){r.close()}}}(window,void 0);